<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bill Book — Personal Finance (Local Only)</title>

<style>
  :root{
    --ink:#111827; --ink-soft:#6b7280; --bg:#ffffff;
    --card:#ffffff; --border:#e5e7eb; --ring:#93c5fd;
    --thead:#f5f7fb; --row-alt:#fafcff; --row-hover:#f0f6ff;
    --brand:#2563eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--ink);
    background:var(--bg);
  }

  .wrap{max-width:1200px; margin:16px auto; padding:0 12px}
  h1{font-size:clamp(20px,5vw,26px); color:var(--ink); margin:8px 0; text-align:center}
  .sub{text-align:center; color:var(--ink-soft); font-size:12px; margin-bottom:12px}

  .bar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px}
  .btn{
    appearance:none; border:1px solid var(--border); background:#f8fafc; color:#0f172a;
    padding:10px 12px; border-radius:12px; cursor:pointer; font-size:14px; flex-shrink:0
  }
  .btn:hover{background:#eef2f7}
  .btn.brand{background:linear-gradient(180deg,#3b82f6,#2563eb); color:#fff; border-color:#1e40af}
  .btn.ok{background:#e8f6ee; border-color:#b7e2c7; color:#065f46}
  .btn.bad{background:#fdecec; border-color:#f8c7c7; color:#7f1d1d}
  .btn.warn{background:#fff3e1; border-color:#fbd19f; color:#92400e}
  .btn.ghost{background:transparent}
  .pill{padding:6px 10px; border-radius:999px; font-size:12px; color:#0f172a; background:#f3f4f6; border:1px solid var(--border)}
  .inp{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
    background:#fff; color:#111827; font-size:14px
  }
  .inp:focus{outline:none; border-color:var(--ring); box-shadow:0 0 0 3px rgba(147,197,253,.35)}
  .inp.num{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    text-align:right; font-variant-numeric:tabular-nums;
    width:auto; min-width:8ch; display:inline-block; white-space:nowrap;
  }
  .inp[disabled]{
    background:#f3f4f6; color:#9ca3af; cursor:not-allowed;
  }
  select.inp{padding-right:26px}

  .grid{display:grid; gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}

  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .section-title{font-weight:600; margin-bottom:6px}
  .note{color:var(--ink-soft); font-size:12px}

  .tbl{width:100%; border-collapse:separate; border-spacing:0; font-size:14px; table-layout:auto}
  .tbl th,.tbl td{padding:10px; color:#111827; vertical-align:top}
  .tbl th{
    position:sticky; top:0; z-index:2; background:var(--thead); font-size:12px; text-align:left;
    border-bottom:1px solid var(--border); white-space:nowrap;
  }
  .tbl td{border-bottom:1px solid var(--border)}
  .tbl tr:nth-child(even) td{background:var(--row-alt)}
  .tbl tbody tr:hover td{background:var(--row-hover)}
  .tbl td.right{white-space:nowrap}
  .right{text-align:right}
  .center{text-align:center}
  .scroll-x{overflow-x:auto; -webkit-overflow-scrolling:touch}

  /* Amount cell stack */
  .amt-wrap{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
  .paid-wrap{font-size:12px; color:var(--ink-soft); display:flex; align-items:center; gap:6px}

  .kpis{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px}
  .kpi{background:#f8fafc; border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center}
  .kpi .label{color:#6b7280; font-size:12px}
  .kpi .val{color:#0f172a; font-size:clamp(16px,5vw,20px); font-weight:700}

  /* Income calc drawer */
  .calc-drawer{background:#f9fafb; border:1px solid var(--border); border-radius:12px; padding:10px; margin:6px 0 0}
  .calc-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:8px}
  .calc-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}

  /* Mobile-specific cards for expenses */
  #expenseMobile{display:none}
  .exp-card{
    border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff;
    display:flex; flex-direction:column; gap:8px
  }
  .exp-head{display:flex; justify-content:space-between; gap:8px; align-items:center}
  .exp-name{flex:1}
  .exp-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .exp-row .label{color:var(--ink-soft); font-size:12px}
  .exp-actions{display:flex; gap:6px; flex-wrap:wrap}

  /* Error banner */
  #appError{display:none; background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca; padding:10px; border-radius:10px; margin:10px 0}

  @media (max-width:900px){
    .grid.cols-2{grid-template-columns:1fr}
    .bar{justify-content:center}
    .wrap{padding:0 10px}
  }
  @media (max-width:640px){
    #expenseTableWrap{display:none}
    #expenseMobile{display:block}
    .btn{font-size:15px; padding:12px 14px}
    .inp{font-size:16px; padding:12px 14px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Bill Book — Personal Finance (Local)</h1>
    <div class="sub">Data is saved in your browser’s <strong>localStorage</strong>. You can export/import JSON anytime.</div>

    <div id="appError"></div>

    <div class="bar">
      <button id="addMonthBtn" class="btn brand">+ Add Month</button>
      <button id="removeMonthBtn" class="btn ghost">Remove Last Month</button>
      <span class="pill" id="monthCount"></span>
      <span class="pill">Today: <span id="today"></span></span>
      <span class="pill">Active Month: <span id="activeMonthLbl"></span></span>
      <span class="pill">Autosave On</span>
      <div style="flex:1"></div>
      <button id="exportBtn" class="btn">Export JSON</button>
      <label class="btn ghost file">Import JSON <input id="importInput" type="file" accept="application/json" style="display:none"></label>
      <button id="resetBtn" class="btn bad">Reset (Clear Local)</button>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <div class="section-title">Months</div>
        <div class="bar">
          <select id="yearSelect" class="inp" style="max-width:120px"></select>
          <select id="monthSelect" class="inp" style="max-width:180px"></select>
          <button id="populateYearBtn" class="btn brand">Populate Year</button>
          <button id="addRestBtn" class="btn">Add Rest of Year</button>
        </div>
        <div id="monthsBar" class="bar" style="flex-wrap:wrap"></div>
        <div class="note">Tip: Click a month chip or use the Month dropdown to set the active month.</div>
      </div>
      <!-- (Settings removed) -->
    </div>

    <div class="grid cols-2" style="margin-top:14px">
      <div class="card">
        <div class="section-title">Income</div>
        <div class="bar">
          <button id="addIncome" class="btn ok">+ Add Income Source</button>
        </div>
        <div class="squeeze scroll-x">
          <table class="tbl" id="incomeTbl"></table>
        </div>
      </div>
      <div class="card">
        <div class="section-title">Quick Totals (Active Month)</div>
        <div class="kpis">
          <div class="kpi"><div class="label">Income</div><div class="val" id="kpiIncome">$0</div></div>
          <div class="kpi"><div class="label">Expenses</div><div class="val" id="kpiExpenses">$0</div></div>
          <div class="kpi"><div class="label">Net</div><div class="val" id="kpiNet">$0</div></div>
          <div class="kpi"><div class="label">Unpaid Bills</div><div class="val" id="kpiUnpaid">0</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="section-title">Expenses</div>
      <div class="bar">
        <button id="addExpense" class="btn ok">+ Add Expense</button>
        <button id="markAllPaid" class="btn warn">Mark All Paid (Active Month)</button>
        <label class="pill" style="display:flex;gap:8px;align-items:center;background:#f9fafb">
          <span>Filter</span>
          <input id="filterTxt" class="inp" placeholder="Type to filter by name…" style="width:220px">
        </label>
      </div>

      <!-- Desktop/tablet view -->
      <div id="expenseTableWrap" class="squeeze scroll-x">
        <table class="tbl" id="expenseTbl"></table>
      </div>

      <!-- Mobile view -->
      <div id="expenseMobile"></div>

      <div class="note" style="margin-top:8px">On phones you edit the active month only; switch months above to edit others.</div>
    </div>

  </div>

<script>
(function(){
  function showError(msg){
    var box = document.getElementById('appError');
    if(!box) return;
    box.style.display='block';
    box.textContent = '⚠️ App error: ' + msg;
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initSafe);
  }else{
    initSafe();
  }

  function initSafe(){
    try{ init(); }
    catch(e){ showError(e && e.message ? e.message : String(e)); }
  }

  function init(){
    // ---------- Utilities ----------
    function $(sel){ return document.querySelector(sel); }
    function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
    function fmtMonth(ym){
      if(!ym) return '';
      var parts = ym.split('-');
      var y = parseInt(parts[0],10), m = parseInt(parts[1],10);
      var d = new Date(y, m-1, 1);
      return d.toLocaleDateString(undefined,{month:'long', year:'numeric'});
    }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function ymOf(d){ return d.getFullYear() + '-' + pad2(d.getMonth()+1); }
    function ymFrom(y,m){ return y + '-' + pad2(m); }
    function moneyFmt(n){ return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(+n||0); }
    function uid(){ return Math.random().toString(36).slice(2,9); }
    var now = new Date();

    // ---------- State ----------
    var KEY = 'billbook.v1';
    function defaultState(){
      var cur = ymOf(now);
      var prev = ymOf(new Date(now.getFullYear(), now.getMonth()-1, 1));
      var next = ymOf(new Date(now.getFullYear(), now.getMonth()+1, 1));
      return {
        year: now.getFullYear(),
        months: [prev, cur, next],
        activeMonth: cur,
        incomes: [
          {id: uid(), name: "Cory's Wages", amounts: (function(){var o={}; o[prev]=0;o[cur]=0;o[next]=0; return o;})(), calc:{}},
          {id: uid(), name: "Amy's Wages",  amounts: (function(){var o={}; o[prev]=0;o[cur]=0;o[next]=0; return o;})(), calc:{}}
        ],
        expenses: [
          {id: uid(), name: 'Rent/Mortgage', dueDay: 1,  amounts:(function(){var o={}; o[prev]=0;o[cur]=0;o[next]=0; return o;})(), paid:{}},
          {id: uid(), name: 'Electric',      dueDay: 15, amounts:(function(){var o={}; o[prev]=0;o[cur]=0;o[next]=0; return o;})(), paid:{}},
          {id: uid(), name: 'Internet',      dueDay: 20, amounts:(function(){var o={}; o[prev]=0;o[cur]=0;o[next]=0; return o;})(), paid:{}}
        ]
      };
    }
    function load(){
      try{ var raw = localStorage.getItem(KEY); return raw? JSON.parse(raw) : null; }catch(e){ return null; }
    }
    var state = load() || defaultState();

    function save(render){
      if(render === void 0) render = true;
      try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){}
      if(render) renderAll();
    }
    function reset(){ localStorage.removeItem(KEY); state = defaultState(); renderAll(); }

    // ---------- DOM refs ----------
    var addMonthBtn = $('#addMonthBtn');
    var removeMonthBtn = $('#removeMonthBtn');
    var monthCount = $('#monthCount');
    var monthsBar = $('#monthsBar');
    var activeMonthLbl = $('#activeMonthLbl');
    var todayLbl = $('#today');
    var addIncomeBtn = $('#addIncome');
    var addExpenseBtn = $('#addExpense');
    var markAllPaidBtn = $('#markAllPaid');
    var filterTxt = $('#filterTxt');
    var incomeTbl = $('#incomeTbl');
    var expenseTbl = $('#expenseTbl');
    var expenseMobile = $('#expenseMobile');
    var exportBtn = $('#exportBtn');
    var importInput = $('#importInput');
    var resetBtn = $('#resetBtn');
    var yearSelect = $('#yearSelect');
    var monthSelect = $('#monthSelect');
    var populateYearBtn = $('#populateYearBtn');
    var addRestBtn = $('#addRestBtn');

    if(todayLbl) todayLbl.textContent = new Date().toLocaleDateString();

    // ---------- Helpers ----------
    function ensureActiveMonth(){
      if(!state.activeMonth){
        var y = state.year || now.getFullYear();
        var guess = ymFrom(y, (y===now.getFullYear()? now.getMonth()+1 : 1));
        state.activeMonth = state.months.indexOf(guess) >= 0 ? guess : (state.months[0] || guess);
      }
    }
    function copyExpenseFromActive(ex, mode){
      var src = state.activeMonth; if(!src) return;
      var srcVal = +ex.amounts[src]||0;
      if(mode==='next'){
        var idx = state.months.indexOf(src);
        if(idx>-1 && idx+1<state.months.length) ex.amounts[state.months[idx+1]] = srcVal;
      }else if(mode==='rest'){
        var seen=false;
        state.months.forEach(function(m){
          if(m===src){ seen=true; ex.amounts[m]=srcVal; return; }
          if(seen){ ex.amounts[m]=srcVal; }
        });
      }else if(mode==='all'){
        state.months.forEach(function(m){ ex.amounts[m]=srcVal; });
      }
    }

    // ---------- Year/Month controls ----------
    function renderYearMonthControls(){
      if(!yearSelect || !monthSelect || !populateYearBtn || !addRestBtn) return;

      var yNow = now.getFullYear();
      var years = [yNow-1, yNow, yNow+1, yNow+2];
      yearSelect.innerHTML = years.map(function(y){return '<option value="'+y+'">'+y+'</option>';}).join('');
      if(!state.year) state.year = yNow;
      yearSelect.value = state.year;

      ensureActiveMonth();
      monthSelect.innerHTML = state.months.map(function(m){return '<option value="'+m+'">'+fmtMonth(m)+'</option>';}).join('');
      if(state.activeMonth) monthSelect.value = state.activeMonth;

      yearSelect.onchange = function(){ state.year = +yearSelect.value; save(false); };
      monthSelect.onchange = function(){ state.activeMonth = monthSelect.value; save(true); };

      populateYearBtn.onclick = function(){
        var y = +yearSelect.value;
        state.year = y;
        state.months = [];
        for(var m=1;m<=12;m++) state.months.push(ymFrom(y,m));
        state.incomes.forEach(function(i){
          if(!i.amounts) i.amounts = {};
          state.months.forEach(function(mm){ if(i.amounts[mm]==null) i.amounts[mm]=0; });
        });
        state.expenses.forEach(function(x){
          if(!x.amounts) x.amounts = {};
          if(!x.paid) x.paid = {};
          state.months.forEach(function(mm){
            if(x.amounts[mm]==null) x.amounts[mm]=0;
            if(x.paid[mm]==null) x.paid[mm]=false;
          });
        });
        state.activeMonth = ymFrom(y,1);
        save(true);
      };

      addRestBtn.onclick = function(){
        var y = +yearSelect.value || state.year || now.getFullYear();
        ensureActiveMonth();
        var startM = state.activeMonth.indexOf(String(y))===0 ? +state.activeMonth.split('-')[1] : (y===now.getFullYear()? now.getMonth()+1 : 1);
        for(var m=startM; m<=12; m++){
          var key = ymFrom(y,m);
          if(state.months.indexOf(key)===-1) state.months.push(key);
        }
        state.months.sort();
        state.incomes.forEach(function(i){
          state.months.forEach(function(mm){ if(i.amounts[mm]==null) i.amounts[mm]=0; });
        });
        state.expenses.forEach(function(x){
          if(!x.amounts) x.amounts = {};
          if(!x.paid) x.paid = {};
          state.months.forEach(function(mm){
            if(x.amounts[mm]==null) x.amounts[mm]=0;
            if(x.paid[mm]==null) x.paid[mm]=false;
          });
        });
        save(true);
      };
    }

    // ---------- Month mgmt ----------
    if(addMonthBtn){
      addMonthBtn.addEventListener('click', function(){
        var d = prompt('Add month (YYYY-MM), e.g., 2025-10'); if(!d) return;
        if(!/^\d{4}-\d{2}$/.test(d)) return alert('Format must be YYYY-MM');
        if(state.months.indexOf(d)>=0) return alert('Month already exists.');
        state.months.push(d);
        state.incomes.forEach(function(i){ if(!i.amounts) i.amounts={}; if(i.amounts[d]==null) i.amounts[d]=0; });
        state.expenses.forEach(function(x){
          if(!x.amounts) x.amounts = {};
          if(!x.paid) x.paid = {};
          if(x.amounts[d]==null) x.amounts[d]=0;
          if(x.paid[d]==null) x.paid[d]=false;
        });
        save(true);
      });
    }
    if(removeMonthBtn){
      removeMonthBtn.addEventListener('click', function(){
        if(!state.months.length) return;
        var last = state.months[state.months.length-1];
        if(!confirm('Remove month '+fmtMonth(last)+'?')) return;
        state.months.pop();
        if(state.activeMonth===last) state.activeMonth = state.months[state.months.length-1]||'';
        save(true);
      });
    }
    function setActiveMonth(m){ state.activeMonth=m; save(true); }

    // ---------- Parsers ----------
    function numberFrom(s){
      if (s == null) return 0;
      var n = parseFloat(String(s).replace(/,/g,'')); 
      return isFinite(n) ? n : 0;
    }

    // ---------- Income tax estimate (rough 2024) ----------
    function estimateAnnualNet(grossAnnual, filing, pretaxAnnual, stateRate){
      grossAnnual = +grossAnnual||0;
      pretaxAnnual = +pretaxAnnual||0;
      filing = filing || 'single';
      stateRate = +stateRate||0;

      var taxableWages = Math.max(0, grossAnnual - pretaxAnnual);
      var STD = { single:14600, mfj:29200, hoh:21900 };
      var stdDed = STD[filing] != null ? STD[filing] : STD.single;

      var BRACKETS = {
        single: [[0,11000,0.10],[11000,44725,0.12],[44725,95375,0.22],[95375,182100,0.24],[182100,231250,0.32],[231250,578125,0.35],[578125,Infinity,0.37]],
        mfj:    [[0,22000,0.10],[22000,89450,0.12],[89450,190750,0.22],[190750,364200,0.24],[364200,462500,0.32],[462500,693750,0.35],[693750,Infinity,0.37]],
        hoh:    [[0,15700,0.10],[15700,59850,0.12],[59850,95350,0.22],[95350,182100,0.24],[182100,231250,0.32],[231250,578100,0.35],[578100,Infinity,0.37]]
      };
      var taxable = Math.max(0, taxableWages - stdDed);
      var fed = 0;
      var br = BRACKETS[filing] || BRACKETS.single;
      for(var i=0;i<br.length;i++){
        var lo = br[i][0], hi = br[i][1], rate = br[i][2];
        var a = Math.max(0, Math.min(taxable, hi) - lo);
        if(a>0){ fed += a*rate; }
        if(taxable<=hi) break;
      }

      var SS_WAGE_BASE_2024 = 168600;
      var ss = Math.min(taxableWages, SS_WAGE_BASE_2024) * 0.062;
      var medicareBase = taxableWages * 0.0145;
      var ADDL_THRESH = { single:200000, mfj:250000, hoh:200000 };
      var addl = Math.max(0, taxableWages - (ADDL_THRESH[filing] || 200000)) * 0.009;
      var fica = ss + medicareBase + addl;

      var stateTax = taxableWages * (Math.max(0, stateRate)/100);
      var totalTax = fed + fica + stateTax;
      var netAnnual = Math.max(0, grossAnnual - totalTax - pretaxAnnual);
      return { netAnnual: netAnnual };
    }

    function checksPerYear(freq){
      return freq==='weekly'?52 : freq==='biweekly'?26 : freq==='semimonthly'?24 : 12;
    }

    function generatePayDates(calc, year){
      var dates = [];
      var y = +year;
      var freq = (calc && calc.freq) || 'monthly';

      if(freq==='weekly' || freq==='biweekly'){
        var start = (calc && calc.startDate) ? new Date(calc.startDate) : new Date(y,0,1);
        if(isNaN(start.getTime())) start = new Date(y,0,1);
        while(start.getFullYear()<y){ start.setDate(start.getDate() + (freq==='weekly'?7:14)); }
        while(start.getFullYear()>y){ start.setDate(start.getDate() - (freq==='weekly'?7:14)); }
        var step = freq==='weekly'?7:14;
        var d = new Date(start);
        while(d.getFullYear()<y){ d.setDate(d.getDate()+step); }
        while(d.getFullYear()===y && d.getMonth()>0){
          var prev = new Date(d); prev.setDate(prev.getDate()-step);
          if(prev.getFullYear()===y) d = prev; else break;
        }
        while(d.getFullYear()===y){
          dates.push(new Date(d));
          d.setDate(d.getDate()+step);
        }
      }else if(freq==='semimonthly'){
        var d1 = Math.min(28, Math.max(1, +((calc&&calc.semiDates&&calc.semiDates[0]) || 1)));
        var d2 = Math.min(28, Math.max(1, +((calc&&calc.semiDates&&calc.semiDates[1]) || 15)));
        for(var m=0;m<12;m++){ dates.push(new Date(y,m,d1)); dates.push(new Date(y,m,d2)); }
      }else{ // monthly
        var dm = Math.min(28, Math.max(1, +((calc&&calc.semiDates&&calc.semiDates[0]) || 1)));
        for(var m=0;m<12;m++){ dates.push(new Date(y,m,dm)); }
      }
      return dates;
    }

    function distributeCalendar(annualAmount, calc, year){
      var perCheck = (+annualAmount||0)/checksPerYear((calc && calc.freq) || 'monthly');
      var map = {};
      var ds = generatePayDates(calc, year);
      for(var i=0;i<ds.length;i++){
        var dt = ds[i];
        var key = dt.getFullYear() + '-' + pad2(dt.getMonth()+1);
        map[key] = (map[key]||0) + perCheck;
      }
      return map;
    }

    // ---------- Buttons ----------
    if(addIncomeBtn){
      addIncomeBtn.addEventListener('click', function(){
        state.incomes.push({id:uid(), name:'New Income', amounts:{}, calc:{}});
        state.months.forEach(function(m){ state.incomes[state.incomes.length-1].amounts[m]=0; });
        save(true);
      });
    }
    function deleteIncome(id){ state.incomes = state.incomes.filter(function(i){return i.id!==id;}); save(true); }

    if(addExpenseBtn){
      addExpenseBtn.addEventListener('click', function(){
        var d = {id:uid(), name:'New Expense', dueDay: 1, amounts:{}, paid:{}};
        state.months.forEach(function(m){ d.amounts[m]=0; d.paid[m]=false; });
        state.expenses.push(d); save(true);
      });
    }
    function deleteExpense(id){ state.expenses = state.expenses.filter(function(x){return x.id!==id;}); save(true); }
    if(markAllPaidBtn){
      markAllPaidBtn.addEventListener('click', function(){ if(confirm('Mark all expenses paid for the active month?')){ state.expenses.forEach(function(x){ x.paid[state.activeMonth]=true; }); save(true); }});
    }
    if(filterTxt){ filterTxt.addEventListener('input', function(){ renderExpenses(); renderExpensesMobile(); }); }

    if(exportBtn){
      exportBtn.addEventListener('click', function(){
        var blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
        var a = document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download='billbook.json';
        a.click();
      });
    }
    if(importInput){
      importInput.addEventListener('change', function(e){
        var f = e.target.files[0]; if(!f) return;
        var fr = new FileReader();
        fr.onload = function(){
          try{
            var obj = JSON.parse(fr.result);
            if(!obj || !obj.months) throw new Error('Invalid file');
            state = obj; save(true);
          }catch(err){ showError('Import failed: '+err.message); }
          importInput.value='';
        };
        fr.readAsText(f);
      });
    }
    if(resetBtn){ resetBtn.addEventListener('click', function(){ if(confirm('Clear all local data and reset?')) reset(); }); }

    // ---------- Render: Months ----------
    function renderMonths(){
      if(!monthsBar || !monthCount || !activeMonthLbl) return;
      monthsBar.innerHTML='';
      state.months.forEach(function(m){
        var b = document.createElement('button');
        b.className = 'pill month-chip' + (m===state.activeMonth?' active':'');
        b.textContent = fmtMonth(m);
        b.title = m;
        b.addEventListener('click', function(){ setActiveMonth(m); });
        monthsBar.appendChild(b);
      });
      monthCount.textContent = state.months.length + ' month(s)';
      activeMonthLbl.textContent = fmtMonth(state.activeMonth||'');

      renderYearMonthControls();
    }

    // ---------- Income table + calculator ----------
    function renderIncome(){
      if(!incomeTbl) return;
      var months = state.months.slice();
      var html = '';
      html += '<thead><tr>'+
              '<th style="min-width:220px">Source</th>'+
              months.map(function(m){return '<th class="right">'+fmtMonth(m)+'<div class="small muted">Amount</div></th>';}).join('')+
              '<th class="right">Total</th>'+
              '<th class="center">Calc</th>'+
              '<th class="center">Actions</th>'+
              '</tr></thead>';
      html += '<tbody>';

      for(var ii=0; ii<state.incomes.length; ii++){
        var inc = state.incomes[ii];
        var rowTotal = months.reduce(function(s,m){ return s + (+inc.amounts[m]||0); }, 0);
        html += '<tr>'+
          '<td><input class="inp" value="'+escapeHtml(inc.name)+'" data-act="income-name" data-id="'+inc.id+'"></td>'+
          months.map(function(m){
            var v = +inc.amounts[m]||0;
            return '<td class="right" style="white-space:nowrap">'+
                     '<input class="inp num" type="text" inputmode="decimal" placeholder="0.00" '+
                     'value="'+v+'" data-act="income-amt" data-id="'+inc.id+'" data-month="'+m+'">'+
                   '</td>';
          }).join('')+
          '<td class="right"><span>'+moneyFmt(rowTotal)+'</span></td>'+
          '<td class="center"><button class="btn" data-act="toggle-calc" data-id="'+inc.id+'">⚙️ Configure</button></td>'+
          '<td class="center"><button class="btn ghost small" data-act="income-del" data-id="'+inc.id+'">Delete</button></td>'+
        '</tr>';

        // calc drawer row
        var colSpan = months.length + 4; // Source + months + Total + Calc + Actions
        html += '<tr data-calc-row="'+inc.id+'" style="display:none"><td colspan="'+colSpan+'">'+
          '<div class="calc-drawer">'+
            '<div class="calc-grid">'+
              '<div><div class="note">Annual Gross</div>'+
                '<input class="inp num" type="text" inputmode="decimal" placeholder="e.g. 75000" '+
                'value="'+(inc.calc && inc.calc.grossAnnual!=null? inc.calc.grossAnnual : '')+'" data-calc="grossAnnual" data-id="'+inc.id+'"></div>'+
              '<div><div class="note">Frequency</div>'+
                '<select class="inp" data-calc="freq" data-id="'+inc.id+'">'+
                  '<option value="monthly"'+(inc.calc && inc.calc.freq==='monthly'?' selected':'')+'>Monthly (12)</option>'+
                  '<option value="semimonthly"'+(inc.calc && inc.calc.freq==='semimonthly'?' selected':'')+'>Semi-Monthly (2x/mo)</option>'+
                  '<option value="biweekly"'+(inc.calc && inc.calc.freq==='biweekly'?' selected':'')+'>Bi-Weekly (26)</option>'+
                  '<option value="weekly"'+(inc.calc && inc.calc.freq==='weekly'?' selected':'')+'>Weekly (52)</option>'+
                '</select></div>'+
              '<div><div class="note">Semi-Monthly / Monthly Day(s)</div>'+
                '<div style="display:flex;gap:6px">'+
                  '<input class="inp num" type="text" inputmode="numeric" placeholder="1" value="'+(((inc.calc&&inc.calc.semiDates)&&inc.calc.semiDates[0])||1)+'" data-calc="semi1" data-id="'+inc.id+'">'+
                  '<input class="inp num" type="text" inputmode="numeric" placeholder="15" value="'+(((inc.calc&&inc.calc.semiDates)&&inc.calc.semiDates[1])||15)+'" data-calc="semi2" data-id="'+inc.id+'">'+
                '</div></div>'+
              '<div><div class="note">Cycle Start (weekly/bi-weekly)</div>'+
                '<input class="inp" type="date" value="'+((inc.calc&&inc.calc.startDate)||'')+'" data-calc="start" data-id="'+inc.id+'"></div>'+
              '<div><div class="note">Filing Status</div>'+
                '<select class="inp" data-calc="filing" data-id="'+inc.id+'">'+
                  '<option value="single"'+((inc.calc&&inc.calc.filing)==='single'?' selected':'')+'>Single</option>'+
                  '<option value="mfj"'+((inc.calc&&inc.calc.filing)==='mfj'?' selected':'')+'>Married Filing Jointly</option>'+
                  '<option value="hoh"'+((inc.calc&&inc.calc.filing)==='hoh'?' selected':'')+'>Head of Household</option>'+
                '</select></div>'+
              '<div><div class="note">Pre-tax Annual (401k, etc.)</div>'+
                '<input class="inp num" type="text" inputmode="decimal" placeholder="0" value="'+((inc.calc&&inc.calc.pretaxAnnual)||0)+'" data-calc="pretax" data-id="'+inc.id+'"></div>'+
              '<div><div class="note">State Tax % (flat)</div>'+
                '<input class="inp num" type="text" inputmode="decimal" placeholder="0" value="'+((inc.calc&&inc.calc.stateRate)||0)+'" data-calc="state" data-id="'+inc.id+'"></div>'+
            '</div>'+
            <div class="calc-actions">'+
              '<span class="pill" data-calc-out="'+inc.id+'">Gross/mo: — • Net/mo: —</span>'+
              '<button class="btn ok" data-apply="gross-active" data-id="'+inc.id+'">Apply GROSS → Active</button>'+
              '<button class="btn ok" data-apply="gross-rest" data-id="'+inc.id+'">GROSS → Rest</button>'+
              '<button class="btn ok" data-apply="gross-all" data-id="'+inc.id+'">GROSS → All</button>'+
              '<button class="btn warn" data-apply="net-active" data-id="'+inc.id+'">NET → Active</button>'+
              '<button class="btn warn" data-apply="net-rest" data-id="'+inc.id+'">NET → Rest</button>'+
              '<button class="btn warn" data-apply="net-all" data-id="'+inc.id+'">NET → All</button>'+
              '<button class="btn brand" data-apply="gross-calendar" data-id="'+inc.id+'">GROSS → Calendar (Year)</button>'+
              '<button class="btn brand" data-apply="net-calendar" data-id="'+inc.id+'">NET → Calendar (Year)</button>'+
            '</div>'+
          '</div>'+
        '</td></tr>';
      }
      html += '</tbody>';
      html += '<tfoot><tr><td class="right">Monthly Total</td>'+
              months.map(function(m){ return '<td class="right">'+moneyFmt(state.incomes.reduce(function(s,i){ return s+(+i.amounts[m]||0); },0))+'</td>'; }).join('')+
              '<td class="right">'+moneyFmt(sumAllIncome())+'</td><td></td><td></td></tr></tfoot>';
      incomeTbl.innerHTML = html;

      // wiring
      $all('input[data-act="income-name"]').forEach(function(el){
        el.addEventListener('input', function(){ var i = findIncome(el.dataset.id); if(i){ i.name = el.value; save(false);} });
        el.addEventListener('blur', function(){ save(true); });
      });
      $all('input[data-act="income-amt"]').forEach(function(el){
        autoSizeInputPx(el);
        el.addEventListener('input', function(){ autoSizeInputPx(el); });
        el.addEventListener('blur', function(){
          var i = findIncome(el.dataset.id);
          if(i){ i.amounts[el.dataset.month] = numberFrom(el.value); el.value = i.amounts[el.dataset.month]; }
          save(true);
        });
      });
      $all('button[data-act="income-del"]').forEach(function(el){
        el.addEventListener('click', function(){ deleteIncome(el.dataset.id); });
      });
      $all('button[data-act="toggle-calc"]').forEach(function(btn){
        btn.addEventListener('click', function(){
          var row = incomeTbl.querySelector('tr[data-calc-row="'+btn.dataset.id+'"]');
          if(row){ row.style.display = row.style.display==='none' ? '' : 'none'; updateCalcOutput(btn.dataset.id); }
        });
      });

      // calc inputs
      $all('[data-calc]').forEach(function(el){
        el.addEventListener('input', function(){ updateCalcModel(el); updateCalcOutput(el.dataset.id); });
        el.addEventListener('change', function(){ updateCalcModel(el); updateCalcOutput(el.dataset.id); });
      });

      // apply buttons
      $all('button[data-apply]').forEach(function(b){
        b.addEventListener('click', function(){
          var inc = findIncome(b.dataset.id); if(!inc) return;
          var mode = b.dataset.apply;
          var grossAnnual = +(inc.calc && inc.calc.grossAnnual || 0);
          var filing = (inc.calc && inc.calc.filing) || 'single';
          var pretaxAnnual = +(inc.calc && inc.calc.pretaxAnnual || 0);
          var stateRate = +(inc.calc && inc.calc.stateRate || 0);
          var netAnnual = estimateAnnualNet(grossAnnual, filing, pretaxAnnual, stateRate).netAnnual;
          var grossMonthlyEq = (grossAnnual/12);
          var netMonthlyEq = (netAnnual/12);

          if(mode.indexOf('calendar')>-1){
            var year = state.year || now.getFullYear();
            var base = mode.indexOf('gross')===0 ? grossAnnual : netAnnual;
            var dist = distributeCalendar(base, inc.calc||{}, year);
            for(var m=1;m<=12;m++){
              var key = ymFrom(year,m);
              if(state.months.indexOf(key)===-1) state.months.push(key);
              if(!inc.amounts) inc.amounts = {};
              inc.amounts[key] = round2(dist[key]||0);
            }
            state.months.sort();
          }else{
            var val = mode.indexOf('gross')===0 ? grossMonthlyEq : netMonthlyEq;
            if(mode.indexOf('active')>-1){
              inc.amounts[state.activeMonth] = round2(val);
            }else if(mode.indexOf('rest')>-1){
              var seen=false;
              state.months.forEach(function(m){
                if(m===state.activeMonth){ seen=true; inc.amounts[m]=round2(val); }
                else if(seen){ inc.amounts[m]=round2(val); }
              });
            }else{ // all
              state.months.forEach(function(m){ inc.amounts[m]=round2(val); });
            }
          }
          save(true);
        });
      });
    }

    function updateCalcModel(el){
      var inc = findIncome(el.dataset.id); if(!inc) return;
      if(!inc.calc) inc.calc = {};
      var k = el.dataset.calc;
      if(k==='grossAnnual') inc.calc.grossAnnual = numberFrom(el.value);
      if(k==='freq') inc.calc.freq = el.value;
      if(k==='semi1' || k==='semi2'){
        var d1el = incomeTbl.querySelector('[data-calc="semi1"][data-id="'+inc.id+'"]');
        var d2el = incomeTbl.querySelector('[data-calc="semi2"][data-id="'+inc.id+'"]');
        var d1 = numberFrom(d1el ? d1el.value : 1);
        var d2 = numberFrom(d2el ? d2el.value : 15);
        if(!inc.calc.semiDates) inc.calc.semiDates = [1,15];
        inc.calc.semiDates[0] = clamp(d1,1,28);
        inc.calc.semiDates[1] = clamp(d2,1,28);
      }
      if(k==='start') inc.calc.startDate = el.value;
      if(k==='filing') inc.calc.filing = el.value;
      if(k==='pretax') inc.calc.pretaxAnnual = numberFrom(el.value);
      if(k==='state') inc.calc.stateRate = numberFrom(el.value);
      save(false);
    }

    function computeMonthly(inc){
      var grossAnnual = +(inc.calc && inc.calc.grossAnnual || 0);
      var netAnnual = estimateAnnualNet(
        grossAnnual,
        (inc.calc && inc.calc.filing) || 'single',
        +(inc.calc && inc.calc.pretaxAnnual || 0),
        +(inc.calc && inc.calc.stateRate || 0)
      ).netAnnual;
      return {grossMonthly: grossAnnual/12, netMonthly: netAnnual/12};
    }

    function updateCalcOutput(id){
      var inc = findIncome(id); if(!inc) return;
      var out = incomeTbl.querySelector('[data-calc-out="'+id+'"]');
      if(!out) return;
      var m = computeMonthly(inc);
      out.textContent = 'Gross/mo: '+moneyFmt(m.grossMonthly)+' • Net/mo: '+moneyFmt(m.netMonthly);
    }

    function findIncome(id){ for(var i=0;i<state.incomes.length;i++){ if(state.incomes[i].id===id) return state.incomes[i]; } return null; }

    // ---------- Expenses (desktop): Paid under amount, disables amount ----------
    function renderExpenses(){
      if(!expenseTbl) return;
      var months = state.months.slice();
      var f = (filterTxt && filterTxt.value || '').toLowerCase();
      var html = '';
      html += '<thead><tr>'+
              '<th style="min-width:220px">Expense</th>'+
              '<th class="center">Due Day</th>'+
              months.map(function(m){return '<th class="right">'+fmtMonth(m)+'<div class="small muted">Amount &amp; Paid</div></th>';}).join('')+
              '<th class="right">Row Total</th>'+
              '<th class="center">Copy</th>'+
              '<th class="center">Actions</th>'+
              '</tr></thead>';
      html += '<tbody>';

      for(var ei=0; ei<state.expenses.length; ei++){
        var ex = state.expenses[ei];
        if(f && ex.name.toLowerCase().indexOf(f)===-1) continue;
        var rowTotal = months.reduce(function(s,m){ return s + (+ex.amounts[m]||0); }, 0);
        var overdue = isOverdue(ex, state.activeMonth);
        html += '<tr'+(overdue ? ' style="outline:2px solid rgba(220,38,38,.15); outline-offset:-2px"' : '')+'>'+
          '<td'+(overdue? ' style="color:#991b1b"':'')+'><input class="inp" value="'+escapeHtml(ex.name)+'" data-act="exp-name" data-id="'+ex.id+'"></td>'+
          '<td class="center" style="white-space:nowrap"><input class="inp num" type="text" inputmode="numeric" placeholder="1-31" value="'+(+ex.dueDay||1)+'" data-act="exp-due" data-id="'+ex.id+'"></td>'+
          months.map(function(m){
            var v = +ex.amounts[m]||0;
            var paid = !!ex.paid[m];
            return '<td class="right" style="white-space:nowrap">'+
                     '<div class="amt-wrap">'+
                       '<input class="inp num" type="text" inputmode="decimal" placeholder="0.00" '+
                         'value="'+v+'" '+(paid?'disabled':'')+' data-act="exp-amt" data-id="'+ex.id+'" data-month="'+m+'">'+
                       '<label class="paid-wrap"><input type="checkbox" '+(paid?'checked':'')+' data-act="exp-paid" data-id="'+ex.id+'" data-month="'+m+'"> Paid</label>'+
                     '</div>'+
                   '</td>';
          }).join('')+
          '<td class="right">'+moneyFmt(rowTotal)+'</td>'+
          '<td class="center"><div class="bar" style="gap:6px;margin:0">'+
            '<button class="btn small" data-copy="next" data-id="'+ex.id+'">Active → Next</button>'+
            '<button class="btn small" data-copy="rest" data-id="'+ex.id+'">Active → Rest</button>'+
            '<button class="btn small" data-copy="all"  data-id="'+ex.id+'">Active → All</button>'+
          '</div></td>'+
          '<td class="center"><button class="btn ghost small" data-act="exp-del" data-id="'+ex.id+'">Delete</button></td>'+
        '</tr>';
      }
      html += '</tbody>';

      html += '<tfoot><tr><td class="right" colspan="2">Monthly Total</td>'+
              months.map(function(m){ return '<td class="right">'+moneyFmt(state.expenses.reduce(function(s,x){ return s+(+x.amounts[m]||0); },0))+'</td>'; }).join('')+
              '<td class="right">'+moneyFmt(sumAllExpenses())+'</td>'+
              '<td></td><td></td></tr></tfoot>';

      expenseTbl.innerHTML = html;

      // Inputs: name / due day
      $all('input[data-act="exp-name"]').forEach(function(el){
        el.addEventListener('input', function(){ var x = findExp(el.dataset.id); if(x){ x.name = el.value; save(false);} });
        el.addEventListener('blur', function(){ save(true); });
      });
      $all('input[data-act="exp-due"]').forEach(function(el){
        autoSizeInputPx(el);
        el.addEventListener('input', function(){ autoSizeInputPx(el); });
        el.addEventListener('blur', function(){
          var x = findExp(el.dataset.id);
          if(x){ var v = Math.max(1, Math.min(31, parseInt(el.value,10)||1)); x.dueDay = v; el.value = v; }
          save(true);
        });
      });

      // Amount fields
      $all('input[data-act="exp-amt"]').forEach(function(el){
        autoSizeInputPx(el);
        el.addEventListener('input', function(){ autoSizeInputPx(el); });
        el.addEventListener('blur', function(){
          var x = findExp(el.dataset.id);
          if(x){ var val = numberFrom(el.value); x.amounts[el.dataset.month] = val; el.value = val; }
          save(true);
        });
      });

      // Paid toggles (disable/enable paired amount on change)
      $all('input[data-act="exp-paid"]').forEach(function(el){
        el.addEventListener('change', function(){
          var x = findExp(el.dataset.id); if(!x) return;
          var m = el.dataset.month;
          x.paid[m] = el.checked;
          // find sibling amount input in same cell
          var td = el.closest('td');
          if(td){
            var amt = td.querySelector('input[data-act="exp-amt"][data-id="'+x.id+'"][data-month="'+m+'"]');
            if(amt){ amt.disabled = el.checked; }
          }
          save(true);
        });
      });

      // Copy + delete
      $all('button[data-copy]').forEach(function(b){
        b.addEventListener('click', function(){ var e = findExp(b.dataset.id); if(!e) return; copyExpenseFromActive(e, b.dataset.copy); save(true); });
      });
      $all('button[data-act="exp-del"]').forEach(function(el){
        el.addEventListener('click', function(){ deleteExpense(el.dataset.id); });
      });
    }

    // ---------- Expenses (mobile cards) ----------
    function renderExpensesMobile(){
      if(!expenseMobile) return;
      var f = (filterTxt && filterTxt.value || '').toLowerCase();
      var m = state.activeMonth;
      expenseMobile.innerHTML = '';
      var frag = document.createDocumentFragment();

      state.expenses.forEach(function(ex){
        if(f && ex.name.toLowerCase().indexOf(f)===-1) return;
        var card = document.createElement('div');
        card.className = 'exp-card';

        var head = document.createElement('div');
        head.className = 'exp-head';

        var name = document.createElement('input');
        name.className = 'inp exp-name';
        name.value = ex.name;
        name.addEventListener('input', function(){ ex.name = name.value; save(false); });

        var dueWrap = document.createElement('div');
        dueWrap.className = 'exp-row';
        dueWrap.innerHTML = '<span class="label">Due</span>';
        var due = document.createElement('input');
        due.type = 'text'; due.inputMode = 'numeric';
        due.className = 'inp num';
        due.placeholder = '1-31';
        due.value = ex.dueDay||1;
        due.addEventListener('blur', function(){
          var v = Math.max(1, Math.min(31, parseInt(due.value,10)||1));
          ex.dueDay = v; due.value = v; save(true);
        });
        dueWrap.appendChild(due);

        head.appendChild(name);
        head.appendChild(dueWrap);

        var row = document.createElement('div');
        row.className = 'exp-row';
        row.innerHTML = '<span class="label">Amount ('+fmtMonth(m)+')</span>';
        var amt = document.createElement('input');
        amt.type = 'text'; amt.inputMode = 'decimal';
        amt.className = 'inp num';
        amt.placeholder = '0.00';
        amt.value = +ex.amounts[m]||0;
        amt.disabled = !!ex.paid[m];
        amt.addEventListener('blur', function(){
          ex.amounts[m] = numberFrom(amt.value); amt.value = ex.amounts[m]; save(true);
        });
        row.appendChild(amt);

        var paidRow = document.createElement('div');
        paidRow.className = 'exp-row';
        var paidLabel = document.createElement('span');
        paidLabel.className = 'label';
        paidLabel.textContent = 'Paid';
        var paid = document.createElement('input');
        paid.type = 'checkbox';
        paid.checked = !!ex.paid[m];
        paid.addEventListener('change', function(){
          ex.paid[m] = paid.checked;
          amt.disabled = paid.checked;
          save(true);
        });
        paidRow.appendChild(paidLabel); paidRow.appendChild(paid);

        var actions = document.createElement('div');
        actions.className = 'exp-actions';
        ['next','rest','all'].forEach(function(mode){
          var b = document.createElement('button');
          b.className = 'btn small';
          b.textContent = mode==='next'?'Active → Next': mode==='rest'?'Active → Rest':'Active → All';
          b.addEventListener('click', function(){ copyExpenseFromActive(ex, mode); save(true); });
          actions.appendChild(b);
        });

        var del = document.createElement('button');
        del.className = 'btn ghost';
        del.textContent = 'Delete';
        del.addEventListener('click', function(){ deleteExpense(ex.id); });

        card.appendChild(head);
        card.appendChild(row);
        card.appendChild(paidRow);
        card.appendChild(actions);
        card.appendChild(del);

        frag.appendChild(card);
      });

      expenseMobile.appendChild(frag);
    }

    // ---------- Common helpers ----------
    function isOverdue(exp, ym){
      if(!ym) return false;
      var parts = ym.split('-');
      var y = parseInt(parts[0],10), m = parseInt(parts[1],10);
      var nowD = new Date();
      if(nowD < new Date(y, m-1, 1) || nowD > new Date(y, m-1, 31)) return false;
      return (nowD.getDate() > (exp.dueDay||1)) && !exp.paid[ym];
    }
    function sumAllIncome(){ return state.months.reduce(function(s,m){ return s + state.incomes.reduce(function(t,i){ return t+(+i.amounts[m]||0); },0); }, 0); }
    function sumAllExpenses(){ return state.months.reduce(function(s,m){ return s + state.expenses.reduce(function(t,x){ return t+(+x.amounts[m]||0); },0); }, 0); }
    function findExp(id){ for(var i=0;i<state.expenses.length;i++){ if(state.expenses[i].id===id) return state.expenses[i]; } return null; }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function round2(n){ return Math.round(n*100)/100; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

    function renderKPIs(){
      var m = state.activeMonth;
      var inc = state.incomes.reduce(function(s,i){ return s+(+i.amounts[m]||0); }, 0);
      var exp = state.expenses.reduce(function(s,x){ return s+(+x.amounts[m]||0); }, 0);
      var unpaid = state.expenses.reduce(function(s,x){ return s + (x.paid[m]?0:1); }, 0);
      var incLbl = $('#kpiIncome'), expLbl = $('#kpiExpenses'), netLbl = $('#kpiNet'), unLbl = $('#kpiUnpaid');
      if(incLbl) incLbl.textContent = moneyFmt(inc);
      if(expLbl) expLbl.textContent = moneyFmt(exp);
      if(netLbl) netLbl.textContent = moneyFmt(inc-exp);
      if(unLbl) unLbl.textContent = unpaid;
    }

    // Pixel autosizer for numeric inputs
    var meas = document.createElement('span');
    meas.style.cssText = 'position:absolute;visibility:hidden;white-space:pre;top:-9999px;left:-9999px;font:inherit;padding:0;border:0;';
    document.body.appendChild(meas);
    function copyFont(el){ var cs=getComputedStyle(el); ['font-family','font-size','font-weight','font-style','letter-spacing'].forEach(function(p){ meas.style[p]=cs[p]; }); }
    function autoSizeInputPx(el){ copyFont(el); meas.textContent = el.value || el.placeholder || ''; el.style.width = Math.max(8, meas.getBoundingClientRect().width + 22) + 'px'; }

    function renderAll(){
      renderMonths();
      renderIncome();
      renderExpenses();
      renderExpensesMobile();
      renderKPIs();
      $all('#incomeTbl .inp.num, #expenseTbl .inp.num').forEach(function(el){ autoSizeInputPx(el); });
    }

    // initial
    renderAll();

    // re-render mobile/desktop on resize breakpoint changes
    var lastWidth = window.innerWidth;
    window.addEventListener('resize', function(){
      var w = window.innerWidth;
      if((lastWidth>640 && w<=640) || (lastWidth<=640 && w>640)){
        renderExpenses(); renderExpensesMobile();
      }
      lastWidth = w;
    });
  } // end init
})();
</script>
</body>
</html>
