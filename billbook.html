<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bill Book — Personal Finance (Local Only)</title>

<style>
  :root{
    /* Softer, readable light theme */
    --ink:#111827; --ink-soft:#6b7280; --bg:#ffffff;
    --card:#ffffff; --border:#e5e7eb; --ring:#93c5fd;
    --thead:#f5f7fb; --row-alt:#fafcff; --row-hover:#f0f6ff;

    --brand:#2563eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--ink);
    background:var(--bg);
  }

  .wrap{max-width:1200px; margin:16px auto; padding:0 12px}
  h1{font-size:clamp(20px,5vw,26px); color:var(--ink); margin:8px 0; text-align:center}
  .sub{text-align:center; color:var(--ink-soft); font-size:12px; margin-bottom:12px}

  /* Controls */
  .bar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px}
  .btn{
    appearance:none; border:1px solid var(--border); background:#f8fafc; color:#0f172a;
    padding:10px 12px; border-radius:12px; cursor:pointer; font-size:14px; flex-shrink:0
  }
  .btn:hover{background:#eef2f7}
  .btn.brand{background:linear-gradient(180deg,#3b82f6,#2563eb); color:#fff; border-color:#1e40af}
  .btn.ok{background:#e8f6ee; border-color:#b7e2c7; color:#065f46}
  .btn.bad{background:#fdecec; border-color:#f8c7c7; color:#7f1d1d}
  .btn.warn{background:#fff3e1; border-color:#fbd19f; color:#92400e}
  .btn.ghost{background:transparent}
  .pill{padding:6px 10px; border-radius:999px; font-size:12px; color:#0f172a; background:#f3f4f6; border:1px solid var(--border)}
  .inp{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
    background:#fff; color:#111827; font-size:14px
  }
  .inp:focus{outline:none; border-color:var(--ring); box-shadow:0 0 0 3px rgba(147,197,253,.35)}
  /* Numeric fields: monospace + autosize */
  .inp.num{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    min-width: 8ch; width:auto; max-width:none;
    text-align:right; font-variant-numeric:tabular-nums;
    display:inline-block; white-space:nowrap;
  }

  /* Layout */
  .grid{display:grid; gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}

  /* Cards */
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .section-title{font-weight:600; margin-bottom:6px}
  .note{color:var(--ink-soft); font-size:12px}

  /* Tables — softened for readability */
  .tbl{width:100%; border-collapse:separate; border-spacing:0; font-size:14px; table-layout:auto}
  .tbl th,.tbl td{padding:10px; color:#111827; vertical-align:middle}
  .tbl th{
    position:sticky; top:0; z-index:2; background:var(--thead); font-size:12px; text-align:left;
    border-bottom:1px solid var(--border); white-space:nowrap;
  }
  .tbl td{border-bottom:1px solid var(--border)}
  .tbl tr:nth-child(even) td{background:var(--row-alt)}
  .tbl tbody tr:hover td{background:var(--row-hover)}
  .tbl td.right{white-space:nowrap}
  .right{text-align:right}
  .center{text-align:center}

  /* Horizontal scroll for mobile */
  .scroll-x{overflow-x:auto; -webkit-overflow-scrolling:touch}

  /* KPI cards */
  .kpis{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px}
  .kpi{background:#f8fafc; border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center}
  .kpi .label{color:#6b7280; font-size:12px}
  .kpi .val{color:#0f172a; font-size:clamp(16px,5vw,20px); font-weight:700}

  /* Mobile-first */
  @media (max-width:900px){
    .grid.cols-2{grid-template-columns:1fr}
    .bar{justify-content:center}
    .wrap{padding:0 10px}
  }
  @media (max-width:600px){
    .btn{font-size:15px; padding:12px 14px}
    .inp{font-size:16px; padding:12px 14px}
    .tbl{font-size:15px}
    .tbl th,.tbl td{padding:12px}
    input[type=checkbox]{width:22px; height:22px}
    .pill{padding:8px 12px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Bill Book — Personal Finance (Local)</h1>
    <div class="sub">Data is saved in your browser’s <strong>localStorage</strong>. No servers. You can export/import JSON anytime.</div>

    <div class="bar">
      <button id="addMonthBtn" class="btn brand">+ Add Month</button>
      <button id="removeMonthBtn" class="btn ghost">Remove Last Month</button>
      <span class="pill" id="monthCount"></span>
      <span class="pill">Today: <span id="today"></span></span>
      <span class="pill">Active Month: <span id="activeMonthLbl"></span></span>
      <span class="pill">Autosave On</span>
      <div style="flex:1"></div>
      <button id="exportBtn" class="btn">Export JSON</button>
      <label class="btn ghost file">Import JSON <input id="importInput" type="file" accept="application/json" style="display:none"></label>
      <button id="resetBtn" class="btn bad">Reset (Clear Local)</button>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <div class="section-title">Months</div>
        <!-- Year & Month controls -->
        <div class="bar">
          <select id="yearSelect" class="inp" style="max-width:120px"></select>
          <select id="monthSelect" class="inp" style="max-width:180px"></select>
          <button id="populateYearBtn" class="btn brand">Populate Year</button>
          <button id="addRestBtn" class="btn">Add Rest of Year</button>
        </div>
        <div id="monthsBar" class="bar" style="flex-wrap:wrap"></div>
        <div class="note">Tip: Click a month chip or use the Month dropdown to set the active month.</div>
      </div>

      <!-- Settings card removed per request -->
    </div>

    <div class="grid cols-2" style="margin-top:14px">
      <div class="card">
        <div class="section-title">Income</div>
        <div class="bar">
          <button id="addIncome" class="btn ok">+ Add Income Source</button>
        </div>
        <div class="squeeze scroll-x">
          <table class="tbl" id="incomeTbl"></table>
        </div>
      </div>
      <div class="card">
        <div class="section-title">Quick Totals (Active Month)</div>
        <div class="kpis">
          <div class="kpi"><div class="label">Income</div><div class="val" id="kpiIncome">$0</div></div>
          <div class="kpi"><div class="label">Expenses</div><div class="val" id="kpiExpenses">$0</div></div>
          <div class="kpi"><div class="label">Net</div><div class="val" id="kpiNet">$0</div></div>
          <div class="kpi"><div class="label">Unpaid Bills</div><div class="val" id="kpiUnpaid">0</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="section-title">Expenses</div>
      <div class="bar">
        <button id="addExpense" class="btn ok">+ Add Expense</button>
        <button id="markAllPaid" class="btn warn">Mark All Paid (Active Month)</button>
        <label class="pill" style="display:flex;gap:8px;align-items:center;background:#f9fafb">
          <span>Filter</span>
          <input id="filterTxt" class="inp" placeholder="Type to filter by name…" style="width:220px">
        </label>
      </div>
      <div class="squeeze scroll-x">
        <table class="tbl" id="expenseTbl"></table>
      </div>
      <div class="note" style="margin-top:8px">Overdue and unpaid items for the active month are highlighted.</div>
    </div>

  </div>

<script>
(function(){
  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtMonth = (ym) => {
    if(!ym) return '';
    const [y,m] = ym.split('-').map(Number);
    const d = new Date(y, m-1, 1);
    return d.toLocaleDateString(undefined,{month:'long', year:'numeric'});
  };
  const pad2 = n => String(n).padStart(2,'0');
  const ymOf = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  const ymFrom = (y,m) => `${y}-${pad2(m)}`;
  const moneyFmt = (n,curr) => new Intl.NumberFormat(undefined,{style:'currency',currency:curr}).format(+n||0);
  const uid = () => Math.random().toString(36).slice(2,9);
  const now = new Date();

  // ---------- State ----------
  const KEY = 'billbook.v1';
  function defaultState(){
    const cur = ymOf(now);
    const prev = ymOf(new Date(now.getFullYear(), now.getMonth()-1, 1));
    const next = ymOf(new Date(now.getFullYear(), now.getMonth()+1, 1));
    return {
      year: now.getFullYear(),
      currency: 'USD',
      months: [prev, cur, next],
      activeMonth: cur,
      incomes: [
        {id: uid(), name: "Cory's Wages", amounts: {[prev]: 0, [cur]: 0, [next]: 0}},
        {id: uid(), name: "Amy's Wages",  amounts: {[prev]: 0, [cur]: 0, [next]: 0}}
      ],
      expenses: [
        {id: uid(), name: 'Rent/Mortgage', dueDay: 1,  amounts: {[prev]: 0,[cur]: 0,[next]: 0}, paid: {}},
        {id: uid(), name: 'Electric',      dueDay: 15, amounts: {[prev]: 0,[cur]: 0,[next]: 0}, paid: {}},
        {id: uid(), name: 'Internet',      dueDay: 20, amounts: {[prev]: 0,[cur]: 0,[next]: 0}, paid: {}}
      ]
    };
  }
  let state = load() || defaultState();

  function save(render = true){
    localStorage.setItem(KEY, JSON.stringify(state));
    if(render) renderAll();
  }
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){ return null; } }
  function reset(){ localStorage.removeItem(KEY); state = defaultState(); renderAll(); }

  // ---------- DOM refs ----------
  const addMonthBtn = $('#addMonthBtn');
  const removeMonthBtn = $('#removeMonthBtn');
  const monthCount = $('#monthCount');
  const monthsBar = $('#monthsBar');
  const activeMonthLbl = $('#activeMonthLbl');
  const todayLbl = $('#today');
  const addIncomeBtn = $('#addIncome');
  const addExpenseBtn = $('#addExpense');
  const markAllPaidBtn = $('#markAllPaid');
  const filterTxt = $('#filterTxt');
  const incomeTbl = $('#incomeTbl');
  const expenseTbl = $('#expenseTbl');
  const exportBtn = $('#exportBtn');
  const importInput = $('#importInput');
  const resetBtn = $('#resetBtn');
  const yearSelect = $('#yearSelect');
  const monthSelect = $('#monthSelect');
  const populateYearBtn = $('#populateYearBtn');
  const addRestBtn = $('#addRestBtn');

  todayLbl.textContent = new Date().toLocaleDateString();

  // ---------- Month/Year helpers ----------
  function ensureActiveMonth(){
    if(!state.activeMonth){
      const y = state.year || now.getFullYear();
      const guess = ymFrom(y, (y===now.getFullYear()? now.getMonth()+1 : 1));
      state.activeMonth = state.months.includes(guess) ? guess : (state.months[0] || guess);
    }
  }

  function populateYear(y){
    state.year = +y;
    state.months = [];
    for(let m=1; m<=12; m++) state.months.push(ymFrom(+y,m));
    // backfill structures
    state.incomes.forEach(i=>{
      if(!i.amounts) i.amounts={};
      state.months.forEach(m=>{ if(i.amounts[m]==null) i.amounts[m]=0; });
    });
    state.expenses.forEach(x=>{
      if(!x.amounts) x.amounts={};
      if(!x.paid) x.paid={};
      state.months.forEach(m=>{
        if(x.amounts[m]==null) x.amounts[m]=0;
        if(x.paid[m]==null) x.paid[m]=false;
      });
    });
    state.activeMonth = ymFrom(+y,1);
    save();
  }

  function addRestOfYear(){
    const y = +yearSelect.value || state.year || now.getFullYear();
    ensureActiveMonth();
    const startM = state.activeMonth.startsWith(String(y)) ? +state.activeMonth.split('-')[1] : (y===now.getFullYear()? now.getMonth()+1 : 1);
    for(let m=startM; m<=12; m++){
      const key = ymFrom(y,m);
      if(!state.months.includes(key)) state.months.push(key);
    }
    state.months.sort();
    // backfill
    state.incomes.forEach(i=>{
      if(!i.amounts) i.amounts={};
      state.months.forEach(m=>{ if(i.amounts[m]==null) i.amounts[m]=0; });
    });
    state.expenses.forEach(x=>{
      if(!x.amounts) x.amounts={};
      if(!x.paid) x.paid={};
      state.months.forEach(m=>{
        if(x.amounts[m]==null) x.amounts[m]=0;
        if(x.paid[m]==null) x.paid[m]=false;
      });
    });
    save();
  }

  // ---------- Month mgmt ----------
  addMonthBtn.addEventListener('click', ()=>{
    const d = prompt('Add month (YYYY-MM), e.g., 2025-10');
    if(!d) return;
    if(!/^\d{4}-\d{2}$/.test(d)) return alert('Format must be YYYY-MM');
    if(state.months.includes(d)) return alert('Month already exists.');
    state.months.push(d);
    // initialize values for new month
    state.incomes.forEach(i=> i.amounts[d] = i.amounts[d] ?? 0);
    state.expenses.forEach(x=> {
      x.amounts[d] = x.amounts[d] ?? 0;
      x.paid[d] = x.paid[d] ?? false;
    });
    save();
  });
  removeMonthBtn.addEventListener('click', ()=>{
    if(!state.months.length) return;
    const last = state.months[state.months.length-1];
    if(!confirm(`Remove month ${fmtMonth(last)}?`)) return;
    state.months.pop();
    if(state.activeMonth===last) state.activeMonth = state.months[state.months.length-1]||'';
    save();
  });

  function setActiveMonth(m){ state.activeMonth=m; save(); }

  // ---------- Auto-size numeric inputs ----------
  function autoSizeInput(el){
    // ch units are accurate with monospace; add a little padding
    const len = (el.value || '').length;
    el.style.width = Math.max(8, len + 2) + 'ch';
  }

  // ---------- Income ----------
  addIncomeBtn.addEventListener('click', ()=>{
    state.incomes.push({id:uid(), name:'New Income', amounts:{}});
    state.months.forEach(m=>{ state.incomes[state.incomes.length-1].amounts[m]=0; });
    save();
  });
  function deleteIncome(id){ state.incomes = state.incomes.filter(i=>i.id!==id); save(); }

  // ---------- Expenses ----------
  addExpenseBtn.addEventListener('click', ()=>{
    const d = {id:uid(), name:'New Expense', dueDay: 1, amounts:{}, paid:{}};
    state.months.forEach(m=>{ d.amounts[m]=0; d.paid[m]=false; });
    state.expenses.push(d); save();
  });
  function deleteExpense(id){ state.expenses = state.expenses.filter(x=>x.id!==id); save(); }
  function markAllPaidActive(){ state.expenses.forEach(x=> x.paid[state.activeMonth]=true); save(); }
  markAllPaidBtn.addEventListener('click', ()=>{ if(confirm('Mark all expenses paid for the active month?')) markAllPaidActive(); });
  filterTxt.addEventListener('input', renderExpenses);

  // ---------- Expense copy helpers ----------
  function copyExpenseFromActive(ex, mode){
    const src = state.activeMonth; if(!src) return;
    const srcVal = +ex.amounts[src]||0;
    if(mode==='next'){
      const idx = state.months.indexOf(src);
      if(idx>-1 && idx+1<state.months.length){
        ex.amounts[state.months[idx+1]] = srcVal;
      }
    }else if(mode==='rest'){
      let seen=false;
      state.months.forEach(m=>{ if(m===src){ seen=true; return; } if(seen){ ex.amounts[m]=srcVal; }});
    }else if(mode==='all'){
      state.months.forEach(m=> ex.amounts[m]=srcVal);
    }
  }

  // ---------- Export / Import / Reset ----------
  exportBtn.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='billbook.json';
    a.click();
  });
  importInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      const text = await f.text();
      const obj = JSON.parse(text);
      if(!obj || !obj.months) throw new Error('Invalid file');
      state = obj; save();
    }catch(err){ alert('Import failed: '+err.message); }
    importInput.value='';
  });
  resetBtn.addEventListener('click', ()=>{ if(confirm('Clear all local data and reset?')) reset(); });

  // ---------- Rendering ----------
  function renderYearMonthControls(){
    // Year select: prev, current, next two years
    const yNow = now.getFullYear();
    const years = [yNow-1, yNow, yNow+1, yNow+2];
    yearSelect.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
    if(!state.year) state.year = yNow;
    yearSelect.value = state.year;

    // Month select from state.months
    ensureActiveMonth();
    monthSelect.innerHTML = state.months.map(m=>`<option value="${m}">${fmtMonth(m)}</option>`).join('');
    if(state.activeMonth) monthSelect.value = state.activeMonth;

    yearSelect.onchange = () => { state.year = +yearSelect.value; save(false); };
    monthSelect.onchange = () => { state.activeMonth = monthSelect.value; save(); };
    populateYearBtn.onclick = () => populateYear(+yearSelect.value);
    addRestBtn.onclick = addRestOfYear;
  }

  function renderMonths(){
    monthsBar.innerHTML='';
    state.months.forEach(m=>{
      const b = document.createElement('button');
      b.className = 'pill month-chip' + (m===state.activeMonth?' active':'');
      b.textContent = fmtMonth(m);
      b.title = m;
      b.addEventListener('click', ()=> setActiveMonth(m));
      monthsBar.appendChild(b);
    });
    monthCount.textContent = `${state.months.length} month(s)`;
    activeMonthLbl.textContent = fmtMonth(state.activeMonth||'');

    renderYearMonthControls();
  }

  function renderIncome(){
    const months = state.months;
    let html = '';
    html += '<thead><tr>'+
            '<th style="min-width:220px">Source</th>'+
            months.map(m=>`<th class="right">${fmtMonth(m)}<div class="small muted">Amount</div></th>`).join('')+
            '<th class="right">Total</th><th class="center">Actions</th>'+
            '</tr></thead>';
    html += '<tbody>';
    for(const inc of state.incomes){
      const rowTotal = months.reduce((s,m)=> s + (+inc.amounts[m]||0), 0);
      html += `<tr>
        <td><input class="inp" value="${escapeHtml(inc.name)}" data-act="income-name" data-id="${inc.id}"></td>
        ${months.map(m=>`
          <td class="right" style="white-space:nowrap">
            <input class="inp num" type="number" inputmode="decimal" step="0.01"
              value="\${+inc.amounts[m]||0}" data-act="income-amt" data-id="${inc.id}" data-month="${m}">
          </td>
        `).join('')}
        <td class="right"><span>${moneyFmt(rowTotal,state.currency)}</span></td>
        <td class="center">
          <div class="row-controls">
            <button class="btn ghost small" data-act="income-del" data-id="${inc.id}">Delete</button>
          </div>
        </td>
      </tr>`;
    }
    html += '</tbody>';
    html += '<tfoot><tr><td class="right">Monthly Total</td>'+
            months.map(m=>`<td class="right">${moneyFmt(state.incomes.reduce((s,i)=> s+(+i.amounts[m]||0),0), state.currency)}</td>`).join('')+
            `<td class="right">${moneyFmt(sumAllIncome(), state.currency)}</td><td></td></tr></tfoot>`;

    incomeTbl.innerHTML = html;

    // Smooth typing + autosize
    incomeTbl.querySelectorAll('input[data-act="income-name"]').forEach(el=>{
      el.addEventListener('input', ()=>{
        const i = state.incomes.find(x=>x.id===el.dataset.id);
        if(i){ i.name = el.value; save(false); }
      });
      el.addEventListener('blur', ()=> save(true));
    });
    incomeTbl.querySelectorAll('input[data-act="income-amt"]').forEach(el=>{
      autoSizeInput(el);
      el.addEventListener('input', ()=>{
        const i = state.incomes.find(x=>x.id===el.dataset.id);
        if(i){ i.amounts[el.dataset.month] = +el.value||0; save(false); }
        autoSizeInput(el);
      });
      el.addEventListener('blur', ()=> save(true));
    });
    incomeTbl.querySelectorAll('button[data-act="income-del"]').forEach(el=>{
      el.addEventListener('click', ()=> deleteIncome(el.dataset.id));
    });
  }

  function renderExpenses(){
    const months = state.months;
    const f = (filterTxt.value||'').toLowerCase();
    let html = '';
    html += '<thead><tr>'+
            '<th style="min-width:220px">Expense</th>'+
            '<th class="center">Due Day</th>'+
            months.map(m=>`<th class="right">${fmtMonth(m)}<div class="small muted">Amount</div></th>`).join('')+
            months.map(m=>`<th class="center">${fmtMonth(m)}<div class="small muted">Paid</div></th>`).join('')+
            '<th class="right">Row Total</th>'+
            '<th class="center">Copy</th>'+
            '<th class="center">Actions</th>'+
            '</tr></thead>';
    html += '<tbody>';

    for(const ex of state.expenses){
      if(f && !ex.name.toLowerCase().includes(f)) continue;
      const rowTotal = months.reduce((s,m)=> s + (+ex.amounts[m]||0), 0);
      const overdue = isOverdue(ex, state.activeMonth);
      html += `<tr${overdue ? ' style="outline:2px solid rgba(220,38,38,.15); outline-offset:-2px"' : ''}>
        <td${overdue? ' style="color:#991b1b"':''}>
          <input class="inp" value="${escapeHtml(ex.name)}" data-act="exp-name" data-id="${ex.id}">
        </td>
        <td class="center" style="white-space:nowrap">
          <input class="inp num" type="number" inputmode="numeric" min="1" max="31"
                 value="${+ex.dueDay||1}" data-act="exp-due" data-id="${ex.id}">
        </td>
        ${months.map(m=>`<td class="right" style="white-space:nowrap">
            <input class="inp num" type="number" inputmode="decimal" step="0.01"
                   value="${+ex.amounts[m]||0}" data-act="exp-amt" data-id="${ex.id}" data-month="${m}">
          </td>`).join('')}
        ${months.map(m=>`<td class="center"><input type="checkbox" ${ex.paid[m]? 'checked':''} data-act="exp-paid" data-id="${ex.id}" data-month="${m}"></td>`).join('')}
        <td class="right">${moneyFmt(rowTotal,state.currency)}</td>
        <td class="center">
          <div class="bar" style="gap:6px;margin:0">
            <button class="btn small" data-copy="next" data-id="${ex.id}">Active → Next</button>
            <button class="btn small" data-copy="rest" data-id="${ex.id}">Active → Rest</button>
            <button class="btn small" data-copy="all"  data-id="${ex.id}">Active → All</button>
          </div>
        </td>
        <td class="center">
          <div class="row-controls">
            <button class="btn ghost small" data-act="exp-del" data-id="${ex.id}">Delete</button>
          </div>
        </td>
      </tr>`;
    }
    html += '</tbody>';

    html += '<tfoot><tr><td class="right" colspan="2">Monthly Total</td>'+
            months.map(m=>`<td class="right">${moneyFmt(state.expenses.reduce((s,x)=> s+(+x.amounts[m]||0),0), state.currency)}</td>`).join('')+
            months.map(m=>`<td class="center">${state.expenses.reduce((s,x)=> s + (x.paid[m]?1:0),0)}</td>`).join('')+
            `<td class="right">${moneyFmt(sumAllExpenses(), state.currency)}</td>`+
            '<td></td><td></td></tr></tfoot>';

    expenseTbl.innerHTML = html;

    // Smooth typing + autosize numeric
    expenseTbl.querySelectorAll('input[data-act="exp-name"]').forEach(el=>{
      el.addEventListener('input', ()=>{
        const x = findExp(el.dataset.id);
        if(x){ x.name = el.value; save(false); }
      });
      el.addEventListener('blur', ()=> save(true));
    });
    expenseTbl.querySelectorAll('input[data-act="exp-due"]').forEach(el=>{
      autoSizeInput(el);
      el.addEventListener('input', ()=>{
        const x = findExp(el.dataset.id);
        if(x){ x.dueDay = clamp(+el.value||1,1,31); save(false); }
        autoSizeInput(el);
      });
      el.addEventListener('blur', ()=> save(true));
    });
    expenseTbl.querySelectorAll('input[data-act="exp-amt"]').forEach(el=>{
      autoSizeInput(el);
      el.addEventListener('input', ()=>{
        const x = findExp(el.dataset.id);
        if(x){ x.amounts[el.dataset.month] = +el.value||0; save(false); }
        autoSizeInput(el);
      });
      el.addEventListener('blur', ()=> save(true));
    });
    expenseTbl.querySelectorAll('input[data-act="exp-paid"]').forEach(el=>{
      el.addEventListener('change', ()=>{
        const x = findExp(el.dataset.id);
        if(x){ x.paid[el.dataset.month] = el.checked; save(); }
      });
    });

    // Copy buttons
    expenseTbl.querySelectorAll('button[data-copy]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const e = findExp(b.dataset.id); if(!e) return;
        copyExpenseFromActive(e, b.dataset.copy);
        save();
      });
    });

    // delete row
    expenseTbl.querySelectorAll('button[data-act="exp-del"]').forEach(el=>{
      el.addEventListener('click', ()=> deleteExpense(el.dataset.id));
    });
  }

  function isOverdue(exp, ym){
    if(!ym) return false;
    const [y,m] = ym.split('-').map(Number);
    const nowD = new Date();
    if(nowD < new Date(y, m-1, 1) || nowD > new Date(y, m-1, 31)) return false;
    return (nowD.getDate() > (exp.dueDay||1)) && !exp.paid[ym];
  }

  function sumAllIncome(){ return state.months.reduce((s,m)=> s + state.incomes.reduce((t,i)=> t+(+i.amounts[m]||0),0), 0); }
  function sumAllExpenses(){ return state.months.reduce((s,m)=> s + state.expenses.reduce((t,x)=> t+(+x.amounts[m]||0),0), 0); }

  function findExp(id){ return state.expenses.find(x=>x.id===id); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  function renderKPIs(){
    const m = state.activeMonth;
    const inc = state.incomes.reduce((s,i)=> s+(+i.amounts[m]||0), 0);
    const exp = state.expenses.reduce((s,x)=> s+(+x.amounts[m]||0), 0);
    const unpaid = state.expenses.reduce((s,x)=> s + (x.paid[m]?0:1), 0);
    $('#kpiIncome').textContent = moneyFmt(inc, state.currency);
    $('#kpiExpenses').textContent = moneyFmt(exp, state.currency);
    $('#kpiNet').textContent = moneyFmt(inc-exp, state.currency);
    $('#kpiUnpaid').textContent = unpaid;
  }

  function renderAll(){
    renderMonths();
    renderIncome();
    renderExpenses();
    renderKPIs();

    // After render, make sure all numeric inputs are sized correctly
    $$('#incomeTbl .inp.num, #expenseTbl .inp.num').forEach(autoSizeInput);
  }

  // initial
  renderAll();
})();
</script>
</body>
</html>
