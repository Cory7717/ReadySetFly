<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bill Book — Personal Finance (Local Only)</title>

<style>
  :root{
    /* Softer, readable light theme */
    --ink:#111827; --ink-soft:#6b7280; --bg:#ffffff;
    --card:#ffffff; --border:#e5e7eb; --ring:#93c5fd;
    --thead:#f5f7fb; --row-alt:#fafcff; --row-hover:#f0f6ff;

    --brand:#2563eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--ink);
    background:var(--bg); /* keep WHITE background outside tables */
  }

  .wrap{max-width:1200px; margin:16px auto; padding:0 12px}
  h1{font-size:clamp(20px,5vw,26px); color:var(--ink); margin:8px 0; text-align:center}
  .sub{text-align:center; color:var(--ink-soft); font-size:12px; margin-bottom:12px}

  /* Controls */
  .bar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px}
  .btn{
    appearance:none; border:1px solid var(--border); background:#f8fafc; color:#0f172a;
    padding:10px 12px; border-radius:12px; cursor:pointer; font-size:14px; flex-shrink:0
  }
  .btn:hover{background:#eef2f7}
  .btn.brand{background:linear-gradient(180deg,#3b82f6,#2563eb); color:#fff; border-color:#1e40af}
  .btn.ok{background:#e8f6ee; border-color:#b7e2c7; color:#065f46}
  .btn.bad{background:#fdecec; border-color:#f8c7c7; color:#7f1d1d}
  .btn.warn{background:#fff3e1; border-color:#fbd19f; color:#92400e}
  .btn.ghost{background:transparent}
  .pill{padding:6px 10px; border-radius:999px; font-size:12px; color:#0f172a; background:#f3f4f6; border:1px solid var(--border)}
  .inp{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
    background:#fff; color:#111827; font-size:14px
  }
  .inp:focus{outline:none; border-color:var(--ring); box-shadow:0 0 0 3px rgba(147,197,253,.35)}

  /* Layout */
  .grid{display:grid; gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}

  /* Cards */
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .section-title{font-weight:600; margin-bottom:6px}
  .note{color:var(--ink-soft); font-size:12px}

  /* Tables — softened for readability */
  .tbl{width:100%; border-collapse:separate; border-spacing:0; font-size:14px}
  .tbl th,.tbl td{padding:10px; color:#111827}
  .tbl th{
    position:sticky; top:0; z-index:2; background:var(--thead); font-size:12px; text-align:left;
    border-bottom:1px solid var(--border)
  }
  .tbl td{border-bottom:1px solid var(--border)}
  .tbl tr:nth-child(even) td{background:var(--row-alt)}
  .tbl tbody tr:hover td{background:var(--row-hover)}
  .tbl input{font-size:14px}
  .right{text-align:right}
  .center{text-align:center}

  /* Horizontal scroll for mobile */
  .scroll-x{overflow-x:auto; -webkit-overflow-scrolling:touch}

  /* KPI cards */
  .kpis{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px}
  .kpi{background:#f8fafc; border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center}
  .kpi .label{color:#6b7280; font-size:12px}
  .kpi .val{color:#0f172a; font-size:clamp(16px,5vw,20px); font-weight:700}

  /* Mobile-first */
  @media (max-width:900px){
    .grid.cols-2{grid-template-columns:1fr}
    .bar{justify-content:center}
    .wrap{padding:0 10px}
  }
  @media (max-width:600px){
    .btn{font-size:15px; padding:12px 14px}
    .inp{font-size:16px; padding:12px 14px}
    .tbl{font-size:15px}
    .tbl th,.tbl td{padding:12px}
    input[type=checkbox]{width:22px; height:22px}
    .pill{padding:8px 12px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Bill Book — Personal Finance (Local)</h1>
    <div class="sub">Data is saved in your browser’s <strong>localStorage</strong>. No servers. You can export/import JSON anytime.</div>

    <div class="bar">
      <button id="addMonthBtn" class="btn brand">+ Add Month</button>
      <button id="removeMonthBtn" class="btn ghost">Remove Last Month</button>
      <span class="pill" id="monthCount"></span>
      <span class="pill">Today: <span id="today"></span></span>
      <span class="pill">Active Month: <span id="activeMonthLbl"></span></span>
      <span class="pill">Autosave On</span>
      <div style="flex:1"></div>
      <button id="exportBtn" class="btn">Export JSON</button>
      <label class="btn ghost file">Import JSON <input id="importInput" type="file" accept="application/json" style="display:none"></label>
      <button id="resetBtn" class="btn bad">Reset (Clear Local)</button>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <div class="section-title">Months</div>
        <div id="monthsBar" class="bar" style="flex-wrap:wrap"></div>
        <div class="note">Tip: Click a month to make it the active month for quick-entry and due-date highlighting.</div>
      </div>
      <div class="card">
        <div class="section-title">Settings</div>
        <div class="bar">
          <label class="pill" style="display:flex;gap:8px;align-items:center;background:#f9fafb">
            <span>Hotel / Household Rooms (optional)</span>
            <input type="number" min="0" id="rooms" class="inp" style="width:120px">
          </label>
          <label class="pill" style="display:flex;gap:8px;align-items:center;background:#f9fafb">
            <span>Days in Active Month</span>
            <input type="number" min="28" max="31" id="daysInMonth" class="inp" style="width:90px">
          </label>
          <label class="pill" style="display:flex;gap:8px;align-items:center;background:#f9fafb">
            <span>Currency</span>
            <select id="currency" class="inp" style="width:120px">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="CAD">CAD</option>
              <option value="AUD">AUD</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:14px">
      <div class="card">
        <div class="section-title">Income</div>
        <div class="bar">
          <button id="addIncome" class="btn ok">+ Add Income Source</button>
        </div>
        <div class="squeeze scroll-x">
          <table class="tbl" id="incomeTbl"></table>
        </div>
      </div>
      <div class="card">
        <div class="section-title">Quick Totals (Active Month)</div>
        <div class="kpis">
          <div class="kpi"><div class="label">Income</div><div class="val" id="kpiIncome">$0</div></div>
          <div class="kpi"><div class="label">Expenses</div><div class="val" id="kpiExpenses">$0</div></div>
          <div class="kpi"><div class="label">Net</div><div class="val" id="kpiNet">$0</div></div>
          <div class="kpi"><div class="label">Unpaid Bills</div><div class="val" id="kpiUnpaid">0</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="section-title">Expenses</div>
      <div class="bar">
        <button id="addExpense" class="btn ok">+ Add Expense</button>
        <button id="markAllPaid" class="btn warn">Mark All Paid (Active Month)</button>
        <label class="pill" style="display:flex;gap:8px;align-items:center;background:#f9fafb">
          <span>Filter</span>
          <input id="filterTxt" class="inp" placeholder="Type to filter by name…" style="width:220px">
        </label>
      </div>
      <div class="squeeze scroll-x">
        <table class="tbl" id="expenseTbl"></table>
      </div>
      <div class="note" style="margin-top:8px">Overdue and unpaid items for the active month are highlighted.</div>
    </div>

  </div>

<script>
(function(){
  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtMonth = (ym) => {
    // ym: 'YYYY-MM'
    if(!ym) return '';
    const [y,m] = ym.split('-').map(Number);
    const d = new Date(y, m-1, 1);
    return d.toLocaleDateString(undefined,{month:'long', year:'numeric'});
  };
  const pad2 = n => String(n).padStart(2,'0');
  const ymOf = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  const money = (n,curr) => new Intl.NumberFormat(undefined,{style:'currency',currency:curr}).format(+n||0);
  const uid = () => Math.random().toString(36).slice(2,9);

  // ---------- State ----------
  const KEY = 'billbook.v1';
  function defaultState(){
    const now = new Date();
    const cur = ymOf(now);
    const prev = ymOf(new Date(now.getFullYear(), now.getMonth()-1, 1));
    const next = ymOf(new Date(now.getFullYear(), now.getMonth()+1, 1));
    return {
      currency: 'USD',
      months: [prev, cur, next],
      activeMonth: cur,
      rooms: 0,
      daysInMonth: new Date(now.getFullYear(), now.getMonth()+1, 0).getDate(),
      incomes: [
        {id: uid(), name: "Cory's Wages", amounts: {[prev]: 0, [cur]: 0, [next]: 0}},
        {id: uid(), name: "Amy's Wages",  amounts: {[prev]: 0, [cur]: 0, [next]: 0}}
      ],
      expenses: [
        {id: uid(), name: 'Rent/Mortgage', dueDay: 1,  amounts: {[prev]: 0,[cur]: 0,[next]: 0}, paid: {}},
        {id: uid(), name: 'Electric',      dueDay: 15, amounts: {[prev]: 0,[cur]: 0,[next]: 0}, paid: {}},
        {id: uid(), name: 'Internet',      dueDay: 20, amounts: {[prev]: 0,[cur]: 0,[next]: 0}, paid: {}}
      ]
    };
  }
  let state = load() || defaultState();

  // CHANGED: allow saving with or without re-render to fix single-character typing issue
  function save(render = true){
    localStorage.setItem(KEY, JSON.stringify(state));
    if(render) renderAll();
  }
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){ return null; } }
  function reset(){ localStorage.removeItem(KEY); state = defaultState(); renderAll(); }

  // ---------- DOM refs ----------
  const addMonthBtn = $('#addMonthBtn');
  const removeMonthBtn = $('#removeMonthBtn');
  const monthCount = $('#monthCount');
  const monthsBar = $('#monthsBar');
  const activeMonthLbl = $('#activeMonthLbl');
  const todayLbl = $('#today');
  const roomsInp = $('#rooms');
  const daysInMonthInp = $('#daysInMonth');
  const currencySel = $('#currency');
  const addIncomeBtn = $('#addIncome');
  const addExpenseBtn = $('#addExpense');
  const markAllPaidBtn = $('#markAllPaid');
  const filterTxt = $('#filterTxt');
  const incomeTbl = $('#incomeTbl');
  const expenseTbl = $('#expenseTbl');
  const exportBtn = $('#exportBtn');
  const importInput = $('#importInput');
  const resetBtn = $('#resetBtn');

  todayLbl.textContent = new Date().toLocaleDateString();

  // ---------- Month mgmt ----------
  addMonthBtn.addEventListener('click', ()=>{
    const d = prompt('Add month (YYYY-MM), e.g., 2025-10');
    if(!d) return;
    if(!/^\d{4}-\d{2}$/.test(d)) return alert('Format must be YYYY-MM');
    if(state.months.includes(d)) return alert('Month already exists.');
    state.months.push(d);
    // initialize values for new month
    state.incomes.forEach(i=> i.amounts[d] = i.amounts[d] ?? 0);
    state.expenses.forEach(x=> {
      x.amounts[d] = x.amounts[d] ?? 0;
      x.paid[d] = x.paid[d] ?? false;
    });
    save();
  });
  removeMonthBtn.addEventListener('click', ()=>{
    if(!state.months.length) return;
    const last = state.months[state.months.length-1];
    if(!confirm(`Remove month ${fmtMonth(last)}?`)) return;
    state.months.pop();
    // keep data but it won’t show; or purge? we’ll keep to avoid accidental loss
    if(state.activeMonth===last) state.activeMonth = state.months[state.months.length-1]||'';
    save();
  });

  function setActiveMonth(m){ state.activeMonth=m; save(); }

  // ---------- Income ----------
  addIncomeBtn.addEventListener('click', ()=>{
    state.incomes.push({id:uid(), name:'New Income', amounts:{}});
    // fill per month
    state.months.forEach(m=>{ state.incomes[state.incomes.length-1].amounts[m]=0; });
    save();
  });
  function deleteIncome(id){ state.incomes = state.incomes.filter(i=>i.id!==id); save(); }

  // ---------- Expenses ----------
  addExpenseBtn.addEventListener('click', ()=>{
    const d = {id:uid(), name:'New Expense', dueDay: 1, amounts:{}, paid:{}};
    state.months.forEach(m=>{ d.amounts[m]=0; d.paid[m]=false; });
    state.expenses.push(d); save();
  });
  function deleteExpense(id){ state.expenses = state.expenses.filter(x=>x.id!==id); save(); }
  function markAllPaidActive(){ state.expenses.forEach(x=> x.paid[state.activeMonth]=true); save(); }

  markAllPaidBtn.addEventListener('click', ()=>{ if(confirm('Mark all expenses paid for the active month?')) markAllPaidActive(); });
  filterTxt.addEventListener('input', renderExpenses);

  // ---------- Export / Import / Reset ----------
  exportBtn.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='billbook.json';
    a.click();
  });
  importInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      const text = await f.text();
      const obj = JSON.parse(text);
      if(!obj || !obj.months) throw new Error('Invalid file');
      state = obj; save();
    }catch(err){ alert('Import failed: '+err.message); }
    importInput.value='';
  });
  resetBtn.addEventListener('click', ()=>{
    if(confirm('Clear all local data and reset?')) reset();
  });

  // ---------- Rendering ----------
  function renderMonths(){
    monthsBar.innerHTML='';
    state.months.forEach(m=>{
      const b = document.createElement('button');
      b.className = 'pill month-chip' + (m===state.activeMonth?' active':'');
      b.textContent = fmtMonth(m);
      b.title = m;
      b.addEventListener('click', ()=> setActiveMonth(m));
      monthsBar.appendChild(b);
    });
    monthCount.textContent = `${state.months.length} month(s)`;
    activeMonthLbl.textContent = fmtMonth(state.activeMonth||'');
  }

  roomsInp.value = state.rooms||0;
  roomsInp.addEventListener('change', ()=>{ state.rooms = +roomsInp.value||0; save(); });
  daysInMonthInp.value = state.daysInMonth||30;
  daysInMonthInp.addEventListener('change', ()=>{ state.daysInMonth = +daysInMonthInp.value||30; save(); });
  currencySel.value = state.currency;
  currencySel.addEventListener('change', ()=>{ state.currency = currencySel.value; renderAll(); save(); });

  function renderIncome(){
    const months = state.months;
    let html = '';
    html += '<thead><tr>'+
            '<th style="min-width:220px">Source</th>'+
            months.map(m=>`<th class="right">${fmtMonth(m)}<div class="small muted">Amount</div></th>`).join('')+
            '<th class="right">Total</th><th class="center">Actions</th>'+
            '</tr></thead>';
    html += '<tbody>';
    for(const inc of state.incomes){
      const rowTotal = months.reduce((s,m)=> s + (+inc.amounts[m]||0), 0);
      html += `<tr>
        <td><input class="inp" value="${escapeHtml(inc.name)}" data-act="income-name" data-id="${inc.id}"></td>
        ${months.map(m=>`
          <td class="right"><input class="inp" type="number" step="0.01" value="${+inc.amounts[m]||0}" data-act="income-amt" data-id="${inc.id}" data-month="${m}"></td>
        `).join('')}
        <td class="right"><span>${money(rowTotal,state.currency)}</span></td>
        <td class="center">
          <div class="row-controls">
            <button class="btn ghost small" data-act="income-del" data-id="${inc.id}">Delete</button>
          </div>
        </td>
      </tr>`;
    }
    html += '</tbody>';
    // footer totals per month
    html += '<tfoot><tr><td class="right">Monthly Total</td>'+
            months.map(m=>`<td class="right">${money(state.incomes.reduce((s,i)=> s+(+i.amounts[m]||0),0), state.currency)}</td>`).join('')+
            `<td class="right">${money(sumAllIncome(), state.currency)}</td><td></td></tr></tfoot>`;

    incomeTbl.innerHTML = html;

    // NOTE: for name fields, save WITHOUT re-render while typing; re-render on blur
    incomeTbl.querySelectorAll('input[data-act="income-name"]').forEach(el=>{
      el.addEventListener('input', ()=>{
        const i = state.incomes.find(x=>x.id===el.dataset.id);
        if(i){ i.name = el.value; save(false); } // <-- key fix
      });
      el.addEventListener('blur', ()=> save(true)); // re-render once finished typing
    });
    incomeTbl.querySelectorAll('input[data-act="income-amt"]').forEach(el=>{
      el.addEventListener('change', ()=>{
        const i = state.incomes.find(x=>x.id===el.dataset.id);
        if(i){ i.amounts[el.dataset.month] = +el.value||0; save(); }
      });
    });
    incomeTbl.querySelectorAll('button[data-act="income-del"]').forEach(el=>{
      el.addEventListener('click', ()=> deleteIncome(el.dataset.id));
    });
  }

  function renderExpenses(){
    const months = state.months;
    const f = (filterTxt.value||'').toLowerCase();
    let html = '';
    html += '<thead><tr>'+
            '<th style="min-width:220px">Expense</th>'+
            '<th class="center">Due Day</th>'+
            months.map(m=>`<th class="right">${fmtMonth(m)}<div class="small muted">Amount</div></th>`).join('')+
            months.map(m=>`<th class="center">${fmtMonth(m)}<div class="small muted">Paid</div></th>`).join('')+
            '<th class="right">Row Total</th>'+
            '<th class="center">Adj %</th>'+
            '<th class="center">Actions</th>'+
            '</tr></thead>';
    html += '<tbody>';

    for(const ex of state.expenses){
      if(f && !ex.name.toLowerCase().includes(f)) continue;
      const rowTotal = months.reduce((s,m)=> s + (+ex.amounts[m]||0), 0);
      const overdue = isOverdue(ex, state.activeMonth);
      html += `<tr${overdue ? ' style="outline:2px solid rgba(220,38,38,.15); outline-offset:-2px"' : ''}>
        <td${overdue? ' style="color:#991b1b"':''}><input class="inp" value="${escapeHtml(ex.name)}" data-act="exp-name" data-id="${ex.id}"></td>
        <td class="center"><input class="inp" type="number" min="1" max="31" value="${+ex.dueDay||1}" data-act="exp-due" data-id="${ex.id}" style="width:70px"></td>
        ${months.map(m=>`<td class="right"><input class="inp" type="number" step="0.01" value="${+ex.amounts[m]||0}" data-act="exp-amt" data-id="${ex.id}" data-month="${m}"></td>`).join('')}
        ${months.map(m=>`<td class="center"><input type="checkbox" ${ex.paid[m]? 'checked':''} data-act="exp-paid" data-id="${ex.id}" data-month="${m}"></td>`).join('')}
        <td class="right">${money(rowTotal,state.currency)}</td>
        <td class="center">
          <div class="row-controls">
            <input class="inp" type="number" step="0.1" placeholder="%" style="width:80px" data-act="exp-pct" data-id="${ex.id}">
            <button class="btn small" data-act="exp-apply" data-id="${ex.id}">Apply</button>
          </div>
        </td>
        <td class="center">
          <div class="row-controls">
            <button class="btn ghost small" data-act="exp-copy-active" data-id="${ex.id}">Copy → Active</button>
            <button class="btn ghost small" data-act="exp-del" data-id="${ex.id}">Delete</button>
          </div>
        </td>
      </tr>`;
    }
    html += '</tbody>';

    // footer totals
    html += '<tfoot><tr><td class="right" colspan="2">Monthly Total</td>'+
            months.map(m=>`<td class="right">${money(state.expenses.reduce((s,x)=> s+(+x.amounts[m]||0),0), state.currency)}</td>`).join('')+
            months.map(m=>`<td class="center">${state.expenses.reduce((s,x)=> s + (x.paid[m]?1:0),0)}</td>`).join('')+
            `<td class="right">${money(sumAllExpenses(), state.currency)}</td>`+
            '<td></td><td></td></tr></tfoot>';

    expenseTbl.innerHTML = html;

    // CHANGED: name fields save quietly on input; re-render on blur (fixes "one character" problem)
    expenseTbl.querySelectorAll('input[data-act="exp-name"]').forEach(el=>{
      el.addEventListener('input', ()=>{
        const x = findExp(el.dataset.id);
        if(x){ x.name = el.value; save(false); } // don't re-render while typing
      });
      el.addEventListener('blur', ()=> save(true)); // re-render after edit finishes
    });

    expenseTbl.querySelectorAll('input[data-act="exp-due"]').forEach(el=>{
      el.addEventListener('change', ()=>{
        const x = findExp(el.dataset.id);
        if(x){ x.dueDay = clamp(+el.value,1,31); el.value = x.dueDay; save(); }
      });
    });
    expenseTbl.querySelectorAll('input[data-act="exp-amt"]').forEach(el=>{
      el.addEventListener('change', ()=>{
        const x = findExp(el.dataset.id);
        if(x){ x.amounts[el.dataset.month] = +el.value||0; save(); }
      });
    });
    expenseTbl.querySelectorAll('input[data-act="exp-paid"]').forEach(el=>{
      el.addEventListener('change', ()=>{
        const x = findExp(el.dataset.id);
        if(x){ x.paid[el.dataset.month] = el.checked; save(); }
      });
    });
    expenseTbl.querySelectorAll('button[data-act="exp-apply"]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const x = findExp(el.dataset.id); if(!x) return;
        const pctEl = expenseTbl.querySelector(`input[data-act="exp-pct"][data-id="${x.id}"]`);
        const pct = +pctEl.value||0; adjustRowByPct(x, pct); pctEl.value=''; save();
      });
    });
    expenseTbl.querySelectorAll('button[data-act="exp-copy-active"]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const x = findExp(el.dataset.id); if(!x) return;
        const m = state.activeMonth; const val = +x.amounts[m]||0;
        state.months.forEach(mm=>{ x.amounts[mm]=val; }); save();
      });
    });
    expenseTbl.querySelectorAll('button[data-act="exp-del"]').forEach(el=>{
      el.addEventListener('click', ()=> deleteExpense(el.dataset.id));
    });
  }

  function adjustRowByPct(exp, pct){
    // pct can be + or - (e.g., 5 or -5)
    const f = 1 + (pct/100);
    state.months.forEach(m=>{ exp.amounts[m] = round2((+exp.amounts[m]||0)*f); });
  }

  function isOverdue(exp, ym){
    if(!ym) return false;
    const [y,m] = ym.split('-').map(Number);
    const now = new Date();
    if(now < new Date(y, m-1, 1) || now > new Date(y, m-1, 31)) return false; // only flag for current calendar month
    return (now.getDate() > (exp.dueDay||1)) && !exp.paid[ym];
  }

  function sumAllIncome(){ return state.months.reduce((s,m)=> s + state.incomes.reduce((t,i)=> t+(+i.amounts[m]||0),0), 0); }
  function sumAllExpenses(){ return state.months.reduce((s,m)=> s + state.expenses.reduce((t,x)=> t+(+x.amounts[m]||0),0), 0); }

  function findExp(id){ return state.expenses.find(x=>x.id===id); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function round2(n){ return Math.round(n*100)/100; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  function renderKPIs(){
    const m = state.activeMonth;
    const inc = state.incomes.reduce((s,i)=> s+(+i.amounts[m]||0), 0);
    const exp = state.expenses.reduce((s,x)=> s+(+x.amounts[m]||0), 0);
    const unpaid = state.expenses.reduce((s,x)=> s + (x.paid[m]?0:1), 0);
    $('#kpiIncome').textContent = money(inc, state.currency);
    $('#kpiExpenses').textContent = money(exp, state.currency);
    $('#kpiNet').textContent = money(inc-exp, state.currency);
    $('#kpiUnpaid').textContent = unpaid;
  }

  function renderAll(){
    renderMonths();
    renderIncome();
    renderExpenses();
    renderKPIs();
  }

  // initial
  renderAll();
})();
</script>
</body>
</html>
