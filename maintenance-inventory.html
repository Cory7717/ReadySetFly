<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Maintenance & Inventory Checklist (IndexedDB)</title>
<!-- jsPDF + AutoTable for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg1:#667eea;--bg2:#764ba2;--panelTint:rgba(255,255,255,.95);--ink:#2c3e50;--inkSoft:#7f8c8d;--brand1:#3498db;--brand2:#2980b9;--dark1:#2c3e50;--dark2:#34495e;--posBg:#d1edcc;--pos:#155724;--warnBg:#fff3cd;--warn:#856404;--negBg:#f8d7da;--neg:#721c24;--grid:#e0e0e0}
html,body{overscroll-behavior-y:contain}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;padding:20px}
.container{max-width:1300px;margin:0 auto;background:var(--panelTint);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);backdrop-filter:blur(10px);overflow:hidden}
.header{background:linear-gradient(135deg,var(--dark1),var(--brand1));color:#fff;padding:24px;text-align:center}
.header h1{font-size:2em;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.25)}
.toolbar{position:sticky;top:0;z-index:5;background:#f9fbff;border-bottom:1px solid #e9edf3;padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.btn{border:1px solid #dbe3ee;background:#fff;color:#1f2d3d;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;transition:.2s transform,.2s box-shadow;min-height:40px}
.btn.primary{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;border:none}
.btn.danger{background:#fff;border-color:#f1c1c1;color:#b10d0d}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.08)}
input[type="file"]{display:none}
.pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:#2c3e50;padding:6px 10px;background:#eef4ff;border:1px solid #d7e2ff;border-radius:999px}
.content{padding:22px}
.section{margin-bottom:22px;background:#fff;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,.08);overflow:hidden}
.section-header{background:linear-gradient(135deg,#34495e,#2c3e50);color:#fff;padding:14px 16px;font-weight:800;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.notice{padding:10px 14px;background:#fff9e6;border-top:1px solid #f2e2b8;color:#7a5b00}
.notice.critical{background:#ffe9e9;border-top-color:#f3b0b0;color:#861b1b}
.field-row{display:flex;flex-wrap:wrap;gap:12px;padding:14px 16px;background:#f7faff;border-bottom:1px solid #edf2f7}
.field-row label{font-size:13px;color:#34495e}
.field-row input,.field-row select,.field-row textarea{padding:10px;border:1px solid #dbe3ee;border-radius:8px;background:#fff}
.field{display:flex;flex-direction:column;gap:6px;min-width:200px}
.table-container{overflow:auto;padding:14px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:9px 8px;text-align:left;border:1px solid var(--grid);white-space:nowrap;vertical-align:top}
th{background:linear-gradient(135deg,#f8f9fa,#e9ecef);font-weight:800;color:#2c3e50;text-transform:uppercase;font-size:11px;letter-spacing:.5px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#f5f7fb;color: var(--ink);}
.status-ok{background:var(--posBg);color:var(--pos);border-color:#b8e0b2}
.status-attn{background:var(--warnBg);color:#856404;border-color:#f2df8a}
.status-bad{background:var(--negBg);color:#721c24;border-color:#f4b6bc}
.thumb{width:58px;height:58px;object-fit:cover;border-radius:8px;border:1px solid #e3e8f0}
.photo-stack{display:flex;gap:6px;flex-wrap:wrap}
.actions{display:flex;gap:6px;flex-wrap:wrap}
textarea.notes{min-width:220px;min-height:44px}
.small{font-size:12px;color:#7f8c8d}
hr.sep{border:none;border-top:1px dashed #e5e7eb;margin:6px 0}
.row-missing-photos{box-shadow:inset 0 0 0 2px #f3b0b0;background:#fff6f6}
.req-chip{display:inline-block;margin-top:6px;font-size:12px;color:#861b1b;background:#ffe1e1;border:1px solid #f3b0b0;border-radius:999px;padding:2px 8px}
.add-row td{background:#f9fbff;border-top:none;border-bottom:1px solid var(--grid)}
.add-row .btn{width:100%}
.table-footer{display:flex;justify-content:space-between;gap:10px;padding:10px 14px;border-top:1px solid #edf2f7;background:#fafcff}
.footer-actions{display:flex;gap:10px;flex-wrap:wrap}

/* Tablet / touch friendliness */
@media (max-width: 900px){
  .field{min-width:100%}
  .btn{padding:12px 16px}
  th,td{min-width:100px}
}
@media (pointer:coarse){
  .btn{min-height:44px}
  select,input,textarea{font-size:16px} /* prevent iOS zoom */
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ðŸ§° Maintenance & Equipment Inventory</h1>
    <p>Photo-verified inventory with models/serials, maintenance dates, and exportable PDF.</p>
  </div>

  <div class="toolbar">
    <button class="btn" id="loadBtn">Load</button>
    <button class="btn" id="exportJsonBtn">Export (.json)</button>
    <label class="btn" for="importJson">Import (.json)</label><input id="importJson" type="file" accept=".json"/>
    <button class="btn" id="exportBaselineBtn">Export Baseline (.json)</button>
    <label class="btn" for="importBaseline">Import Baseline (.json)</label><input id="importBaseline" type="file" accept=".json"/>
    <label class="pill"><input id="autoSave" type="checkbox" checked/> Auto-save</label>
    <button class="btn" id="submitBtn" title="Validate & archive this inventory">Submit Inventory</button>
    <button class="btn" id="pdfBtn">Download Inventory (PDF)</button>
    <button class="btn primary" id="addItemBtn">+ Add Item</button>
  </div>

  <div class="content">
    <div class="section">
      <div class="section-header">
        <span>ðŸ§¾ Inventory Session Details</span>
        <div class="actions" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span class="badge" id="totalValueChip">Total Estimated Value: $0</span>
          <button class="btn" id="bulkVerifyBtn" title="Mark all items Verified">Mark All Verified</button>
          <button class="btn danger" id="clearAllBtn" title="Remove everything">Reset All</button>
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Property Identifier</label>
          <input type="text" id="propertyId" placeholder="e.g., Fairfield Austin Domain"/>
        </div>
        <div class="field">
          <label>Inventory Date</label>
          <input type="date" id="invDate" placeholder="YYYY-MM-DD"/>
        </div>
        <div class="field">
          <label>Conducted By</label>
          <input type="text" id="conductedBy" placeholder="Full name"/>
        </div>
        <div class="field">
          <label>Location / Property</label>
          <input type="text" id="property" placeholder="e.g., Main Hotel â€“ North Wing"/>
        </div>
        <div class="field" style="min-width:320px">
          <label>Notes (overall)</label>
          <textarea id="overallNotes" rows="2" placeholder="General comments for this inventory..."></textarea>
        </div>
      </div>
      <div id="submitNotice" class="notice critical" style="display:none"></div>
      <div id="changeNotice" class="notice" style="display:none"></div>
    </div>

    <div class="section">
      <div class="section-header">
        <span>ðŸ”Ž Filter & Summary</span>
        <span class="small" id="summaryChip">0 items</span>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Search</label>
          <input type="text" id="searchTxt" placeholder="Search name/model/serial/location..." />
        </div>
        <div class="field">
          <label>Condition</label>
          <select id="fCondition">
            <option value="">All</option>
            <option>Excellent</</option>
            <option>Good</option>
            <option>Fair</option>
            <option>Needs Repair</option>
            <option>Out of Service</option>
          </select>
        </div>
        <div class="field">
          <label>Status</label>
          <select id="fStatus">
            <option value="">All</option>
            <option>Active</option>
            <option>Spare</option>
            <option>Retired</option>
          </select>
        </div>
        <div class="field">
          <label>Location</label>
          <input type="text" id="fLocation" placeholder="Filter by location"/>
        </div>
        <div class="field" style="align-self:end">
          <button class="btn" id="clearFiltersBtn">Clear Filters</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <span>ðŸ“‹ Inventory Items</span>
        <span class="small">Photos are required to submit. Data persists on this device.</span>
      </div>
      <div class="table-container">
        <table id="invTable">
          <thead>
            <tr>
              <th>Verified</th>
              <th>Photos</th>
              <th>Item Name</th>
              <th>Location</th>
              <th>Model</th>
              <th>Serial</th>
              <th>Qty</th>
              <th>Est. Value</th>
              <th>Condition</th>
              <th>Status</th>
              <th>Last Service</th>
              <th>Next Due</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="invBody"></tbody>
        </table>
      </div>
      <div class="table-footer">
        <div class="footer-actions">
          <button class="btn primary" id="addItemBtnFooter">+ Add Item</button>
        </div>
        <div class="footer-actions">
          <button class="btn" id="saveBtn">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){

  /* ----------------- Polyfills & Setup ----------------- */

  // Element.closest polyfill
  if (!Element.prototype.closest) {
    Element.prototype.closest = function(s){
      var el=this;
      if(!document.documentElement.contains(el)) return null;
      do {
        if (el.matches && el.matches(s)) return el;
        el = el.parentElement || el.parentNode;
      } while (el && el.nodeType===1);
      return null;
    };
  }

  // crypto.randomUUID polyfill
  (function ensureUUID(){
    try{
      if(!window.crypto) window.crypto = {};
      if(typeof window.crypto.randomUUID !== 'function'){
        var rnd = function(){ return (window.crypto.getRandomValues ? window.crypto.getRandomValues(new Uint8Array(1))[0] : Math.floor(Math.random()*256)); };
        var hex = function(n){ var s=n.toString(16); return s.length===1?'0'+s:s; };
        window.crypto.randomUUID = function(){
          var b = new Uint8Array(16);
          if(window.crypto.getRandomValues) window.crypto.getRandomValues(b);
          else { for(var i=0;i<16;i++) b[i]=rnd(); }
          b[6] = (b[6] & 0x0f) | 0x40; // v4
          b[8] = (b[8] & 0x3f) | 0x80; // variant
          var h=''; for(var j=0;j<16;j++) h+=hex(b[j]);
          return h.slice(0,8)+'-'+h.slice(8,12)+'-'+h.slice(12,16)+'-'+h.slice(16,20)+'-'+h.slice(20);
        };
      }
    }catch(e){
      window.crypto = window.crypto || {};
      window.crypto.randomUUID = function(){
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){
          var r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
        });
      };
    }
  })();

  // Request durable storage to reduce eviction
  if (navigator.storage && navigator.storage.persist) {
    navigator.storage.persist().then(function(granted){
      console.log('Persistent storage:', granted ? 'granted' : 'not granted');
    });
  }

  /* ----------------- Tiny Utilities ----------------- */

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ var list=(root||document).querySelectorAll(sel); return Array.prototype.slice.call(list); }

  function debounce(fn, wait){
    var t=null;
    return function(){
      var ctx=this, args=arguments;
      if(t) clearTimeout(t);
      t=setTimeout(function(){ fn.apply(ctx,args); }, wait);
    };
  }

  // small pool mapper for async work (e.g., images)
  async function mapWithLimit(arr, limit, mapper){
    const res = new Array(arr.length);
    let i = 0, active = 0;
    return new Promise((resolve) => {
      function next(){
        if (i >= arr.length && active === 0) return resolve(res);
        while (active < limit && i < arr.length){
          const idx = i++, p = Promise.resolve().then(() => mapper(arr[idx], idx));
          active++;
          p.then(v => res[idx]=v).finally(()=>{ active--; next(); });
        }
      }
      next();
    });
  }

  var STORAGE_KEY='maintInv_v3_working';           // bumped schema
  var STORAGE_LAST='maintInv_v3_lastSubmitted';
  var STORAGE_HISTORY='maintInv_v3_submissions';

  var items = [];               // each item has photoIds[]
  var objectUrlCache = {};      // photoId -> objectURL (to revoke)
  var AUTO_SAVE_DELAY = 900;

  const MAX_GALLERY_PHOTOS = 400;   // optional cap for very large PDFs

  function defaultItem(){
    return {
      id: window.crypto.randomUUID(),
      name:'', location:'', model:'', serial:'', qty:1,
      estimatedValue: 0,
      condition:'Good', status:'Active',
      lastService:'', nextDue:'', notes:'',
      verified:false, photoIds:[]
    };
  }

  function currency(n){
    var v=Number(n)||0;
    try{ return v.toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}); }
    catch(e){ return '$'+v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,','); }
  }

  var toastEl;
  function flash(msg){
    if(!toastEl){
      toastEl=document.createElement('div');
      var st = toastEl.style;
      st.position='fixed'; st.bottom='18px'; st.left='50%'; st.transform='translateX(-50%)';
      st.padding='10px 14px'; st.background='rgba(44,62,80,.95)'; st.color='#fff';
      st.borderRadius='10px'; st.boxShadow='0 8px 20px rgba(0,0,0,.2)'; st.zIndex='9999';
      st.transition='opacity .25s ease';
      document.body.appendChild(toastEl);
    }
    toastEl.textContent=msg; toastEl.style.opacity='1';
    setTimeout(function(){ toastEl.style.opacity='0'; }, 1400);
  }

  function showCritical(msg){
    var box = qs('#submitNotice'); if (!box) return;
    box.style.display='block'; box.textContent = msg;
  }
  function hideCritical(){
    var box = qs('#submitNotice'); if (!box) return;
    box.style.display='none';
  }

  function workingPayload(){
    return {
      schemaVersion: 3,
      meta:{
        propertyId: (qs('#propertyId') && qs('#propertyId').value) || '',
        invDate: (qs('#invDate') && qs('#invDate').value) || '',
        conductedBy: (qs('#conductedBy') && qs('#conductedBy').value) || '',
        property: (qs('#property') && qs('#property').value) || '',
        overallNotes: (qs('#overallNotes') && qs('#overallNotes').value) || ''
      },
      items: items
    };
  }

  // Rolling backups (last 5)
  function checkpoint(){
    try{
      var raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      var key = 'maintInv_v3_checkpoint_' + Date.now();
      localStorage.setItem(key, raw);
      var keys = [];
      for (var i=0;i<localStorage.length;i++){
        var k = localStorage.key(i);
        if(/^maintInv_v3_checkpoint_/.test(k)) keys.push(k);
      }
      keys.sort();
      while(keys.length > 5){
        localStorage.removeItem(keys.shift());
      }
    }catch(e){ /* ignore quota here */ }
  }

  var saveLocal = debounce(function(show){
    if (typeof show === 'undefined') show = true;
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(workingPayload()));
      if(show) flash('Saved.');
      hideCritical();
    }catch(e){
      console.error('Save error', e);
      showCritical('Storage quota reached for metadata. Please Export (.json) now, or remove some items. Photos are safe in IndexedDB.');
      if(show) flash('Save failed.');
    }
  }, AUTO_SAVE_DELAY);

  function saveLocalImmediate(show){
    if (typeof show === 'undefined') show = true;
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(workingPayload()));
      if(show) flash('Saved.');
      hideCritical();
    }catch(e){
      console.error('Save error', e);
      showCritical('Storage quota reached for metadata. Please Export (.json) now, or remove some items. Photos are safe in IndexedDB.');
      if(show) flash('Save failed.');
    }
  }

  function loadLocal(){
    var raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ flash('Nothing saved on this device yet.'); render(); updateChangeNotice(); return; }
    try{
      var data = JSON.parse(raw);
      var meta = data && data.meta ? data.meta : {};
      if(qs('#propertyId')) qs('#propertyId').value = meta.propertyId || '';
      if(qs('#invDate')) qs('#invDate').value = meta.invDate || '';
      if(qs('#conductedBy')) qs('#conductedBy').value = meta.conductedBy || '';
      if(qs('#property')) qs('#property').value = meta.property || '';
      if(qs('#overallNotes')) qs('#overallNotes').value = meta.overallNotes || '';
      items = (data && data.items && data.items.length) ? data.items : [];
      // normalize
      for (var i=0;i<items.length;i++){
        if (typeof items[i].estimatedValue === 'undefined') items[i].estimatedValue = 0;
        if (!items[i].photoIds) items[i].photoIds = [];
      }
      render(); updateChangeNotice(); flash('Loaded.');
    }catch(e){
      console.error(e); flash('Load failed.');
    }
  }

  function getLastSubmitted(){
    var raw = localStorage.getItem(STORAGE_LAST);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }

  function getHistory(){
    try { return JSON.parse(localStorage.getItem(STORAGE_HISTORY)||'[]'); }
    catch(_) { return []; }
  }
  function pushHistory(snapshot){
    var list = getHistory();
    list.push(snapshot);
    if (list.length > 20) list = list.slice(-20); // keep last 20
    localStorage.setItem(STORAGE_HISTORY, JSON.stringify(list));
  }

  function setLastSubmitted(payload){
    const snap = {
      submittedAt: new Date().toISOString(),
      meta: payload.meta,
      items: payload.items
    };
    localStorage.setItem(STORAGE_LAST, JSON.stringify(snap));
    pushHistory(snap);
  }

  function exportJSON(){
    saveLocalImmediate(false);
    checkpoint();
    var raw = localStorage.getItem(STORAGE_KEY) || '{}';
    var blob=new Blob([raw],{type:'application/json'});
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    var dateStr = (qs('#invDate') && qs('#invDate').value) ? qs('#invDate').value : (new Date().toISOString().slice(0,10));
    a.download='inventory_'+dateStr+'.json'; document.body.appendChild(a); a.click(); a.remove();
  }

  function importJSON(file){
    var r=new FileReader();
    r.onload=function(e){
      try{
        localStorage.setItem(STORAGE_KEY, e.target.result);
        loadLocal();
        flash('Imported (metadata). Note: photos must already be on this device.');
      }catch(err){ console.error(err); flash('Import failed.'); }
    };
    r.readAsText(file);
  }

  function exportBaseline(){
    const snap = getLastSubmitted();
    if(!snap){ flash('No baseline to export.'); return; }
    const blob = new Blob([JSON.stringify(snap)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const dateStr = (snap.meta && snap.meta.invDate) ? snap.meta.invDate : new Date(snap.submittedAt).toISOString().slice(0,10);
    a.download = 'inventory_baseline_'+dateStr+'.json';
    document.body.appendChild(a); a.click(); a.remove();
  }

  function importBaseline(file){
    var r=new FileReader();
    r.onload=function(e){
      try{
        const snap=JSON.parse(e.target.result);
        if(!snap || !Array.isArray(snap.items)) throw new Error('Invalid baseline');
        localStorage.setItem(STORAGE_LAST, JSON.stringify(snap));
        pushHistory(snap);
        updateChangeNotice();
        flash('Baseline imported.');
      }catch(err){ console.error(err); flash('Import baseline failed.'); }
    };
    r.readAsText(file);
  }

  function updateTotalValueChip(){
    var chip = qs('#totalValueChip');
    if(!chip) return;
    var total = 0;
    for(var i=0;i<items.length;i++){
      var it = items[i];
      total += (Number(it.estimatedValue)||0) * (Number(it.qty)||0);
    }
    chip.textContent = 'Total Estimated Value: ' + currency(total);
  }

  function addItem(prefill){
    var it = defaultItem();
    if (prefill){
      for (var k in prefill) if (prefill.hasOwnProperty(k)) it[k]=prefill[k];
    }
    items.push(it);
    render();
    if(qs('#autoSave') && qs('#autoSave').checked){ saveLocal(false); checkpoint(); }
    flash('Item added.');
  }

  function addItemAfterId(id){
    var idx = -1;
    for(var i=0;i<items.length;i++){ if(items[i].id===id){ idx=i; break; } }
    if(idx<0){ addItem(); return; }
    var it = defaultItem();
    items.splice(idx+1, 0, it);
    render();
    setTimeout(function(){
      var el = qs('[data-bind="'+it.id+':name"]');
      if (el && el.scrollIntoView) el.scrollIntoView({behavior:'smooth', block:'center'});
      if (el && el.focus) el.focus();
    },0);
    if(qs('#autoSave') && qs('#autoSave').checked){ saveLocal(false); checkpoint(); }
    flash('Item inserted.');
  }

  function removeItem(id){
    if(!confirm('Remove this item?')) return;
    var next=[]; for(var i=0;i<items.length;i++){ if(items[i].id!==id) next.push(items[i]); }
    items = next;
    render();
    if(qs('#autoSave') && qs('#autoSave').checked){ saveLocal(false); checkpoint(); }
    flash('Item removed.');
  }

  function conditionBadge(cond){
    if(cond==='Excellent' || cond==='Good') return 'badge status-ok';
    if(cond==='Fair') return 'badge status-attn';
    return 'badge status-bad';
  }

  /* ----------------- IndexedDB: photos store ----------------- */

  function openDB(){
    return new Promise(function(res, rej){
      var req = indexedDB.open('maintInvDB', 1);
      req.onupgradeneeded = function(e){
        var db = e.target.result;
        if(!db.objectStoreNames.contains('photos')){
          db.createObjectStore('photos'); // key: photoId, value: Blob
        }
      };
      req.onsuccess = function(e){ res(e.target.result); };
      req.onerror   = function(e){ rej(e.target.error); };
    });
  }

  function idbSavePhoto(photoId, blob){
    return openDB().then(function(db){
      return new Promise(function(res, rej){
        var tx = db.transaction('photos','readwrite');
        tx.objectStore('photos').put(blob, photoId);
        tx.oncomplete = function(){ res(true); };
        tx.onerror = function(e){ rej(e.target.error); };
      });
    });
  }

  function idbGetPhotoBlob(photoId){
    return openDB().then(function(db){
      return new Promise(function(res, rej){
        var tx = db.transaction('photos','readonly');
        var req = tx.objectStore('photos').get(photoId);
        req.onsuccess = function(){
          res(req.result || null);
        };
        req.onerror = function(e){ rej(e.target.error); };
      });
    });
  }

  function idbDeletePhoto(photoId){
    return openDB().then(function(db){
      return new Promise(function(res, rej){
        var tx = db.transaction('photos','readwrite');
        tx.objectStore('photos').delete(photoId);
        tx.oncomplete = function(){ res(true); };
        tx.onerror = function(e){ rej(e.target.error); };
      });
    });
  }

  function wipeAllPhotos(){
    return openDB().then(db => new Promise((res, rej)=>{
      var tx = db.transaction('photos','readwrite');
      var store = tx.objectStore('photos');
      var req = store.clear();
      req.onsuccess = function(){ res(true); };
      req.onerror = function(e){ rej(e.target.error); };
    }));
  }

  // Object URL cache helpers
  function revokeObjectURL(photoId){
    var url = objectUrlCache[photoId];
    if (url){ URL.revokeObjectURL(url); delete objectUrlCache[photoId]; }
  }
  function getObjectURLForPhoto(photoId){
    // returns Promise<string|null>
    if (objectUrlCache[photoId]) return Promise.resolve(objectUrlCache[photoId]);
    return idbGetPhotoBlob(photoId).then(function(blob){
      if(!blob) return null;
      var url = URL.createObjectURL(blob);
      objectUrlCache[photoId] = url;
      return url;
    });
  }

  /* ----------------- Legacy Migration (v2 -> v3) + Smart Load ----------------- */

  // base64 dataURL -> Blob
  function dataURLToBlob(durl){
    try{
      var parts = durl.split(',');
      var mimeMatch = parts[0].match(/:(.*?);/);
      var mime = (mimeMatch && mimeMatch[1]) || 'image/jpeg';
      var bin = atob(parts[1]||'');
      var arr = new Uint8Array(bin.length);
      for (var i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
      return new Blob([arr], {type:mime});
    }catch(e){ return null; }
  }

  async function migrateV2PayloadToV3(payloadV2){
    if (!payloadV2 || !Array.isArray(payloadV2.items)) return null;
    var v3 = { schemaVersion:3, meta: payloadV2.meta || {}, items: [] };

    for (var idx=0; idx<payloadV2.items.length; idx++){
      var old = payloadV2.items[idx] || {};
      var it = {
        id: old.id || window.crypto.randomUUID(),
        name: old.name||'', location: old.location||'',
        model: old.model||'', serial: old.serial||'',
        qty: Number(old.qty)||0, estimatedValue: Number(old.estimatedValue)||0,
        condition: old.condition||'Good', status: old.status||'Active',
        lastService: old.lastService||'', nextDue: old.nextDue||'',
        notes: old.notes||'', verified: !!old.verified, photoIds: []
      };

      if (Array.isArray(old.photos) && old.photos.length){
        for (var p=0; p<old.photos.length; p++){
          var durl = old.photos[p];
          var blob = dataURLToBlob(durl);
          if (!blob) continue;
          var pid = window.crypto.randomUUID();
          try { await idbSavePhoto(pid, blob); it.photoIds.push(pid); } catch(e){}
        }
      }
      v3.items.push(it);
    }
    return v3;
  }

  async function tryMigrateLegacy(){
    var V2_KEY = 'maintInv_v2_working';
    var existingV3 = localStorage.getItem(STORAGE_KEY);
    if (existingV3) return false;

    var rawV2 = localStorage.getItem(V2_KEY);
    if (!rawV2) return false;

    try{
      var payloadV2 = JSON.parse(rawV2);
      var migrated = await migrateV2PayloadToV3(payloadV2);
      if (!migrated) return false;

      localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
      localStorage.setItem('maintInv_v3_checkpoint_migrated_'+Date.now(), JSON.stringify(migrated));
      flash('Legacy data found and migrated âœ”');
      return true;
    }catch(e){
      console.warn('Migration failed', e);
      return false;
    }
  }

  function listCheckpoints(){
    var keys = [];
    for (var i=0;i<localStorage.length;i++){
      var k = localStorage.key(i);
      if(/^maintInv_v3_checkpoint_/.test(k)) keys.push(k);
    }
    keys.sort(); // oldest â†’ newest
    return keys;
  }

  function restoreLatestCheckpoint(){
    var cps = listCheckpoints();
    if (!cps.length) return false;
    var lastKey = cps[cps.length-1];
    try{
      var raw = localStorage.getItem(lastKey);
      if (!raw) return false;
      localStorage.setItem(STORAGE_KEY, raw);
      flash('Restored from latest checkpoint.');
      return true;
    }catch(e){ return false; }
  }

  function smartLoad(){
    var raw = localStorage.getItem(STORAGE_KEY);
    if (raw){
      loadLocal();
      return;
    }
    if (restoreLatestCheckpoint()){
      loadLocal();
    }else{
      flash('No saved data found on this device.');
      render(); updateChangeNotice();
    }
  }

  /* ----------------- Photo upload & processing ----------------- */

  function fileToDataURL(file){
    return new Promise(function(res){
      var rd = new FileReader();
      rd.onload = function(ev){ res(ev.target.result); };
      rd.readAsDataURL(file);
    });
  }

  function dataURLToImage(dataURL){
    return new Promise(function(res, rej){
      var img = new Image();
      img.onload = function(){ res(img); };
      img.onerror = rej;
      img.src = dataURL;
    });
  }

  function resizeToBlob(dataURL, maxW, maxH, quality){
    return dataURLToImage(dataURL).then(function(img){
      var w = img.naturalWidth||img.width, h = img.naturalHeight||img.height;
      var r = Math.min(maxW / w, maxH / h, 1);
      var cw = Math.round(w * r), ch = Math.round(h * r);
      var c = document.createElement('canvas');
      c.width = cw; c.height = ch;
      var ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0, cw, ch);
      return new Promise(function(res){
        c.toBlob(function(blob){ res(blob || null); }, 'image/jpeg', quality);
      });
    });
  }

  function onPhotoUpload(e, itemId){
    var files = e.target.files;
    if(!files || !files.length) return;
    var it = null;
    for (var i=0;i<items.length;i++){ if(items[i].id===itemId){ it=items[i]; break; } }
    if(!it) return;

    var proms = [];
    for (var j=0;j<files.length;j++){
      (function(f){
        proms.push(
          fileToDataURL(f)
            .then(function(durl){ return resizeToBlob(durl, 1600, 1600, 0.8); })
            .then(function(blob){
              if(!blob) return null;
              var pid = window.crypto.randomUUID();
              return idbSavePhoto(pid, blob).then(function(){ return pid; });
            })
            .catch(function(){ return null; })
        );
      })(files[j]);
    }

    Promise.all(proms).then(function(ids){
      var added = 0;
      for (var k=0;k<ids.length;k++){
        if(ids[k]){
          it.photoIds.push(ids[k]);
          added++;
        }
      }
      render(); // shows new photos once object URLs resolve
      if(qs('#autoSave') && qs('#autoSave').checked){ saveLocal(false); checkpoint(); }
      if(added) flash(added+' photo'+(added!==1?'s':'')+' added.');
    });
  }

  function removePhoto(itemId, idx){
    var it = null;
    for (var i=0;i<items.length;i++){ if(items[i].id===itemId){ it=items[i]; break; } }
    if(!it) return;
    var pid = it.photoIds[idx];
    if(!pid) return;
    idbDeletePhoto(pid).finally(function(){
      revokeObjectURL(pid);
      it.photoIds.splice(idx,1);
      render();
      if(qs('#autoSave') && qs('#autoSave').checked){ saveLocal(false); checkpoint(); }
    });
  }

  /* ----------------- Rendering ----------------- */

  function render(){
    var qEl = qs('#searchTxt'), fcEl = qs('#fCondition'), fsEl = qs('#fStatus'), flEl = qs('#fLocation');
    var q = qEl && qEl.value ? qEl.value.trim().toLowerCase() : '';
    var fc = fcEl ? fcEl.value : '';
    var fs = fsEl ? fsEl.value : '';
    var fl = flEl && flEl.value ? flEl.value.trim().toLowerCase() : '';

    var filtered = [];
    for (var i=0;i<items.length;i++){
      var it = items[i];
      if(fc && it.condition!==fc) continue;
      if(fs && it.status!==fs) continue;
      if(fl && String(it.location||'').toLowerCase().indexOf(fl)===-1) continue;
      if(q){
        var blob = (it.name||'')+' '+(it.model||'')+' '+(it.serial||'')+' '+(it.location||'')+' '+(it.notes||'');
        if(blob.toLowerCase().indexOf(q)===-1) continue;
      }
      filtered.push(it);
    }

    var sumChip = qs('#summaryChip');
    if (sumChip) sumChip.textContent = filtered.length + ' item' + (filtered.length!==1?'s':'');

    var tb = qs('#invBody'); if(!tb) return;
    tb.innerHTML = '';

    for(var f=0; f<filtered.length; f++){
      (function(it2){
        var needsPhotos = !it2.photoIds || it2.photoIds.length===0;
        var tr = document.createElement('tr');
        if(needsPhotos) tr.classList.add('row-missing-photos');

        var photosHtmlParts = [];
        photosHtmlParts.push('<div class="photo-stack" data-photo-stack="'+it2.id+'">');
        if (it2.photoIds && it2.photoIds.length){
          for (var p=0;p<it2.photoIds.length;p++){
            photosHtmlParts.push(
              '<div style="display:flex;flex-direction:column;align-items:center;gap:4px">'
                + '<img data-photo-id="'+it2.photoIds[p]+'" class="thumb" loading="lazy" alt="photo" />'
                + '<button class="btn danger small" data-remove-photo="'+it2.id+':'+p+'">Remove</button>'
              + '</div>'
            );
          }
        }
        photosHtmlParts.push('</div>');
        photosHtmlParts.push('<hr class="sep"/>');
        photosHtmlParts.push('<label class="btn" for="photo_'+it2.id+'">+ Add Photos</label>');
        photosHtmlParts.push('<input id="photo_'+it2.id+'" type="file" accept="image/*" capture="environment" multiple />');
        if (needsPhotos){ photosHtmlParts.push('<div class="req-chip">Photos required</div>'); }
        var photosHtml = photosHtmlParts.join('');

        var estVal = Number(it2.estimatedValue)||0;
        var qty = Number(it2.qty)||0;

        var rowHtml = ''
          + '<td><input type="checkbox" '+(it2.verified?'checked':'')+' data-bind="'+it2.id+':verified"/></td>'
          + '<td style="min-width:220px">'+photosHtml+'</td>'
          + '<td><input type="text" value="'+(it2.name||'')+'" placeholder="Item name" data-bind="'+it2.id+':name"/></td>'
          + '<td><input type="text" value="'+(it2.location||'')+'" placeholder="e.g., Boiler Room" data-bind="'+it2.id+':location"/></td>'
          + '<td><input type="text" value="'+(it2.model||'')+'" placeholder="Model #" data-bind="'+it2.id+':model"/></td>'
          + '<td><input type="text" value="'+(it2.serial||'')+'" placeholder="Serial #" data-bind="'+it2.id+':serial"/></td>'
          + '<td><input type="number" min="0" value="'+(it2.qty||1)+'" style="width:90px" data-bind="'+it2.id+':qty"/></td>'
          + '<td>'
            + '<input type="number" min="0" step="0.01" value="'+(typeof it2.estimatedValue==='number'?it2.estimatedValue:0)+'" style="width:120px" data-bind="'+it2.id+':estimatedValue"/>'
            + '<div class="small" style="margin-top:4px">'+currency(estVal)+' Ã— '+(qty||0)+' = <b>'+currency(estVal*qty)+'</b></div>'
          + '</td>'
          + '<td>'
            + '<select data-bind="'+it2.id+':condition">'
              + ['Excellent','Good','Fair','Needs Repair','Out of Service'].map(function(c){ return '<option '+(c===it2.condition?'selected':'')+'>'+c+'</option>'; }).join('')
            + '</select>'
            + '<div class="'+conditionBadge(it2.condition)+'" style="margin-top:6px">'+it2.condition+'</div>'
          + '</td>'
          + '<td>'
            + '<select data-bind="'+it2.id+':status">'
              + ['Active','Spare','Retired'].map(function(s){ return '<option '+(s===it2.status?'selected':'')+'>'+s+'</option>'; }).join('')
            + '</select>'
          + '</td>'
          + '<td><input type="date" value="'+(it2.lastService||'')+'" data-bind="'+it2.id+':lastService"/></td>'
          + '<td><input type="date" value="'+(it2.nextDue||'')+'" data-bind="'+it2.id+':nextDue"/></td>'
          + '<td><textarea class="notes" data-bind="'+it2.id+':notes" placeholder="Notes...">'+(it2.notes||'')+'</textarea></td>'
          + '<td class="actions">'
            + '<button class="btn" data-dup="'+it2.id+'">Duplicate</button>'
            + '<button class="btn danger" data-del="'+it2.id+'">Remove</button>'
          + '</td>';

        tr.innerHTML = rowHtml;
        tb.appendChild(tr);

        var addRow = document.createElement('tr');
        addRow.className = 'add-row';
        addRow.innerHTML = '<td colspan="14"><button class="btn primary" data-add-after="'+it2.id+'">+ Add Item Below</button></td>';
        tb.appendChild(addRow);

        var photoInput = tr.querySelector('#photo_'+it2.id);
        if (photoInput){
          (function(xid){
            photoInput.addEventListener('change', function(e){ onPhotoUpload(e, xid); });
          })(it2.id);
        }

        // Resolve photo object URLs async
        var imgs = tr.querySelectorAll('img[data-photo-id]');
        Array.prototype.forEach.call(imgs, function(imgEl){
          var pid = imgEl.getAttribute('data-photo-id');
          getObjectURLForPhoto(pid).then(function(url){
            if(url) imgEl.src = url;
            else imgEl.alt = 'missing';
          });
        });

      })(filtered[f]);
    }

    // bind model updates
    var binds = qsa('[data-bind]');
    for (var b=0;b<binds.length;b++){
      (function(el){
        el.addEventListener('input', onBind);
        el.addEventListener('change', onBind);
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.addEventListener('blur', function(){ render(); });
        }
      })(binds[b]);
    }

    updateTotalValueChip();
    updateChangeNotice();
  }

  // Delegated actions (clicks)
  var invBody = qs('#invBody');
  if (invBody){
    invBody.addEventListener('click', function(ev){
      var t = ev.target;

      var addBtn = t.closest && t.closest('[data-add-after]');
      if(addBtn){ addItemAfterId(addBtn.getAttribute('data-add-after')); return; }

      var delBtn = t.closest && t.closest('[data-del]');
      if(delBtn){ removeItem(delBtn.getAttribute('data-del')); return; }

      var dupBtn = t.closest && t.closest('[data-dup]');
      if(dupBtn){
        var id = dupBtn.getAttribute('data-dup');
        var base = null, idx=-1;
        for (var i=0;i<items.length;i++){ if(items[i].id===id){ base=items[i]; idx=i; break; } }
        if(!base) return;
        var clone = JSON.parse(JSON.stringify(base));
        clone.id = window.crypto.randomUUID();
        clone.name = (base.name||'') + ' (Copy)';
        items.splice(idx+1,0,clone);
        render(); if(qs('#autoSave') && qs('#autoSave').checked){ saveLocal(false); checkpoint(); }
        updateChangeNotice();
        flash('Item duplicated.');
        return;
      }

      var rmPhoto = t.closest && t.closest('[data-remove-photo]');
      if(rmPhoto){
        var parts = rmPhoto.getAttribute('data-remove-photo').split(':');
        removePhoto(parts[0], parseInt(parts[1],10));
        return;
      }
    });
  }

  function onBind(e){
    var target = e.target;
    var ds = target.getAttribute('data-bind') || '';
    var parts = ds.split(':');
    if(parts.length<2) return;
    var id = parts[0], field = parts[1];

    var it = null;
    for (var i=0;i<items.length;i++){ if(items[i].id===id){ it=items[i]; break; } }
    if(!it) return;

    var val = (target.type==='checkbox') ? !!target.checked : target.value;
    if(field==='qty' || field==='estimatedValue') val = Number(val)||0;
    it[field] = val;

    if(field==='qty' || field==='estimatedValue'){ updateTotalValueChip(); }
    if (target.tagName === 'SELECT' || target.type === 'checkbox' || target.type === 'date') { render(); }

    if(qs('#autoSave') && qs('#autoSave').checked){ saveLocal(false); }
  }

  function itemKey(it){
    function norm(s){ return (s?String(s):'').trim().toLowerCase(); }
    return [norm(it.name), norm(it.location), norm(it.model), norm(it.serial)].join('|');
  }

  function diffVsSnapshot(currentItems, snapshot){
    if(!snapshot || !snapshot.items || !snapshot.items.length) return {added:[], missing:[], lastMeta:null, submittedAt:null};
    var mapPrev = {}, mapCurr = {};
    for (var i=0;i<snapshot.items.length;i++){ mapPrev[itemKey(snapshot.items[i])] = snapshot.items[i]; }
    for (var j=0;j<currentItems.length;j++){ mapCurr[itemKey(currentItems[j])] = currentItems[j]; }
    var missing = [], added = [];
    for (var k in mapPrev){ if(!mapCurr[k]) missing.push(mapPrev[k]); }
    for (var k2 in mapCurr){ if(!mapPrev[k2]) added.push(mapCurr[k2]); }
    return {added:added, missing:missing, lastMeta:snapshot.meta, submittedAt:snapshot.submittedAt};
  }

  function diffVsLast(currentItems){
    return diffVsSnapshot(currentItems, getLastSubmitted());
  }

  function updateChangeNotice(){
    var info = diffVsLast(items);
    var added = info.added||[], missing = info.missing||[], lastMeta = info.lastMeta, submittedAt = info.submittedAt;
    var box = qs('#changeNotice');
    if(!box) return;

    if(added.length===0 && missing.length===0){
      if(!getLastSubmitted()){
        box.style.display='block'; box.classList.remove('critical');
        box.innerHTML = 'No previous submitted inventory found. Submitting will set a baseline.';
      }else{
        box.style.display='none';
      }
      return;
    }
    box.style.display='block'; box.classList.remove('critical');
    var lastLine = '';
    if (submittedAt){
      lastLine = 'Last submitted: ' + (new Date(submittedAt).toLocaleString());
      if (lastMeta && lastMeta.conductedBy) lastLine += ' by ' + lastMeta.conductedBy;
    }
    box.innerHTML = ''
      + '<b>Changes since last submission:</b>'
      + '<ul style="margin:6px 0 0 18px;line-height:1.4">'
      +   '<li><b>Added:</b> ' + added.length + '</li>'
      +   '<li><b>Missing:</b> ' + missing.length + '</li>'
      + '</ul>'
      + '<div class="small" style="margin-top:6px">'+ lastLine +'</div>';
  }

  // Submit â†’ archive baseline locally (with stricter validation)
  qs('#submitBtn').addEventListener('click', function(){
    var noPhoto = [];
    var emptyCore = 0;
    for (var i=0;i<items.length;i++){
      var it = items[i];
      if(!it.photoIds || !it.photoIds.length) noPhoto.push(it);
      if(!it.name && !it.model && !it.serial) emptyCore++;
    }
    var notice = qs('#submitNotice');
    if(noPhoto.length){
      notice.style.display='block';
      notice.textContent = 'Cannot submit: ' + noPhoto.length + ' item' + (noPhoto.length!==1?'s':'') + ' missing required photo(s). Add at least one photo per item.';
      render(); flash('Add photos to all items before submitting.'); return;
    }
    if (emptyCore > 0){
      notice.style.display='block';
      notice.textContent = 'Please fill at least a name/model/serial for every item ('+emptyCore+' incomplete).';
      return;
    }
    notice.style.display='none';
    var payload = workingPayload();
    saveLocalImmediate(false); checkpoint();
    setLastSubmitted(payload);
    updateChangeNotice();
    flash('Inventory submitted & archived as baseline.');
  });

  /* ----------------- PDF Export (pulls blobs from IDB) ----------------- */

  qs('#pdfBtn').addEventListener('click', downloadPDF);

  function blobToDataURL(blob, maxW, maxH, quality){
    return new Promise(function(res){
      var url = URL.createObjectURL(blob);
      var img = new Image();
      img.onload = function(){
        var w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
        var r = Math.min(maxW / w, maxH / h, 1);
        var cw = Math.round(w * r), ch = Math.round(h * r);
        var c = document.createElement('canvas');
        c.width = cw; c.height = ch;
        var ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0, cw, ch);
        var durl = c.toDataURL('image/jpeg', quality);
        URL.revokeObjectURL(url);
        res(durl);
      };
      img.onerror = function(){ URL.revokeObjectURL(url); res(null); };
      img.src = url;
    });
  }

  async function getPhotoDataURL(photoId, maxW, maxH, q){
    var blob = await idbGetPhotoBlob(photoId);
    if(!blob) return null;
    return await blobToDataURL(blob, maxW, maxH, q);
  }

  async function downloadPDF(){
    // Guards for library load
    var jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
    if(!jsPDF || !window.jspdf || !window.jspdf.jsPDF){
      flash('PDF libraries not loaded'); 
      return;
    }
    const doc = new jsPDF({ unit:'pt', format:'letter', orientation:'landscape' });
    if (typeof doc.autoTable !== 'function') {
      flash('PDF table plugin not loaded');
      return;
    }

    flash('Building summaryâ€¦');

    const margin = 48;
    const pageWidth  = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    doc.setLineHeightFactor(1.25);

    // Header
    doc.setFillColor(52,73,94);
    doc.rect(0,0,pageWidth,72,'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.setTextColor(255,255,255);
    doc.text('Maintenance & Equipment Inventory', margin, 46);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text('Generated: ' + (new Date().toLocaleString()), pageWidth - margin, 46, {align:'right'});

    // Meta
    let y = 96;
    const propId = (qs('#propertyId') && qs('#propertyId').value) || '';
    doc.setTextColor(44,62,80);

    if(propId){
      doc.setFont('helvetica','bold'); doc.setFontSize(13);
      const propIdWrapped = doc.splitTextToSize('Property: ' + propId, pageWidth - margin*2);
      doc.text(propIdWrapped, margin, y);
      y += propIdWrapped.length*14;
    }

    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    const invDate = (qs('#invDate') && qs('#invDate').value) || 'â€”';
    const by = (qs('#conductedBy') && qs('#conductedBy').value) || 'â€”';
    const prop = (qs('#property') && qs('#property').value) || 'â€”';
    let totalVal = 0;
    for (var i2=0;i2<items.length;i2++){
      var it = items[i2];
      totalVal += (Number(it.estimatedValue)||0)*(Number(it.qty)||0);
    }

    doc.text('Date: ' + invDate, margin, y);
    doc.text('Conducted By: ' + by, margin + 240, y);
    doc.text('Location/Property: ' + (doc.splitTextToSize(prop, 300)[0]), margin + 480, y);
    y += 20;

    try{ doc.text('Total Estimated Value: ' + totalVal.toLocaleString('en-US',{style:'currency',currency:'USD'}), margin, y); }
    catch(e){ doc.text('Total Estimated Value: $' + totalVal.toFixed(2), margin, y); }
    y += 14;

    // Changes vs previous
    const info = diffVsLast(items);
    doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(44,62,80);
    doc.text('Changes vs Previous Submission', margin, y);
    y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.setTextColor(90);
    const last = getLastSubmitted();
    if(!last){
      doc.text('No previous submitted inventory found. This report will become the baseline once submitted.', margin, y);
      y += 18;
    }else if((!info.added || !info.added.length) && (!info.missing || !info.missing.length)){
      let noChTxt = 'No changes since last submission (' + (new Date(last.submittedAt).toLocaleString());
      if(last.meta && last.meta.conductedBy) noChTxt += ' by ' + last.meta.conductedBy;
      noChTxt += ').';
      doc.text(noChTxt, margin, y);
      y += 18;
    }else{
      let lastTxt = 'Last submitted: ' + (new Date(last.submittedAt).toLocaleString());
      if(last.meta && last.meta.conductedBy) lastTxt += ' by ' + last.meta.conductedBy;
      doc.text(lastTxt, margin, y);
      y += 14;
      const rows = [];
      for (var m=0;m<(info.missing?info.missing.length:0);m++){
        var mi = info.missing[m];
        rows.push(['Missing', mi.name||'', mi.location||'', mi.model||'', mi.serial||'', String(mi.qty||0)]);
      }
      for (var a=0;a<(info.added?info.added.length:0);a++){
        var ad = info.added[a];
        rows.push(['Added', ad.name||'', ad.location||'', ad.model||'', ad.serial||'', String(ad.qty||0)]);
      }
      doc.autoTable({
        head: [['Type','Name','Location','Model','Serial','Qty']],
        body: rows,
        startY: y,
        theme: 'grid',
        styles: { fontSize:10, cellPadding:6, overflow:'linebreak', minCellHeight:16, lineColor:[220,225,230], lineWidth:0.75 },
        headStyles: { fillColor:[52,152,219], textColor:255, fontStyle:'bold', fontSize:10 },
        columnStyles: {
          0:{cellWidth:70}, 1:{cellWidth:180, overflow:'linebreak'}, 2:{cellWidth:140, overflow:'linebreak'},
          3:{cellWidth:120, overflow:'linebreak'}, 4:{cellWidth:130, overflow:'linebreak'}, 5:{cellWidth:44, halign:'center'}
        },
        didParseCell: function(data){
          if(data.section==='body' && data.column.index===0){
            var flag = data.cell.text[0];
            data.cell.styles.fillColor = (flag==='Missing') ? [248,215,218] : [226,242,228];
          }
        },
        margin: { left: margin, right: margin }
      });
      y = doc.lastAutoTable.finalY + 20;
    }

    // Missing photos banner
    var noPhoto = [];
    for (var n=0;n<items.length;n++){
      if(!items[n].photoIds || !items[n].photoIds.length) noPhoto.push(items[n]);
    }
    if(noPhoto.length){
      doc.setFillColor(255,225,225);
      doc.roundedRect(margin, y, pageWidth-2*margin, 32, 6, 6, 'F');
      doc.setTextColor(134,27,27);
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Attention: ' + noPhoto.length + ' item' + (noPhoto.length!==1?'s':'') + ' missing required photo(s).', margin+12, y+21);
      y += 42;
    }

    flash('Adding line itemsâ€¦');

    // Inventory table: pull first photo (if any) from IDB and convert for PDF
    const head = [['Photo','Name','Location','Model','Serial','Qty','Est. Value','Line Total']];
    const body = [];
    for (var ii=0; ii<items.length; ii++) {
      var it3 = items[ii];
      var ev = Number(it3.estimatedValue) || 0;
      var q  = Number(it3.qty) || 0;
      var lineTotal = ev * q;

      var photoDataUrl = null;
      if (it3.photoIds && it3.photoIds.length){
        // Downscale to ~1000px for the PDF
        // eslint-disable-next-line no-await-in-loop
        photoDataUrl = await getPhotoDataURL(it3.photoIds[0], 1000, 1000, 0.8);
      }

      body.push([
        { content:'', rowSpan:2, styles:{ halign:'center', valign:'middle' }, _img: photoDataUrl },
        it3.name || '',
        it3.location || '',
        it3.model || '',
        it3.serial || '',
        String(q),
        (function(v){ try{return v.toLocaleString('en-US',{style:'currency',currency:'USD'});}catch(e){return '$'+v.toFixed(2);} })(ev),
        (function(v){ try{return v.toLocaleString('en-US',{style:'currency',currency:'USD'});}catch(e){return '$'+v.toFixed(2);} })(lineTotal)
      ]);

      var details = 'Condition: ' + (it3.condition || 'â€”')
        + '   â€¢   Status: ' + (it3.status || 'â€”')
        + '   â€¢   Service: ' + (it3.lastService || 'â€”') + ' â†’ ' + (it3.nextDue || 'â€”')
        + '   â€¢   Verified: ' + (it3.verified ? 'Yes' : 'No');
      if (it3.notes) details += '\nNotes: ' + it3.notes;
      body.push([{ content: details, colSpan: 7 }]);
    }

    doc.autoTable({
      head,
      body,
      startY: y,
      theme: 'grid',
      tableWidth: 'wrap',
      styles: { fontSize:10, cellPadding:6, overflow:'linebreak', valign:'top', lineColor:[220,225,230], lineWidth:0.75, minCellHeight:18 },
      headStyles: { fillColor:[52,152,219], textColor:255, fontStyle:'bold', fontSize:10 },
      columnStyles: { 0:{cellWidth:96}, 1:{cellWidth:140}, 2:{cellWidth:110}, 3:{cellWidth:90}, 4:{cellWidth:100}, 5:{cellWidth:30, halign:'center'}, 6:{cellWidth:60, halign:'right'}, 7:{cellWidth:70, halign:'right'} },
      rowPageBreak: 'avoid',
      margin: { left: margin, right: margin },
      didDrawCell: function(data){
        var raw = data.cell && data.cell.raw ? data.cell.raw : null;
        if (!raw || !raw._img) return;
        if (data.section !== 'body' || data.column.index !== 0) return;
        var x = data.cell.x, y0 = data.cell.y, width = data.cell.width, height = data.cell.height;
        var pad = 4, boxW = width - pad*2, boxH = height - pad*2;
        try {
          // Preserve aspect ratio using image properties
          var props = doc.getImageProperties(raw._img);
          var r = Math.min(boxW / props.width, boxH / props.height);
          var w = props.width * r, h = props.height * r;
          var dx = x + pad + (boxW - w)/2;
          var dy = y0 + pad + (boxH - h)/2;
          try { doc.addImage(raw._img, 'JPEG', dx, dy, w, h, undefined, 'FAST'); }
          catch (e2) { try { doc.addImage(raw._img, 'PNG', dx, dy, w, h, undefined, 'FAST'); } catch(e3){} }
        } catch(e){
          // fallback
          doc.setDrawColor(210); doc.rect(x + pad, y0 + pad, boxW, boxH);
          doc.setFontSize(9); doc.setTextColor(130);
          doc.text('No photo', x + pad + 6, y0 + pad + 14);
        }
      },
      didDrawPage: function(ctx){
        var pageNumber = ctx.pageNumber;
        doc.setFontSize(9); doc.setTextColor(150);
        doc.text('Page ' + pageNumber, pageWidth - margin, pageHeight - 16, {align:'right'});
      }
    });

    // -------- Photo gallery (optional) --------
    let py = doc.lastAutoTable.finalY + 24;
    if(py + 60 > pageHeight){ doc.addPage('letter','landscape'); py = 56; }
    doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(44,62,80);
    doc.text('Photo Verification', margin, py);
    py += 14;

    const thumbW = 120, thumbH = 90, gap = 10;
    const perRow = Math.floor((pageWidth - margin*2 + gap) / (thumbW + gap));
    let totalShown = 0;
    let capped = false;

    outer:
    for(const itp of items){
      if(py + 42 > pageHeight - 56){ doc.addPage('letter','landscape'); py = 56; }
      doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(52,73,94);
      doc.text((itp.name || 'Unnamed Item') + ' â€” ' + (itp.location || 'â€”'), margin, py);
      py += 12;
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(120);
      const line = 'Model: ' + (itp.model||'â€”') + '   Serial: ' + (itp.serial||'â€”') + '   Qty: ' + (itp.qty||0) + '   Verified: ' + (itp.verified?'Yes':'No');
      doc.text(doc.splitTextToSize(line, pageWidth - margin*2), margin, py);
      py += 12;

      if(!itp.photoIds || !itp.photoIds.length){
        doc.setFontSize(10); doc.setTextColor(150);
        doc.text('No photos attached.', margin, py);
        py += 18;
        continue;
      }

      let col = 0;
      for(const pid of itp.photoIds){
        if(totalShown >= MAX_GALLERY_PHOTOS){ capped = true; break outer; }
        if(py + thumbH + 22 > pageHeight - 56){ doc.addPage('letter','landscape'); py = 56; col = 0; }
        // eslint-disable-next-line no-await-in-loop
        const durl = await getPhotoDataURL(pid, 1000, 1000, 0.8);
        if (durl){
          const x0 = margin + col*(thumbW+gap);
          try{ doc.addImage(durl, 'JPEG', x0, py, thumbW, thumbH, undefined, 'FAST'); }
          catch(e){ try{ doc.addImage(durl, 'PNG', x0, py, thumbW, thumbH, undefined, 'FAST'); } catch(e2){} }
          totalShown++;
        }
        col++;
        if(col>=perRow){ col=0; py += thumbH + 12; }
      }
      if(col>0) py += thumbH + 12;
    }

    if(capped){
      if(py + 40 > pageHeight - 56){ doc.addPage('letter','landscape'); py = 56; }
      doc.setFont('helvetica','italic'); doc.setFontSize(10); doc.setTextColor(120);
      doc.text('Note: Photo gallery capped at '+MAX_GALLERY_PHOTOS+' images to keep PDF size reasonable.', margin, py);
      py += 16;
    }

    // Signature line
    if(py + 48 > pageHeight - 56){ doc.addPage('letter','landscape'); py = 56; }
    doc.setDrawColor(180);
    doc.line(margin, pageHeight-92, margin+260, pageHeight-92);
    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(100);
    doc.text('Signature (Conducted By)', margin, pageHeight-76);

    var dateSlug = (qs('#invDate') && qs('#invDate').value) ? qs('#invDate').value : new Date().toISOString().slice(0,10);
    var idSlug = ((qs('#propertyId') && qs('#propertyId').value) || '').replace(/[^\w\-]+/g,'_').slice(0,40);
    var fname = 'Inventory_' + (idSlug ? idSlug + '_' : '') + dateSlug + '.pdf';

    doc.save(fname);
    flash('PDF downloaded.');
  } // end downloadPDF

  /* ----------------- Top-level controls ----------------- */

  var userHasInteracted = false;

  qs('#saveBtn').addEventListener('click', function(){
    userHasInteracted = true;
    saveLocal(true);
    checkpoint();
  });
  qs('#loadBtn').addEventListener('click', function(){ smartLoad(); });
  qs('#exportJsonBtn').addEventListener('click', function(){ exportJSON(); });
  var importEl = qs('#importJson');
  if (importEl){
    importEl.addEventListener('change', function(e){
      if(e.target && e.target.files && e.target.files[0]) importJSON(e.target.files[0]);
    });
  }

  // Baseline controls
  qs('#exportBaselineBtn').addEventListener('click', exportBaseline);
  var importBaseEl = qs('#importBaseline');
  if(importBaseEl){
    importBaseEl.addEventListener('change', function(e){
      if(e.target && e.target.files && e.target.files[0]) importBaseline(e.target.files[0]);
    });
  }

  qs('#bulkVerifyBtn').addEventListener('click', function(){
    if(!items.length) return;
    for (var i=0;i<items.length;i++){ items[i].verified=true; }
    render();
    if(qs('#autoSave') && qs('#autoSave').checked){
      saveLocal(false);
      checkpoint();
    }
  });

  qs('#clearAllBtn').addEventListener('click', async function(){
    if(!confirm('This will remove all items, session info, and ALL photos on this device. Proceed?')) return;
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STORAGE_LAST);
    localStorage.removeItem(STORAGE_HISTORY);
    try { await wipeAllPhotos(); } catch(_) {}
    items=[];
    if(qs('#propertyId')) qs('#propertyId').value='';
    if(qs('#invDate')) qs('#invDate').value='';
    if(qs('#conductedBy')) qs('#conductedBy').value='';
    if(qs('#property')) qs('#property').value='';
    if(qs('#overallNotes')) qs('#overallNotes').value='';
    render(); updateChangeNotice(); flash('Reset.');
  });

  qs('#addItemBtn').addEventListener('click', function(){
    addItem();
    userHasInteracted = true;
  });
  qs('#addItemBtnFooter').addEventListener('click', function(){
    addItem();
    userHasInteracted = true;
  });

  // Filters
  var filterIds = ['#searchTxt','#fCondition','#fStatus','#fLocation'];
  for (var fi=0; fi<filterIds.length; fi++){
    (function(sel){
      var el = qs(sel); if(!el) return;
      el.addEventListener('input', render);
      el.addEventListener('change', render);
    })(filterIds[fi]);
  }
  qs('#clearFiltersBtn').addEventListener('click', function(){
    if(qs('#searchTxt')) qs('#searchTxt').value='';
    if(qs('#fCondition')) qs('#fCondition').value='';
    if(qs('#fStatus')) qs('#fStatus').value='';
    if(qs('#fLocation')) qs('#fLocation').value='';
    render();
  });

  // Meta autosave
  var metaIds = ['#propertyId','#invDate','#conductedBy','#property','#overallNotes','#autoSave'];
  for (var mi=0; mi<metaIds.length; mi++){
    (function(sel){
      var el = qs(sel); if(!el) return;
      el.addEventListener('change', function(){
        userHasInteracted = true;
        if(qs('#autoSave') && qs('#autoSave').checked) saveLocal(false);
      });
      el.addEventListener('input',  function(){
        userHasInteracted = true;
        if(qs('#autoSave') && qs('#autoSave').checked) saveLocal(false);
      });
    })(metaIds[mi]);
  }

  // Init (migrate legacy if present, then load/checkpoint fallback)
  (async function init(){
    try { await tryMigrateLegacy(); } catch(e){}
    smartLoad();
    if(items.length===0){ addItem({name:'Boiler Pump', location:'Boiler Room'}); }
  })();

})(); // IIFE end
</script>
</body>
</html>
