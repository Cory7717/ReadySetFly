<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hotel Revenue ¬∑ P&L ¬∑ Daily (SDOWLY)</title>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<!-- jsPDF + AutoTable for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg1:#667eea;--bg2:#764ba2;--panelTint:rgba(255,255,255,.95);--ink:#2c3e50;--inkSoft:#7f8c8d;--brand1:#3498db;--brand2:#2980b9;--dark1:#2c3e50;--dark2:#34495e;--goodBg:#e8f5e8;--good:#27ae60;--warnBg:#fff3cd;--warn:#856404;--posBg:#d1edcc;--pos:#155724;--negBg:#f8d7da;--neg:#721c24;--grid:#e0e0e0}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;padding:20px}
.container{max-width:1400px;margin:0 auto;background:var(--panelTint);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);backdrop-filter:blur(10px);overflow:hidden}
.header{background:linear-gradient(135deg,var(--dark1),var(--brand1));color:#fff;padding:24px;text-align:center}
.header h1{font-size:2em;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.25)}
.toolbar{position:sticky;top:0;z-index:5;background:#f9fbff;border-bottom:1px solid #e9edf3;padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.btn{border:1px solid #dbe3ee;background:#fff;color:#1f2d3d;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s transform,.2s box-shadow}
.btn.primary{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;border:none}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.08)}
input[type="file"]{display:none}
.pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:#2c3e50;padding:6px 10px;background:#eef4ff;border:1px solid #d7e2ff;border-radius:999px}
.tabs{display:flex;gap:8px;justify-content:center;padding:14px;background:#f6f9ff;border-bottom:1px solid #e7eef7;flex-wrap:wrap}
.tab{padding:10px 14px;border-radius:10px;border:1px solid #dce6f3;background:#fff;cursor:pointer;font-weight:700}
.tab.active{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;border:none}
.content{padding:22px}
.hidden{display:none}
.section{margin-bottom:22px;background:#fff;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,.08);overflow:hidden}
.section-header{background:linear-gradient(135deg,#34495e,#2c3e50);color:#fff;padding:14px 16px;font-weight:800;display:flex;align-items:center;justify-content:space-between}
.section-actions{display:flex;gap:10px;flex-wrap:wrap}
.table-container{overflow-x:auto;padding:14px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:9px 8px;text-align:center;border:1px solid var(--grid);min-width:120px;white-space:nowrap}
th{background:linear-gradient(135deg,#f8f9fa,#e9ecef);font-weight:800;color:#2c3e50;text-transform:uppercase;font-size:11px;letter-spacing:.5px}
.month-header{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff!important;font-size:12px}
.input-cell{background:#f4f7ff}
.input-cell input{width:100%;padding:7px;border:1px solid #ddd;border-radius:6px;text-align:center;font-size:13px;background:#fff}
.calculated-cell{background:var(--goodBg);font-weight:800;color:var(--good)}
.variance-positive{background:var(--posBg);color:var(--pos);font-weight:800}
.variance-negative{background:var(--negBg);color:var(--neg);font-weight:800}
.total-row{background:linear-gradient(135deg,var(--dark1),var(--dark2));color:#fff;font-weight:900}
canvas{max-width:100%;height:320px}
details.master-drop summary{cursor:pointer;font-weight:900;color:#1f2d3d;list-style:none;font-size:12px}
details.master-drop[open] summary{color:#0b5ed7}
.drop-panel{padding:10px 12px;border-top:1px dashed #e5e7eb;text-align:left}
.controls{display:flex;gap:10px;align-items:center;margin-bottom:8px}
.cat-list{list-style:none;padding:0;margin:0;font-size:13px}
.cat-list li{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed #e5e7eb;padding:4px 0}
.kpi-chip{display:inline-flex;gap:6px;background:#f4f7ff;border:1px solid #e6ecf7;border-radius:999px;padding:4px 8px;font-size:12px;color:#1e2a3a;margin-right:6px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#f5f7fb}
.badge.good{background:#e8f5e8;border-color:#bfe6bf;color:#216e39}
.badge.warn{background:#fff3cd;border-color:#f2df8a;color:#8a6d3b}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üè® Hotel Revenue ¬∑ P&amp;L ¬∑ Daily (SDOWLY)</h1>
    <p>Daily (with Budget & Accuracy), Monthly, and Operating P&amp;L.</p>
  </div>

  <div class="toolbar">
    <button class="btn primary" id="saveBtn">Save</button>
    <button class="btn" id="loadBtn">Load</button>
    <button class="btn" id="exportBtn">Export (.json)</button>
    <label class="btn" for="importFile">Import (.json)</label><input id="importFile" type="file" accept=".json"/>
    <button class="btn" id="resetBtn">Reset</button>
    <label class="pill"><input id="autoSaveToggle" type="checkbox" checked/> Auto-save</label>
    <!-- Download PDF -->
    <button class="btn" id="pdfBtn" title="Download a clean, professional PDF report">Download PDF</button>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="dailyTab">Daily</button>
    <button class="tab" data-tab="monthlyTab">Monthly (Rev &amp; Exp)</button>
    <button class="tab" data-tab="plTab">P&amp;L</button>
  </div>

  <div class="content">
    <!-- DAILY TAB -->
    <div id="dailyTab">
      <div class="section">
        <div class="section-header">
          <span>üìÖ Daily Revenue Analysis (SDOWLY)</span>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <label>Month:
              <select id="dailyMonth">
                <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                <option value="9">October</option><option value="10">November</option><option value="11">December</option>
              </select>
            </label>
            <label>Year: <input type="number" id="dailyYear" value="2025" style="width:90px"/></label>
            <button class="btn" id="regenDailyBtn">Generate Days</button>
            <label class="pill" title="Sum of daily Actuals updates Monthly Current Year automatically">
              <input type="checkbox" id="dailyRollupToggle" checked/> Roll up Actuals ‚Üí Monthly
            </label>
            <label class="pill" title="Sum of daily Budget updates Monthly Budget automatically">
              <input type="checkbox" id="dailyBudgetRollupToggle"/> Roll up Budget ‚Üí Monthly Budgets
            </label>
            <span class="badge">GM Accuracy (Daily Avg): <b id="gmAccuracyAvg">‚Äî</b></span>
          </div>
        </div>
        <div class="table-container">
          <table class="daily-wide" id="dailyTable">
            <thead id="dailyHead"></thead>
            <tbody id="dailyBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MONTHLY TAB -->
    <div id="monthlyTab" class="hidden">
      <div class="section">
        <div class="section-header">
          <span>üìä Monthly Revenue ¬∑ Actuals ¬∑ Forecast ¬∑ Budget</span>
          <div class="section-actions">
            <label class="btn" for="prevYearRevUpload">Upload Prev Year RevReports (.txt)</label>
            <input id="prevYearRevUpload" type="file" accept=".txt" multiple />
            <label class="btn" for="currYearRevUpload">Upload Current Year RevReports (.txt)</label>
            <input id="currYearRevUpload" type="file" accept=".txt" multiple />
            <span class="pill">Header period like <b>31Jan25</b> picks the month (e.g., Jan 2025).</span>
          </div>
        </div>
        <div class="table-container">
          <table id="revenueTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th class="month-header">Jan</th><th class="month-header">Feb</th><th class="month-header">Mar</th>
                <th class="month-header">Apr</th><th class="month-header">May</th><th class="month-header">Jun</th>
                <th class="month-header">Jul</th><th class="month-header">Aug</th><th class="month-header">Sep</th>
                <th class="month-header">Oct</th><th class="month-header">Nov</th><th class="month-header">Dec</th>
                <th class="total-row">Total</th>
              </tr>
            </thead>
            <tbody id="revenueBody"></tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <div class="section-header">üí∏ Monthly Expenses ¬∑ Actuals ¬∑ Forecast ¬∑ Budget</div>
        <div class="table-container">
          <table id="expenseTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th class="month-header">Jan</th><th class="month-header">Feb</th><th class="month-header">Mar</th>
                <th class="month-header">Apr</th><th class="month-header">May</th><th class="month-header">Jun</th>
                <th class="month-header">Jul</th><th class="month-header">Aug</th><th class="month-header">Sep</th>
                <th class="month-header">Oct</th><th class="month-header">Nov</th><th class="month-header">Dec</th>
                <th class="total-row">Total</th>
              </tr>
            </thead>
            <tbody id="expenseBody"></tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <div class="section-header">üìâ Visualization</div>
        <div style="padding:14px"><canvas id="revExpChart"></canvas></div>
      </div>
    </div>

    <!-- P&L TAB -->
    <div id="plTab" class="hidden">
      <div class="section">
        <div class="section-header">üßæ Operating P&amp;L (Revenue ‚àí Expenses)</div>
        <div class="table-container">
          <table id="plTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th class="month-header">Jan</th><th class="month-header">Feb</th><th class="month-header">Mar</th>
                <th class="month-header">Apr</th><th class="month-header">May</th><th class="month-header">Jun</th>
                <th class="month-header">Jul</th><th class="month-header">Aug</th><th class="month-header">Sep</th>
                <th class="month-header">Oct</th><th class="month-header">Nov</th><th class="month-header">Dec</th>
                <th class="total-row">Total</th>
              </tr>
            </thead>
            <tbody id="plBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(()=>{
  /* ========= Utilities ========= */
  const MONTHS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const qs=(s,r=document)=>r.querySelector(s);
  const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const fmtC=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(Number(n)||0);
  const fmtP=v=>((Number.isFinite(v)?v:0).toFixed(1))+'%';
  const sum=a=>a.reduce((x,y)=>x+(Number(y)||0),0);
  function addVarClass(el,val,invert=false){ if(!el)return; el.className='calculated-cell'; const v=invert?-val:val; if(v>0)el.classList.add('variance-positive'); else if(v<0)el.classList.add('variance-negative'); }

  /* ========= Tabs ========= */
  qsa('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      qsa('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      ['dailyTab','monthlyTab','plTab'].forEach(id=>qs('#'+id).classList.add('hidden'));
      qs('#'+btn.dataset.tab).classList.remove('hidden');
    });
  });

  /* ========= DAILY (restored + GM Accuracy) ========= */
  const dailyHead=qs('#dailyHead'), dailyBody=qs('#dailyBody');
  function buildDailyHeader(){
    dailyHead.innerHTML=`
      <tr>
        <th>Day</th>
        <th colspan="4">Prev Year Actual</th>
        <th colspan="4">Budget</th>
        <th colspan="4">Manager Forecast</th>
        <th colspan="4">Current Year Actual</th>
        <th>GM Accuracy %</th>
      </tr>
      <tr>
        <th># / DOW</th>
        <th>Revenue</th><th>ADR</th><th>OCC%</th><th>RevPAR</th>
        <th>Revenue</th><th>ADR</th><th>OCC%</th><th>RevPAR</th>
        <th>Revenue</th><th>ADR</th><th>OCC%</th><th>RevPAR</th>
        <th>Revenue</th><th>ADR</th><th>OCC%</th><th>RevPAR</th>
        <th>%</th>
      </tr>`;
  }
  function daysInMonth(y,m){return new Date(y,m+1,0).getDate();}
  function weekday(y,m,d){return new Date(y,m,d).toLocaleDateString('en-US',{weekday:'short'});}

  // persisted daily data
  let dailyData = {}; // { "YYYY-M": [ {prev:{...}, bud:{...}, fcst:{...}, curr:{...}}, ... ] }

  function keyForDaily(){
    const y=Number(qs('#dailyYear').value)||new Date().getFullYear();
    const m=Number(qs('#dailyMonth').value)||new Date().getMonth();
    return `${y}-${m}`;
  }
  function ensureDailyArray(len){
    const k=keyForDaily();
    if(!dailyData[k]) dailyData[k]=Array(len).fill(0).map(()=>({
      prev:{rev:'',adr:'',occ:'',revpar:''},
      bud :{rev:'',adr:'',occ:'',revpar:''},
      fcst:{rev:'',adr:'',occ:'',revpar:''},
      curr:{rev:'',adr:'',occ:'',revpar:''},
    }));
    if(dailyData[k].length!==len){
      dailyData[k].length=len;
      for(let i=0;i<len;i++){
        if(!dailyData[k][i]) dailyData[k][i]={prev:{rev:'',adr:'',occ:'',revpar:''},bud:{rev:'',adr:'',occ:'',revpar:''},fcst:{rev:'',adr:'',occ:'',revpar:''},curr:{rev:'',adr:'',occ:'',revpar:''}};
      }
    }
    return dailyData[k];
  }

  function gmAccForDay(fcst, actual){
    const a = Number(actual)||0;
    const f = Number(fcst)||0;
    if(a<=0) return null; // undefined when no actual
    const err = Math.abs(f-a)/Math.max(a,1);
    return Math.max(0, 100*(1-err));
  }

  function renderDailyTable(){
    buildDailyHeader();
    const y=Number(qs('#dailyYear').value)||new Date().getFullYear();
    const m=Number(qs('#dailyMonth').value)||new Date().getMonth();
    const n=daysInMonth(y,m);
    const arr=ensureDailyArray(n);
    dailyBody.innerHTML='';
    let accSum=0, accN=0;

    for(let d=1; d<=n; d++){
      const row=document.createElement('tr');
      const day=arr[d-1];
      const cell = (g,f,ro=false)=>{
        const step=(f==='occ'||f==='adr'||f==='revpar')?'0.01':'1';
        const placeholder=(f==='occ'||f==='revpar')?'0.0':'0';
        const val=day[g][f]??'';
        const roAttr = ro ? 'readonly' : '';
        return `<td class="input-cell"><input ${roAttr} type="number" step="${step}" value="${val}" placeholder="${placeholder}" data-day="${d-1}" data-group="${g}" data-field="${f}"/></td>`;
      };
      const acc = gmAccForDay(day.fcst.rev, day.curr.rev);
      if(acc!=null){accSum+=acc;accN++;}

      row.innerHTML=`
        <td>${d} ¬∑ ${weekday(y,m,d)}</td>
        ${cell('prev','rev',true)}${cell('prev','adr',true)}${cell('prev','occ',true)}${cell('prev','revpar',true)}
        ${cell('bud','rev')}${cell('bud','adr')}${cell('bud','occ')}${cell('bud','revpar')}
        ${cell('fcst','rev')}${cell('fcst','adr')}${cell('fcst','occ')}${cell('fcst','revpar')}
        ${cell('curr','rev')}${cell('curr','adr')}${cell('curr','occ')}${cell('curr','revpar')}
        <td><span data-acc="${d-1}">${acc!=null?fmtP(acc):'‚Äî'}</span></td>
      `;
      dailyBody.appendChild(row);
    }
    qsa('#dailyBody input').forEach(inp=>inp.addEventListener('input',onDailyInput));

    qs('#gmAccuracyAvg').textContent = accN? fmtP(accSum/accN) : '‚Äî';
  }

  function onDailyInput(e){
    const el=e.target;
    const idx=parseInt(el.dataset.day,10);
    const g=el.dataset.group,f=el.dataset.field;
    const y=Number(qs('#dailyYear').value)||new Date().getFullYear();
    const m=Number(qs('#dailyMonth').value)||new Date().getMonth();
    const n=daysInMonth(y,m);
    const arr=ensureDailyArray(n);
    arr[idx][g][f]=el.value;

    // update GM accuracy for that row
    const acc = gmAccForDay(arr[idx].fcst.rev, arr[idx].curr.rev);
    const sp = qs(`[data-acc="${idx}"]`);
    if(sp) sp.textContent = acc!=null ? fmtP(acc) : '‚Äî';

    // refresh average
    let accSum=0,accN=0;
    for(let i=0;i<arr.length;i++){
      const a=gmAccForDay(arr[i].fcst.rev, arr[i].curr.rev);
      if(a!=null){accSum+=a;accN++;}
    }
    qs('#gmAccuracyAvg').textContent = accN? fmtP(accSum/accN) : '‚Äî';

    recalcDailyRollups();
    if(qs('#autoSaveToggle').checked) saveToLocal(false);
  }

  function recalcDailyRollups(){
    const k=keyForDaily();
    const arr=dailyData[k]||[];
    const budRev = arr.reduce((t,day)=>t+(parseFloat(day.bud.rev)||0),0);
    const actRev = arr.reduce((t,day)=>t+(parseFloat(day.curr.rev)||0),0);

    if(qs('#dailyBudgetRollupToggle').checked){
      const m=Number(qs('#dailyMonth').value)||0;
      const budInputs=qsa('input[data-rev="budget"]');
      if(budInputs[m]) budInputs[m].value = String(Math.round(budRev));
    }
    if(qs('#dailyRollupToggle').checked){
      const m=Number(qs('#dailyMonth').value)||0;
      revCurrBreakdowns[m] = revCurrBreakdowns[m] || blankBreakdown();
      revCurrBreakdowns[m].total = actRev;
      revCurrBreakdowns[m].hasTotal = true;
    }
    calculateMonthly();
  }

  qs('#regenDailyBtn').addEventListener('click',renderDailyTable);
  renderDailyTable();

  /* ========= Monthly tables ========= */
  const els={};
  function mkCells(n,cls,attr){return Array.from({length:n},()=>`<td class="${cls}"><input type="number" ${attr} placeholder="0"/></td>`).join('');}
  function mkCalc(n,attr,txt='$0'){return Array.from({length:n},(_,i)=>`<td class="calculated-cell" ${attr?attr:''} data-month="${i}">${txt}</td>`).join('');}

  function buildMonthlyTables(){
    const revBody=qs('#revenueBody'), expBody=qs('#expenseBody');
    revBody.innerHTML=`
      <tr>
        <th>
          <details class="master-drop" id="prevMaster">
            <summary>Prev Year Actual (PTD)</summary>
            <div class="drop-panel">
              <div class="controls">
                <label>Month: <select id="prevMonthSelect">${MONTHS.map((m,i)=>`<option value="${i}">${m}</option>`).join('')}</select></label>
              </div>
              <div class="controls">
                <span class="kpi-chip">Rooms: <b id="prevKpiRooms">0</b></span>
                <span class="kpi-chip">ADR: <b id="prevKpiADR">$0</b></span>
                <span class="kpi-chip">OCC%: <b id="prevKpiOCC">0%</b></span>
              </div>
              <ul class="cat-list" id="prevCatList"><li><em>No categories yet.</em></li></ul>
            </div>
          </details>
        </th>
        ${Array.from({length:12},(_,i)=>`<td><span data-rev="prev-total-month" data-month="${i}">$0</span></td>`).join('')}
        <td class="calculated-cell"><span id="prevTotalAll">$0</span></td>
      </tr>
      <tr>
        <th>PTD KPIs (Prev Year)</th>
        ${Array.from({length:12},(_,i)=>`
          <td>
            <span class="kpi-chip">Rooms: <b data-rev="prev-kpi-rooms" data-month="${i}">0</b></span>
            <span class="kpi-chip">ADR: <b data-rev="prev-kpi-adr" data-month="${i}">$0</b></span>
            <span class="kpi-chip">OCC%: <b data-rev="prev-kpi-occ" data-month="${i}">0%</b></span>
          </td>`).join('')}
        <td class="calculated-cell">‚Äî</td>
      </tr>
      <tr>
        <th>
          <details class="master-drop" id="currMaster">
            <summary>Current Year Actual (PTD)</summary>
            <div class="drop-panel">
              <div class="controls">
                <label>Month: <select id="currMonthSelect">${MONTHS.map((m,i)=>`<option value="${i}">${m}</option>`).join('')}</select></label>
              </div>
              <div class="controls">
                <span class="kpi-chip">Rooms: <b id="currKpiRooms">0</b></span>
                <span class="kpi-chip">ADR: <b id="currKpiADR">$0</b></span>
                <span class="kpi-chip">OCC%: <b id="currKpiOCC">0%</b></span>
              </div>
              <ul class="cat-list" id="currCatList"><li><em>No categories yet.</em></li></ul>
            </div>
          </details>
        </th>
        ${Array.from({length:12},(_,i)=>`<td><span data-rev="curr-total-month" data-month="${i}">$0</span></td>`).join('')}
        <td class="calculated-cell"><span id="currTotalAll">$0</span></td>
      </tr>
      <tr>
        <th>PTD KPIs (Current Year)</th>
        ${Array.from({length:12},(_,i)=>`
          <td>
            <span class="kpi-chip">Rooms: <b data-rev="curr-kpi-rooms" data-month="${i}">0</b></span>
            <span class="kpi-chip">ADR: <b data-rev="curr-kpi-adr" data-month="${i}">$0</b></span>
            <span class="kpi-chip">OCC%: <b data-rev="curr-kpi-occ" data-month="${i}">0%</b></span>
          </td>`).join('')}
        <td class="calculated-cell">‚Äî</td>
      </tr>
      <tr><th>Budget (Revenue)</th>${mkCells(12,'input-cell','data-rev="budget"')}<td class="calculated-cell" data-rev="budget-total">$0</td></tr>
      <tr><th>Variance vs LY ($)</th>${mkCalc(12,'data-rev="var-ly"','$0')}<td class="calculated-cell" data-rev="var-ly-total">$0</td></tr>
      <tr><th>Variance vs LY (%)</th>${mkCalc(12,'data-rev="varpct-ly','0%')}<td class="calculated-cell" data-rev="varpct-ly-total">0%</td></tr>
      <tr><th>Variance vs Budget ($)</th>${mkCalc(12,'data-rev="var-bud"','$0')}<td class="calculated-cell" data-rev="var-bud-total">$0</td></tr>
      <tr><th>Variance vs Budget (%)</th>${mkCalc(12,'data-rev="varpct-bud"','0%')}<td class="calculated-cell" data-rev="varpct-bud-total">0%</td></tr>
    `;
    expBody.innerHTML=`
      <tr><th>Prev Year Expenses</th>${mkCells(12,'input-cell','data-exp="prev"')}<td class="calculated-cell" data-exp="prev-total">$0</td></tr>
      <tr><th>Current Year Actual</th>${mkCells(12,'input-cell','data-exp="curr"')}<td class="calculated-cell" data-exp="curr-total">$0</td></tr>
      <tr><th>Budget (Expenses)</th>${mkCells(12,'input-cell','data-exp="budget"')}<td class="calculated-cell" data-exp="budget-total">$0</td></tr>
      <tr><th>Variance vs LY ($)</th>${mkCalc(12,'data-exp="var-ly"','$0')}<td class="calculated-cell" data-exp="var-ly-total">$0</td></tr>
      <tr><th>Variance vs LY (%)</th>${mkCalc(12,'data-exp="varpct-ly"','0%')}<td class="calculated-cell" data-exp="varpct-ly-total">0%</td></tr>
      <tr><th>Variance vs Budget ($)</th>${mkCalc(12,'data-exp="var-bud"','$0')}<td class="calculated-cell" data-exp="var-bud-total">$0</td></tr>
      <tr><th>Variance vs Budget (%)</th>${mkCalc(12,'data-exp="varpct-bud"','0%')}<td class="calculated-cell" data-exp="varpct-bud-total">0%</td></tr>
    `;
    qs('#plBody').innerHTML=`
      <tr><th>Prev Year Operating Profit</th>${mkCalc(12,'data-pl="prev"','$0')}<td class="calculated-cell" data-pl="prev-total">$0</td></tr>
      <tr><th>Current Year Operating Profit</th>${mkCalc(12,'data-pl="curr"','$0')}<td class="calculated-cell" data-pl="curr-total">$0</td></tr>
      <tr><th>Budget Operating Profit</th>${mkCalc(12,'data-pl="budget"','$0')}<td class="calculated-cell" data-pl="budget-total">$0</td></tr>
      <tr><th>Variance vs LY ($)</th>${mkCalc(12,'data-pl="var-ly"','$0')}<td class="calculated-cell" data-pl="var-ly-total">$0</td></tr>
      <tr><th>Variance vs Budget ($)</th>${mkCalc(12,'data-pl="var-bud"','$0')}<td class="calculated-cell" data-pl="var-bud-total">$0</td></tr>
    `;
    els.revBudgetInputs=qsa('input[data-rev="budget"]');
    els.expPrevInputs=qsa('input[data-exp="prev"]');
    els.expCurrInputs=qsa('input[data-exp="curr"]');
    els.expBudgetInputs=qsa('input[data-exp="budget"]');
    els.revPrevMonthTotals=qsa('[data-rev="prev-total-month"]');
    els.revCurrMonthTotals=qsa('[data-rev="curr-total-month"]');
    els.revPrevTotalAll=qs('#prevTotalAll');
    els.revCurrTotalAll=qs('#currTotalAll');
    els.prevMonthSelect=qs('#prevMonthSelect');
    els.prevCatList=qs('#prevCatList');
    els.prevKpiRooms=qs('#prevKpiRooms');
    els.prevKpiADR=qs('#prevKpiADR');
    els.prevKpiOCC=qs('#prevKpiOCC');
    els.currMonthSelect=qs('#currMonthSelect');
    els.currCatList=qs('#currCatList');
    els.currKpiRooms=qs('#currKpiRooms');
    els.currKpiADR=qs('#currKpiADR');
    els.currKpiOCC=qs('#currKpiOCC');
    els.prevMonthSelect.addEventListener('change',()=>renderMasterPanel('prev', parseInt(els.prevMonthSelect.value,10)));
    els.currMonthSelect.addEventListener('change',()=>renderMasterPanel('curr', parseInt(els.currMonthSelect.value,10)));
  }
  buildMonthlyTables();

  /* ========= State ========= */
  let revBudget=Array(12).fill(0);
  let expPrev=Array(12).fill(0), expCurr=Array(12).fill(0), expBudget=Array(12).fill(0);
  function blankBreakdown(){ return { total:0, hasTotal:false, categories:{}, kpis:{rooms:0,adr:0,occ:0} }; }
  const revPrevBreakdowns=Array(12).fill(null).map(()=>blankBreakdown());
  const revCurrBreakdowns=Array(12).fill(null).map(()=>blankBreakdown());

  /* ========= Parsing (header period like 31Jan25) ========= */
  const RX_DATE_TOKEN=/\b(\d{2})([A-Za-z]{3})(\d{2})\b/;
  const MONTHS3=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  function cleanNumber(v){
    if(typeof v==='number') return v;
    const s=String(v||'').trim(); if(!s) return NaN;
    const neg=/\(.*\)/.test(s)||/^-/.test(s);
    const t=s.replace(/[^0-9.]/g,''); if(!t) return NaN;
    const n=Number(t); return Number.isFinite(n)?(neg?-Math.abs(n):n):NaN;
  }
  function numbersInLine(line){
    const re=/-?\(?\$?\d[\d,]*(?:\.\d+)?\)?/g; const out=[]; let m;
    while((m=re.exec(line))!==null) out.push(cleanNumber(m[0]));
    return out;
  }
  function getPTD(line){ const nums=numbersInLine(line); return Number.isFinite(nums[2])?nums[2]:NaN; }

  function parseShortDateToken(tok){
    const m=String(tok||'').match(RX_DATE_TOKEN); if(!m) return null;
    const d=parseInt(m[1],10); const mon=MONTHS3.indexOf(m[2]); const y=2000+parseInt(m[3],10);
    if(mon<0) return null; return new Date(Date.UTC(y,mon,d));
  }

  function getHeaderPeriod(text){
    // Look only at top ~25 lines for the ‚Äútop-left‚Äù header area
    const lines=text.split(/\r?\n/).slice(0,25);
    for(const ln of lines){
      const m=ln.match(RX_DATE_TOKEN);
      if(m){ const dt=parseShortDateToken(m[0]); if(dt) return {year:dt.getUTCFullYear(), month:dt.getUTCMonth()}; }
    }
    return null;
  }

  function inferMonthIndexFromText(text, filename){
    const header=getHeaderPeriod(text);
    if(header) return header.month;
    // fallback: filename like 20250131_RevReport.txt
    const m=(filename||'').match(/(\d{4})(\d{2})(\d{2})_RevReport/i);
    if(m) return Math.max(0, Math.min(11, Number(m[2])-1));
    return 0;
  }
  function inferYearFromText(text, filename){
    const header=getHeaderPeriod(text);
    if(header) return header.year;
    const m=(filename||'').match(/(\d{4})(\d{2})(\d{2})_RevReport/i);
    if(m) return Number(m[1]);
    // fallback to current input year
    return Number(qs('#dailyYear')?.value)||new Date().getFullYear();
  }

  const TOTAL_ROOM_SALES=/\bTOTAL\s+ROOM\s+SALES\b/i;
  const ROOMS_OCC=/\b#\s*ROOM(?:S|)\s*(?:NIGHTS\s*)?OCCUPIED|\b#\s*ROOMS\s*SOLD\b/i;
  const AVG_RATE=/\bAVG\s+RATE\s+PER\s+ROOM\b/i;
  const OCC_PCT=/\bOCC(?:UPANCY)?\s*(?:%|PCT)\b/i;
  const EXCLUDE_TOTALS=/\b(GROSS\s+HOTEL\s+SALES|TOTAL\s+HOTEL\s+REVENUE|GRAND\s+TOTAL)\b/i;
  const CAT_LINE=/^ROOMS?\s*-\s*([A-Za-z0-9 /&().-]+?)\s+[-,$()0-9.\s]+$/i;

  function parseRevReportText(text, filename){
    const monthIdx=inferMonthIndexFromText(text, filename);
    const year=inferYearFromText(text, filename);
    const bd={ total:0, hasTotal:false, categories:{}, kpis:{rooms:0,adr:0,occ:0}, year };

    const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    for(const lineRaw of lines){
      const line=lineRaw.replace(/\s+/g,' ').trim();
      if(!line) continue;
      if(EXCLUDE_TOTALS.test(line)) continue;

      if(TOTAL_ROOM_SALES.test(line)){
        const v=getPTD(line);
        if(Number.isFinite(v)){ bd.total=v; bd.hasTotal=true; }
        continue;
      }
      if(ROOMS_OCC.test(line)){
        const v=getPTD(line); if(Number.isFinite(v)) bd.kpis.rooms=v; continue;
      }
      if(AVG_RATE.test(line)){
        const v=getPTD(line); if(Number.isFinite(v)) bd.kpis.adr=v; continue;
      }
      if(OCC_PCT.test(line)){
        const v=getPTD(line);
        if(Number.isFinite(v)) bd.kpis.occ=(v>0&&v<=1)? v*100 : v;
        continue;
      }
      const cm=line.match(CAT_LINE);
      if(cm){
        const cat='Rooms - '+cm[1].replace(/\s+/g,' ').replace(/\b\w/g,c=>c.toUpperCase()).trim();
        const v=getPTD(line);
        if(Number.isFinite(v)) bd.categories[cat]=(bd.categories[cat]||0)+v;
      }
    }
    return {monthIdx, year, breakdown:bd};
  }

  /* ========= Upload wiring (multi-file) ========= */
  async function handleRevFiles(fileList, targetArray, selectEl){
    for(const f of fileList){
      try{
        const txt=await f.text();
        const {monthIdx, breakdown}=parseRevReportText(txt, f.name);
        targetArray[monthIdx]=breakdown; // assign by month
        flash(`Loaded: ${f.name} ‚Üí ${MONTHS[monthIdx]} ${breakdown.year}`);
      }catch(err){
        console.error('Parse error', f.name, err);
        flash(`Failed: ${f.name}`);
      }
    }
    if(selectEl && fileList.length){
      const last = fileList[fileList.length-1];
      const {monthIdx}=parseRevReportText(last.name, last.name); // filename fallback just for dropdown
      selectEl.value=String(monthIdx ?? 0);
    }
    calculateMonthly();
    if(qs('#autoSaveToggle').checked) saveToLocal(false);
  }
  qs('#prevYearRevUpload').addEventListener('change', e=>{
    if(!e.target.files?.length) return;
    handleRevFiles(e.target.files, revPrevBreakdowns, qs('#prevMonthSelect'));
  });
  qs('#currYearRevUpload').addEventListener('change', e=>{
    if(!e.target.files?.length) return;
    handleRevFiles(e.target.files, revCurrBreakdowns, qs('#currMonthSelect'));
  });

  /* ========= Chart ========= */
  let chart;
  function ensureChart(){
    if(chart) return chart;
    const ctx=qs('#revExpChart')?.getContext('2d'); if(!ctx) return null;
    chart=new Chart(ctx,{
      type:'bar',
      data:{labels:MONTHS,datasets:[
        {label:'Revenue (Current Year)',data:Array(12).fill(0),type:'bar'},
        {label:'Expenses (Current Year)',data:Array(12).fill(0),type:'bar'},
        {label:'Operating Profit',data:Array(12).fill(0),type:'line',tension:.3}
      ]},
      options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
        plugins:{legend:{position:'top'},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${fmtC(ctx.parsed.y)}`}}},
        scales:{y:{ticks:{callback:v=>fmtC(v)}}}
      }
    });
    return chart;
  }
  ensureChart();

  /* ========= Monthly calcs + painting ========= */
  function renderMasterPanel(series, monthIdx){
    const bd=(series==='prev'?revPrevBreakdowns[monthIdx]:revCurrBreakdowns[monthIdx])||blankBreakdown();
    const catList=series==='prev'?qs('#prevCatList'):qs('#currCatList');
    const kRooms =series==='prev'?qs('#prevKpiRooms'):qs('#currKpiRooms');
    const kADR   =series==='prev'?qs('#prevKpiADR'):qs('#currKpiADR');
    const kOCC   =series==='prev'?qs('#prevKpiOCC'):qs('#currKpiOCC');

    if(catList){
      const entries=Object.entries(bd.categories).sort((a,b)=>b[1]-a[1]);
      catList.innerHTML = entries.length
        ? entries.map(([k,v])=>`<li><span>${k}</span><b>${fmtC(v)}</b></li>`).join('')
        : `<li><em>No categories for ${MONTHS[monthIdx]}.</em></li>`;
    }
    if(kRooms) kRooms.textContent = Math.round(bd.kpis.rooms||0);
    if(kADR)   kADR.textContent   = fmtC(bd.kpis.adr||0);
    if(kOCC)   kOCC.textContent   = fmtP(bd.kpis.occ||0);
  }

  function calculateMonthly(){
    // read numeric inputs
    revBudget = qsa('input[data-rev="budget"]').map(i=>parseFloat(i.value)||0);
    expPrev   = qsa('input[data-exp="prev"]').map(i=>parseFloat(i.value)||0);
    expCurr   = qsa('input[data-exp="curr"]').map(i=>parseFloat(i.value)||0);
    expBudget = qsa('input[data-exp="budget"]').map(i=>parseFloat(i.value)||0);

    const revPrev=Array(12).fill(0), revCurr=Array(12).fill(0);
    for(let i=0;i<12;i++){
      const bp=revPrevBreakdowns[i]||blankBreakdown();
      const bc=revCurrBreakdowns[i]||blankBreakdown();
      revPrev[i]=bp.hasTotal?bp.total:sum(Object.values(bp.categories||{}));
      revCurr[i]=bc.hasTotal?bc.total:sum(Object.values(bc.categories||{}));
      const p=qs(`[data-rev="prev-total-month"][data-month="${i}"]`);
      const c=qs(`[data-rev="curr-total-month"][data-month="${i}"]`);
      if(p) p.textContent=fmtC(revPrev[i]||0);
      if(c) c.textContent=fmtC(revCurr[i]||0);

      const kpr=qs(`b[data-rev="prev-kpi-rooms"][data-month="${i}"]`);
      const kpa=qs(`b[data-rev="prev-kpi-adr"][data-month="${i}"]`);
      const kpo=qs(`b[data-rev="prev-kpi-occ"][data-month="${i}"]`);
      if(kpr) kpr.textContent=Math.round(bp.kpis.rooms||0);
      if(kpa) kpa.textContent=fmtC(bp.kpis.adr||0);
      if(kpo) kpo.textContent=fmtP(bp.kpis.occ||0);

      const kcr=qs(`b[data-rev="curr-kpi-rooms"][data-month="${i}"]`);
      const kca=qs(`b[data-rev="curr-kpi-adr"][data-month="${i}"]`);
      const kco=qs(`b[data-rev="curr-kpi-occ"][data-month="${i}"]`);
      if(kcr) kcr.textContent=Math.round(bc.kpis.rooms||0);
      if(kca) kca.textContent=fmtC(bc.kpis.adr||0);
      if(kco) kco.textContent=fmtP(bc.kpis.occ||0);
    }

    // totals
    const rp=sum(revPrev), rc=sum(revCurr), rb=sum(revBudget);
    const ep=sum(expPrev), ec=sum(expCurr), eb=sum(expBudget);
    if(qs('#prevTotalAll')) qs('#prevTotalAll').textContent=fmtC(rp);
    if(qs('#currTotalAll')) qs('#currTotalAll').textContent=fmtC(rc);
    qs('[data-exp="prev-total"]').textContent=fmtC(ep);
    qs('[data-exp="curr-total"]').textContent=fmtC(ec);
    qs('[data-rev="budget-total"]').textContent=fmtC(rb);
    qs('[data-exp="budget-total"]').textContent=fmtC(eb);

    // revenue variances
    const rVarLyCells=qsa('[data-rev="var-ly"]');
    const rVarPctLyCells=qsa('[data-rev="varpct-ly"]');
    const rVarBudCells=qsa('[data-rev="var-bud"]');
    const rVarPctBudCells=qsa('[data-rev="varpct-bud"]');
    let rVarLYTot=0, rVarBudTot=0;
    for(let i=0;i<12;i++){
      const dLY=(revCurr[i]||0)-(revPrev[i]||0);
      const dB =(revCurr[i]||0)-(revBudget[i]||0);
      rVarLYTot+=dLY; rVarBudTot+=dB;
      if(rVarLyCells[i]){ rVarLyCells[i].textContent=fmtC(dLY); addVarClass(rVarLyCells[i],dLY); }
      if(rVarPctLyCells[i]){ const p=(revPrev[i]>0)?(dLY/revPrev[i])*100:0; rVarPctLyCells[i].textContent=fmtP(p); addVarClass(rVarPctLyCells[i],p); }
      if(rVarBudCells[i]){ rVarBudCells[i].textContent=fmtC(dB); addVarClass(rVarBudCells[i],dB); }
      if(rVarPctBudCells[i]){ const p=(revBudget[i]>0)?(dB/revBudget[i])*100:0; rVarPctBudCells[i].textContent=fmtP(p); addVarClass(rVarPctBudCells[i],p); }
    }
    qs('[data-rev="var-ly-total"]').textContent=fmtC(rVarLYTot);
    qs('[data-rev="var-bud-total"]').textContent=fmtC(rVarBudTot);

    // expense variances (inverse)
    const eVarLyCells=qsa('[data-exp="var-ly"]');
    const eVarPctLyCells=qsa('[data-exp="varpct-ly"]');
    const eVarBudCells=qsa('[data-exp="var-bud"]');
    const eVarPctBudCells=qsa('[data-exp="varpct-bud"]');
    let eVarLYTot=0, eVarBudTot=0;
    for(let i=0;i<12;i++){
      const dLY=(expCurr[i]||0)-(expPrev[i]||0);
      const dB =(expCurr[i]||0)-(expBudget[i]||0);
      eVarLYTot+=dLY; eVarBudTot+=dB;
      if(eVarLyCells[i]){ eVarLyCells[i].textContent=fmtC(dLY); addVarClass(eVarLyCells[i],dLY,true); }
      if(eVarPctLyCells[i]){ const p=(expPrev[i]>0)?(dLY/expPrev[i])*100:0; eVarPctLyCells[i].textContent=fmtP(p); addVarClass(eVarPctLyCells[i],p,true); }
      if(eVarBudCells[i]){ eVarBudCells[i].textContent=fmtC(dB); addVarClass(eVarBudCells[i],dB,true); }
      if(eVarPctBudCells[i]){ const p=(expBudget[i]>0)?(dB/expBudget[i])*100:0; eVarPctBudCells[i].textContent=fmtP(p); addVarClass(eVarPctBudCells[i],p,true); }
    }
    qs('[data-exp="var-ly-total"]').textContent=fmtC(eVarLYTot);
    qs('[data-exp="var-bud-total"]').textContent=fmtC(eVarBudTot);

    // P&L
    const plPrev=MONTHS.map((_,i)=>(revPrev[i]||0)-(expPrev[i]||0));
    const plCurr=MONTHS.map((_,i)=>(revCurr[i]||0)-(expCurr[i]||0));
    const plBud =MONTHS.map((_,i)=>(revBudget[i]||0)-(expBudget[i]||0));
    const plPrevCells=qsa('[data-pl="prev"]');
    const plCurrCells=qsa('[data-pl="curr"]');
    const plBudgetCells=qsa('[data-pl="budget"]');
    const plVarLyCells=qsa('[data-pl="var-ly"]');
    const plVarBudCells=qsa('[data-pl="var-bud"]');
    for(let i=0;i<12;i++){
      if(plPrevCells[i]){ plPrevCells[i].textContent=fmtC(plPrev[i]); addVarClass(plPrevCells[i],plPrev[i]); }
      if(plCurrCells[i]){ plCurrCells[i].textContent=fmtC(plCurr[i]); addVarClass(plCurrCells[i],plCurr[i]); }
      if(plBudgetCells[i]){ plBudgetCells[i].textContent=fmtC(plBud[i]); addVarClass(plBudgetCells[i],plBud[i]); }
      if(plVarLyCells[i]){ const d=plCurr[i]-plPrev[i]; plVarLyCells[i].textContent=fmtC(d); addVarClass(plVarLyCells[i],d); }
      if(plVarBudCells[i]){ const d=plCurr[i]-plBud[i];  plVarBudCells[i].textContent=fmtC(d); addVarClass(plVarBudCells[i],d); }
    }
    qs('[data-pl="prev-total"]').textContent=fmtC(sum(plPrev));
    qs('[data-pl="curr-total"]').textContent=fmtC(sum(plCurr));
    qs('[data-pl="budget-total"]').textContent=fmtC(sum(plBud));

    const ch=ensureChart();
    if(ch){
      ch.data.datasets[0].data=MONTHS.map((_,i)=>(revCurr[i]||0));
      ch.data.datasets[1].data=MONTHS.map((_,i)=>(expCurr[i]||0));
      ch.data.datasets[2].data=MONTHS.map((_,i)=>((revCurr[i]||0)-(expCurr[i]||0)));
      ch.update();
    }

    if(qs('#prevMonthSelect')) renderMasterPanel('prev', parseInt(qs('#prevMonthSelect').value||'0',10));
    if(qs('#currMonthSelect')) renderMasterPanel('curr', parseInt(qs('#currMonthSelect').value||'0',10));
    if(qs('#autoSaveToggle').checked) saveToLocal(false);
  }

  qsa('#monthlyTab input[type="number"]').forEach(el=>el.addEventListener('input',calculateMonthly));

  /* ========= Save / Load ========= */
  const STORAGE_KEY='hotelTrackerV14';
  function gatherState(){
    return {
      revBudget,expPrev,expCurr,expBudget,
      revPrevBreakdowns,revCurrBreakdowns,
      prevSel:qs('#prevMonthSelect')?.value??'0',
      currSel:qs('#currMonthSelect')?.value??'0',
      dailyData
    };
  }
  function applyState(s){
    if(!s) return;
    if(Array.isArray(s.revBudget)) revBudget=s.revBudget.map(Number);
    if(Array.isArray(s.expPrev))   expPrev=s.expPrev.map(Number);
    if(Array.isArray(s.expCurr))   expCurr=s.expCurr.map(Number);
    if(Array.isArray(s.expBudget)) expBudget=s.expBudget.map(Number);
    if(Array.isArray(s.revPrevBreakdowns)) s.revPrevBreakdowns.forEach((bd,i)=>{ if(bd) revPrevBreakdowns[i]=bd; });
    if(Array.isArray(s.revCurrBreakdowns)) s.revCurrBreakdowns.forEach((bd,i)=>{ if(bd) revCurrBreakdowns[i]=bd; });
    if(s.dailyData) dailyData=s.dailyData;

    qsa('input[data-rev="budget"]').forEach((el,i)=>{ el.value=revBudget[i]||''; });
    qsa('input[data-exp="prev"]').forEach((el,i)=>{ el.value=expPrev[i]||''; });
    qsa('input[data-exp="curr"]').forEach((el,i)=>{ el.value=expCurr[i]||''; });
    qsa('input[data-exp="budget"]').forEach((el,i)=>{ el.value=expBudget[i]||''; });

    if(qs('#prevMonthSelect') && s.prevSel!=null) qs('#prevMonthSelect').value=String(s.prevSel);
    if(qs('#currMonthSelect') && s.currSel!=null) qs('#currMonthSelect').value=String(s.currSel);

    renderDailyTable();
    recalcDailyRollups(); // triggers monthly
  }
  function saveToLocal(toast=true){ localStorage.setItem(STORAGE_KEY, JSON.stringify(gatherState())); if(toast) flash('Saved.'); }
  function loadFromLocal(){
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw){ flash('Nothing saved yet.'); calculateMonthly(); return; }
    try{ applyState(JSON.parse(raw)); flash('Loaded.'); }catch(e){ console.error(e); flash('Load failed.'); calculateMonthly(); }
  }
  function exportJSON(){
    const blob=new Blob([JSON.stringify(gatherState(),null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`hotel-tracker-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove();
  }
  function importJSON(file){
    const r=new FileReader();
    r.onload=e=>{ try{ applyState(JSON.parse(e.target.result)); flash('Imported.'); }catch(err){ console.error(err); flash('Import failed.'); } };
    r.readAsText(file);
  }
  function resetAll(){
    if(!confirm('Reset all inputs and parsed data?')) return;
    revBudget=Array(12).fill(0); expPrev=Array(12).fill(0); expCurr=Array(12).fill(0); expBudget=Array(12).fill(0);
    for (let i=0;i<12;i++){ revPrevBreakdowns[i]=blankBreakdown(); revCurrBreakdowns[i]=blankBreakdown(); }
    dailyData={};
    qsa('input[data-rev="budget"],input[data-exp="prev"],input[data-exp="curr"],input[data-exp="budget"]').forEach(el=>el.value='');
    renderDailyTable(); calculateMonthly(); flash('Reset.');
  }

  qs('#saveBtn').addEventListener('click',()=>saveToLocal(true));
  qs('#loadBtn').addEventListener('click',loadFromLocal);
  qs('#exportBtn').addEventListener('click',exportJSON);
  qs('#importFile').addEventListener('change',e=>{ if(e.target.files?.[0]) importJSON(e.target.files[0]); });
  qs('#resetBtn').addEventListener('click',resetAll);

  // Toast
  let toastEl;
  function flash(msg){
    if(!toastEl){
      toastEl=document.createElement('div');
      Object.assign(toastEl.style,{position:'fixed',bottom:'18px',left:'50%',transform:'translateX(-50%)',padding:'10px 14px',background:'rgba(44,62,80,.95)',color:'#fff',borderRadius:'10px',boxShadow:'0 8px 20px rgba(0,0,0,.2)',zIndex:'9999',transition:'opacity .25s ease'});
      document.body.appendChild(toastEl);
    }
    toastEl.textContent=msg; toastEl.style.opacity='1'; setTimeout(()=>{ toastEl.style.opacity='0'; },1400);
  }

  // ========= PDF EXPORT (Landscape + Variance) =========
  qs('#pdfBtn').addEventListener('click', downloadPDF);

  async function downloadPDF(){
    try{
      // Ensure chart and data are up to date
      calculateMonthly();

      const { jsPDF } = window.jspdf;
      // LANDSCAPE for wide tables (Letter 792x612)
      const doc = new jsPDF({ unit:'pt', format:'letter', orientation:'landscape' });

      const margin = 40;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const usable = pageWidth - margin*2;
      const now = new Date();
      const ySel = Number(qs('#dailyYear').value)||now.getFullYear();
      const gmAvg = qs('#gmAccuracyAvg')?.textContent || '‚Äî';

      // Assemble arrays for PDF data
      const revPrev=Array(12).fill(0), revCurr=Array(12).fill(0);
      for(let i=0;i<12;i++){
        const bp=revPrevBreakdowns[i]||blankBreakdown();
        const bc=revCurrBreakdowns[i]||blankBreakdown();
        revPrev[i]=bp.hasTotal?bp.total:sum(Object.values(bp.categories||{}));
        revCurr[i]=bc.hasTotal?bc.total:sum(Object.values(bc.categories||{}));
      }
      const rb = qsa('input[data-rev="budget"]').map(i=>parseFloat(i.value)||0);
      const ep = qsa('input[data-exp="prev"]').map(i=>parseFloat(i.value)||0);
      const ec = qsa('input[data-exp="curr"]').map(i=>parseFloat(i.value)||0);
      const eb = qsa('input[data-exp="budget"]').map(i=>parseFloat(i.value)||0);

      const plCurr = MONTHS.map((_,i)=>(revCurr[i]||0)-(ec[i]||0));

      // Revenue variance vs LY
      const rv$ = MONTHS.map((_,i)=>(revCurr[i]||0)-(revPrev[i]||0));
      const rvPct = MONTHS.map((_,i)=>{
        const prev = revPrev[i]||0;
        return prev>0 ? (rv$[i]/prev)*100 : 0;
      });
      const totalRv$ = sum(rv$);
      const totalRvPct = (sum(revPrev)>0) ? (totalRv$/sum(revPrev))*100 : 0;

      // ---------- COVER HEADER ----------
      doc.setFillColor(52,73,94); // dark header band
      doc.rect(0,0,pageWidth,70,'F');
      doc.setFont('helvetica','bold');
      doc.setFontSize(18);
      doc.setTextColor(255,255,255);
      doc.text('Hotel Revenue ¬∑ P&L ¬∑ Daily (SDOWLY)', margin, 45);

      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.text(`Generated: ${now.toLocaleString()}`, pageWidth - margin, 45, { align:'right' });

      // Title block
      let y = 95;
      doc.setTextColor(44,62,80);
      doc.setFontSize(16);
      doc.text(`Summary Report ‚Äî ${ySel}`, margin, y);
      y += 10;
      doc.setDrawColor(220);
      doc.line(margin, y, pageWidth-margin, y);
      y += 18;

      // KPI row (3 cards)
      const boxW = (usable - 20) / 3;
      const kpis = [
        { label: 'CY Revenue (Sum)', value: fmtC(sum(revCurr)) },
        { label: 'CY Expenses (Sum)', value: fmtC(sum(ec)) },
        { label: 'Operating Profit (Sum)', value: fmtC(sum(plCurr)) }
      ];
      doc.setFontSize(11);
      kpis.forEach((k,i)=>{
        const x = margin + i*(boxW+10);
        doc.setDrawColor(230);
        doc.setFillColor(247,249,252);
        doc.roundedRect(x, y, boxW, 44, 6, 6, 'FD');
        doc.setTextColor(127,140,141);
        doc.text(k.label, x+12, y+18);
        doc.setTextColor(33,45,61);
        doc.setFont('helvetica','bold');
        doc.setFontSize(12);
        doc.text(k.value, x+12, y+34);
        doc.setFont('helvetica','normal');
        doc.setFontSize(11);
      });
      y += 64;

      // GM Accuracy chip
      doc.setFontSize(11);
      doc.setTextColor(127,140,141);
      doc.text('GM Accuracy (Daily Avg):', margin, y);
      doc.setTextColor(33,45,61);
      doc.setFont('helvetica','bold');
      doc.text(String(gmAvg||'‚Äî'), margin+175, y);
      doc.setFont('helvetica','normal');

      y += 12;

      // ---------- CHART ----------
      const ch = ensureChart();
      if(ch && ch.toBase64Image){
        const img = ch.toBase64Image();
        const imgW = usable;
        const imgH = imgW * 0.45; // aspect hint
        y += 10;
        doc.addImage(img, 'PNG', margin, y, imgW, imgH, undefined, 'FAST');
        y += imgH + 20;
      }

      // ---------- TABLES ----------
      function table(title, head, rows){
        doc.setFontSize(13);
        doc.setTextColor(44,62,80);
        doc.setFont('helvetica','bold');
        doc.text(title, margin, y);
        doc.setFont('helvetica','normal');
        y += 6;

        doc.autoTable({
          head: [head],
          body: rows,
          theme: 'grid',
          startY: y,
          styles: { fontSize: 9, cellPadding: 4 },
          headStyles: { fillColor: [52,152,219], textColor: 255, halign:'center' },
          columnStyles: { 0: { cellWidth: 120 }},
          margin: { left: margin, right: margin },
          didDrawPage: ({ pageNumber })=>{
            // footer
            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text(`Page ${pageNumber}`, pageWidth - margin, pageHeight - 15, { align:'right' });
          }
        });
        y = doc.lastAutoTable.finalY + 18;
      }

      const headMonths = ['Metric', ...MONTHS, 'Total'];

      // Revenue table
      const revRows = [
        ['Prev Year (PTD)', ...MONTHS.map((_,i)=>fmtC(revPrev[i]||0)), fmtC(sum(revPrev))],
        ['Current Year (PTD)', ...MONTHS.map((_,i)=>fmtC(revCurr[i]||0)), fmtC(sum(revCurr))],
        ['Budget (Revenue)', ...MONTHS.map((_,i)=>fmtC(rb[i]||0)), fmtC(sum(rb))]
      ];
      table('Revenue', headMonths, revRows);

      // NEW: Revenue Variance vs LY
      const varianceRows = [
        ['Var vs LY ($)', ...MONTHS.map((_,i)=>fmtC((revCurr[i]||0)-(revPrev[i]||0))), fmtC((sum(revCurr)-sum(revPrev)))],
        ['Var vs LY (%)', ...MONTHS.map((_,i)=>{
          const prev = revPrev[i]||0;
          const d = (revCurr[i]||0)-(prev);
          return prev>0 ? fmtP((d/prev)*100) : '0.0%';
        }), (()=>{ const prevT=sum(revPrev)||0; const d=sum(revCurr)-prevT; return prevT>0?fmtP((d/prevT)*100):'0.0%'; })()]
      ];
      table('Revenue Variance vs LY', headMonths, varianceRows);

      // Expenses table
      const expRows = [
        ['Prev Year Expenses', ...MONTHS.map((_,i)=>fmtC(ep[i]||0)), fmtC(sum(ep))],
        ['Current Year Expenses', ...MONTHS.map((_,i)=>fmtC(ec[i]||0)), fmtC(sum(ec))],
        ['Budget (Expenses)', ...MONTHS.map((_,i)=>fmtC(eb[i]||0)), fmtC(sum(eb))]
      ];
      table('Expenses', headMonths, expRows);

      // P&L table
      const plPrev = MONTHS.map((_,i)=>(revPrev[i]||0)-(ep[i]||0));
      const plBud  = MONTHS.map((_,i)=>(rb[i]||0)-(eb[i]||0));
      const plRows = [
        ['Prev Year Operating Profit', ...plPrev.map(v=>fmtC(v)), fmtC(sum(plPrev))],
        ['Current Year Operating Profit', ...MONTHS.map((_,i)=>fmtC((revCurr[i]||0)-(ec[i]||0))), fmtC(sum(MONTHS.map((_,i)=>(revCurr[i]||0)-(ec[i]||0))))],
        ['Budget Operating Profit', ...plBud.map(v=>fmtC(v)), fmtC(sum(plBud))]
      ];
      table('Operating P&L', headMonths, plRows);

      doc.save(`Hotel_Report_${ySel}_landscape.pdf`);
      flash('PDF downloaded.');
    }catch(err){
      console.error(err);
      flash('PDF export failed.');
    }
  }

  // Boot: auto-load state from this device, then calc once
  loadFromLocal();        // pulls saved Rev/Exp files, budgets, and daily data back into the UI
  calculateMonthly();     // safe even if no save exists

  // Save on tab close/refresh if Auto-save is ON
  window.addEventListener('beforeunload', () => {
    if (qs('#autoSaveToggle').checked) saveToLocal(false);
  });
})();
</script>
</body>
</html>
