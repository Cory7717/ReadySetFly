<!-- /public/otb-pickup.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OTB Pickup ‚Äî Daily Booking Stats + Revenue</title>

<!-- PDF libs (deferred so they‚Äôre ready by the time the page is interactive) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
<!-- Small compressor for share links -->
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js" defer></script>

<style>
  :root{
    --ink:#2c3e50; --ink-soft:#7f8c8d; --bg:#f5f7ff; --panel:#ffffff;
    --brand:#3498db; --brand-d:#2c80bb; --edge:#e6ecf7; --edge-2:#dfe7f5;
    --chip:#eef3fb; --ok:#2ecc71; --warn:#f39c12; --bad:#c0392b; --good:#27ae60;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Segoe UI',system-ui,-apple-system,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg); margin:0; color:var(--ink); padding:24px;
  }
  .header{
    background:#34495e; color:#fff; padding:20px; border-radius:14px;
    margin-bottom:16px; box-shadow:0 6px 16px rgba(0,0,0,.08)
  }
  .header h1{margin:0; font-size:20px; font-weight:800; letter-spacing:.2px}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:18px}
  .pill{
    background:var(--panel); border:1px solid var(--edge); border-radius:999px;
    padding:6px 10px; display:flex; align-items:center; gap:8px;
    box-shadow:0 2px 8px rgba(0,0,0,.03)
  }
  .pill select,
  .pill input[type="month"],
  .pill input[type="search"],
  .pill input[type="number"],
  .pill input[type="date"]{
    border:none; outline:none; background:transparent; color:var(--ink);
    font-size:14px; padding:4px 2px
  }
  .pill input[type="number"]{width:90px}
  .btn{
    padding:8px 12px; border-radius:10px; border:1px solid var(--edge);
    cursor:pointer; background:var(--panel); font-weight:600;
    transition:.15s ease-in-out; box-shadow:0 2px 8px rgba(0,0,0,.03)
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
  .btn.primary:hover{background:var(--brand-d)}

  .cards{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:10px; margin-bottom:10px
  }
  .card{
    background:var(--panel); border:1px solid var(--edge-2); border-radius:14px;
    padding:12px; box-shadow:0 6px 16px rgba(0,0,0,.06)
  }
  .card h3{margin:0 0 6px; font-size:13px; color:#5d6d7e; font-weight:700; text-transform:uppercase; letter-spacing:.5px}
  .card .big{font-size:22px; font-weight:800}
  .sub{font-size:12px; color:#7f8c8d; margin-top:4px}

  table{
    border-collapse:separate; border-spacing:0; width:100%; margin:10px 0 12px;
    font-size:14px; overflow:hidden; border-radius:12px; border:1px solid var(--edge)
  }
  thead th{
    position:sticky; top:0; z-index:1; background:#f8fbff; border-bottom:1px solid var(--edge);
    padding:10px 8px; font-weight:800; text-align:center; white-space:nowrap
  }
  th.left{text-align:left}
  tbody td, tbody th{border-top:1px solid var(--edge); padding:10px 8px; text-align:center; background:#fff}
  tbody tr:nth-child(2n) td, tbody tr:nth-child(2n) th{background:#fcfdff}

  .status.actual{color:#fff;background:var(--ok); padding:2px 8px; border-radius:999px; font-size:12px}
  .status.otb{color:#fff;background:var(--warn); padding:2px 8px; border-radius:999px; font-size:12px}
  .delta.pos{color:var(--ok); font-weight:700}
  .delta.neg{color:var(--bad); font-weight:700}

  input.hours{
    width:110px; padding:6px 8px; border:1px solid var(--edge); border-radius:10px; outline:none;
    box-shadow:inset 0 1px 3px rgba(0,0,0,.03)
  }
  input.hours:focus{border-color:var(--brand); box-shadow:0 0 0 3px rgba(52,152,219,.12), inset 0 1px 3px rgba(0,0,0,.03)}

  /* Pickup highlights on Date cell */
  .flag{font-size:12px; margin-left:6px; padding:2px 6px; border-radius:999px; color:#fff}
  .flag-pos{background:var(--good)}
  .flag-neg{background:var(--bad)}
  th.left.flagged-pos{box-shadow: inset 0 -2px 0 var(--good)}
  th.left.flagged-neg{box-shadow: inset 0 -2px 0 var(--bad)}

  /* Expander */
  .expander{
    appearance:none; border:none; background:transparent; cursor:pointer; padding:0 6px 0 0; margin:0 6px 0 0;
    line-height:1; vertical-align:middle;
  }
  .chev{
    display:inline-block; width:10px; height:10px; border-right:2px solid currentColor; border-bottom:2px solid currentColor;
    transform:rotate(-45deg); transition:transform .15s ease-in-out;
  }
  .expander[aria-expanded="true"] .chev{ transform:rotate(45deg) }

  .expand-row td{
    background:#fbfdff;
    border-top:1px dashed var(--edge);
    padding:14px 12px;
  }
  .expand-panel{
    display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  .expand-panel .group{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .mini{
    display:inline-block; padding:6px 10px; border:1px solid var(--edge); border-radius:10px; background:#fff;
  }
  .mini input{
    width:90px; padding:6px 8px; border:1px solid var(--edge); border-radius:8px; outline:none;
  }
  .mini label{font-size:12px; color:#6c7a89; display:block; margin-bottom:4px}
  .chip{
    display:inline-block; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--edge);
    font-size:12px; color:#415162; font-weight:600;
  }

  #hostEmpty{
    padding:24px; border:2px dashed var(--edge); border-radius:14px; text-align:center; color:#7f8c8d; background:rgba(255,255,255,.6)
  }

  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:999;
  }
  .modal{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000;
  }
  .modal.show, .modal-backdrop.show{display:flex}
  .modal .sheet{
    width:min(920px, 92vw); max-height:82vh; overflow:auto;
    background:#fff; border:1px solid var(--edge-2); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.25);
    padding:18px;
  }
  .modal h2{margin:0 0 8px; font-size:18px}
  .modal .close{
    position:absolute; top:10px; right:14px; background:#fff; border:1px solid var(--edge);
    border-radius:999px; padding:6px 10px; cursor:pointer; font-weight:700;
  }
  .modal .section{margin:10px 0 14px}
  .modal ul{margin:8px 0 0 18px}
  .kbd{
    display:inline-block; padding:2px 6px; border:1px solid var(--edge-2); border-bottom-width:2px; border-radius:6px; background:#fafbff;
    font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;
  }
  .inline-chip{
    display:inline-block; padding:2px 8px; border-radius:999px; background:#eef3fb; border:1px solid var(--edge);
    font-size:12px; color:#415162; font-weight:600;
  }

  /* Toast (filename tips & share confirmations) */
  .toast-wrap{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:1100}
  .toast{
    background:#ffffff; border:1px solid var(--edge-2); border-left:4px solid var(--warn);
    box-shadow:0 8px 24px rgba(0,0,0,.1); padding:10px 12px; border-radius:10px; max-width:420px; font-size:13px;
  }
  .toast.ok{border-left-color:var(--ok)}
  .toast.info{border-left-color:var(--brand)}

  /* PDF summary panel (kept in-viewport but invisible so html2canvas/jspdf can capture it) */
  #pdfSummary{
    position:fixed;
    left:0; top:0;
    width:800px;
    opacity:0;
    pointer-events:none;
    z-index:-1;
    background:#fff; color:#263238; padding:24px; border:1px solid #eef2f7; border-radius:12px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  #pdfSummary h1{font-size:20px; margin:0 0 6px; font-weight:800}
  #pdfSummary h2{font-size:16px; margin:16px 0 8px; font-weight:800}
  #pdfSummary .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px}
  #pdfSummary .k{border:1px solid #e7edf6; border-radius:12px; padding:10px; background:#fafcff;}
  #pdfSummary .k .label{font-size:11px; text-transform:uppercase; color:#64748b; font-weight:700; letter-spacing:.3px}
  #pdfSummary .k .val{font-size:20px; font-weight:800; margin-top:4px}
  #pdfSummary ul{margin:6px 0 0 18px}
  #pdfSummary .muted{color:#6b7a8c; font-size:12px}
</style>
</head>
<body>
  <div class="header">
    <h1>üìà OTB Pickup ‚Äî Booking Stats + Revenue</h1>
  </div>

  <div class="toolbar">
    <button class="btn" id="btnHelp" type="button">Instructions to use</button>

    <label class="btn" for="logoInput">Upload Logo (PNG/SVG)</label>
    <input id="logoInput" type="file" accept="image/*" style="display:none"/>

    <label class="btn primary" for="bsInputCur">Upload Current Day Booking Stats (.txt)</label>
    <input id="bsInputCur" type="file" accept=".txt" style="display:none"/>

    <label class="btn" for="bsInputPrev">Upload Previous Day Booking Stats (.txt)</label>
    <input id="bsInputPrev" type="file" accept=".txt" style="display:none"/>

    <label class="btn" for="revInput">Upload Revenue Reports (.txt, multi)</label>
    <input id="revInput" type="file" accept=".txt" multiple style="display:none"/>

    <div class="pill">
      <span>Hotel:</span>
      <select id="hotelSelect" aria-label="Hotel">
        <option value="MCR-ATX">MCR-ATX (Austin FFI)</option>
        <option value="MCR-DFW">MCR-DFW</option>
        <option value="MCR-JFK">MCR-JFK</option>
      </select>
    </div>

    <div class="pill">
      <span>Month:</span>
      <input id="monthInput" type="month" value="2025-09" aria-label="Month"/>
    </div>

    <!-- NEW: Hotel Total Rooms (used for Occupancy %) -->
    <div class="pill" title="Total physical rooms at the hotel">
      <span>Total Rooms:</span>
      <input id="hotelRooms" type="number" min="1" step="1" placeholder="e.g., 134" aria-label="Total rooms in hotel"/>
    </div>

    <div class="pill">
      <span>Range:</span>
      <select id="rangeMode" aria-label="Range mode">
        <option value="month">Entire Month</option>
        <option value="custom">Custom</option>
      </select>
      <input id="rangeStart" type="date" disabled aria-label="Start date"/>
      <span>‚Äì</span>
      <input id="rangeEnd" type="date" disabled aria-label="End date"/>
    </div>

    <div class="pill">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input id="compareToggle" type="checkbox"/>
        <span>Compare OTB vs baseline</span>
      </label>
    </div>

    <div class="pill">
      <span>Filter:</span>
      <input id="filterInput" type="search" placeholder="Type to filter dates‚Ä¶">
    </div>

    <button class="btn" id="btnDownload">Download CSV</button>
    <button class="btn" id="btnPDF">Download PDF</button>

    <!-- NEW: share/backup -->
    <button class="btn" id="btnShare">Create Share Link</button>
    <button class="btn" id="btnExport">Export Snapshot</button>
    <label class="btn" for="importInput">Import Snapshot</label>
    <input id="importInput" type="file" accept="application/json" style="display:none"/>
  </div>

  <div class="cards">
    <div class="card"><h3>Actual Rooms (Range)</h3><div class="big" id="kRooms">‚Äî</div></div>
    <div class="card"><h3>Actual Room Rev (Range)</h3><div class="big" id="kRev">‚Äî</div></div>
    <div class="card"><h3>Rem. OTB Rev (Range)</h3><div class="big" id="kOTB">‚Äî</div></div>
    <div class="card"><h3>Month (Actual + OTB)</h3><div class="big" id="kTotal">‚Äî</div></div>
    <div class="card"><h3>Rem. OTB Rooms (Range)</h3><div class="big" id="kOTBRooms">‚Äî</div></div>

    <!-- UPDATED: Month Rooms card now includes Occupancy % -->
    <div class="card">
      <h3>Month Rooms (Actual + OTB)</h3>
      <div class="big" id="kTotalRooms">‚Äî</div>
      <div class="sub" id="kOccPct">‚Äî</div>
    </div>

    <div class="card"><h3>Month ADR (Actual + OTB)</h3><div class="big" id="kMonthADR">‚Äî</div></div>
    <div class="card"><h3>Salaried Hours (Range)</h3><div class="big" id="kHoursSal">‚Äî</div></div>
    <div class="card"><h3>Straight Hours (Range)</h3><div class="big" id="kHoursStr">‚Äî</div></div>
    <div class="card"><h3>Total Hours (Range)</h3><div class="big" id="kHoursRange">‚Äî</div></div>
    <div class="card"><h3>HPOR (Range)</h3><div class="big" id="kHPORRange">‚Äî</div></div>

    <div class="card">
      <h3>Pickup Rooms (OTB vs Baseline)</h3>
      <div class="big" id="kPickupRooms">‚Äî</div>
      <div class="sub" id="kPickupLabel">‚Äî</div>
    </div>
    <div class="card">
      <h3>Pickup Rev (OTB vs Baseline)</h3>
      <div class="big" id="kPickupRev">‚Äî</div>
      <div class="sub">Same range as above</div>
    </div>

    <div class="card">
      <h3>MPOR (vs 25 minutes)</h3>
      <div class="big" id="kMPOR">‚Äî</div>
      <div class="sub" id="kMPORVar">‚Äî</div>
    </div>

    <div class="card">
      <h3>Total Month Pickup</h3>
      <div class="big" id="kMonthPickup">‚Äî</div>
      <div class="sub" id="kMonthPickupNote">vs first upload</div>
    </div>
  </div>

  <div id="host"><div id="hostEmpty">Upload Booking Stats (Current & Previous) and one or more Revenue Reports.</div></div>

  <table id="grid" style="display:none">
    <thead>
      <tr>
        <th class="left">Date</th>
        <th>Status</th>
        <th>Rooms</th>
        <th>ADR</th>
        <th>Room Rev</th>
        <th>Sal Hrs</th>
        <th>Straight Hrs</th>
        <th>Total Hrs</th>
        <th>HPOR</th>
        <th class="no-print">Œî Rooms</th>
        <th class="no-print">Œî Rev</th>
      </tr>
    </thead>
    <tbody id="gridBody"></tbody>
  </table>

  <!-- Help Modal -->
  <div class="modal-backdrop" id="helpBackdrop" aria-hidden="true"></div>
  <div class="modal" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" aria-describedby="helpBody">
    <div class="sheet">
      <button class="close" id="helpClose" type="button">√ó</button>
      <h2 id="helpTitle">Instructions to use (FOSSE ‚Äì Marriott)</h2>
      <div id="helpBody">
        <div class="section">
          <strong>What this page does</strong>
          <ul>
            <li>Combines <span class="inline-chip">Booking Stats (OTB)</span> from FOSSE with your <span class="inline-chip">Daily Revenue Reports</span>.</li>
            <li>Lets you add <span class="inline-chip">Labor Hours</span> and <span class="inline-chip">Housekeeping details</span> (HK hours, CO, SO, DND) to compute HPOR &amp; MPOR.</li>
            <li>Shows OTB pickup vs a baseline (yesterday or a file you upload as <em>Previous Day Booking Stats</em>).</li>
            <li><b>Share data</b>: Use <span class="inline-chip">Create Share Link</span> or <span class="inline-chip">Export/Import Snapshot</span> so others can view your exact data without re-uploading.</li>
          </ul>
        </div>

        <div class="section">
          <strong>Files to export from FOSSE</strong>
          <ul>
            <li><b>Booking Stats</b>: Export to <span class="kbd">.txt</span> (with ‚ÄúBeginning ‚Ä¶ Through ‚Ä¶‚Äù header and Sold / Avg Rate / Room Revenue columns).</li>
            <li><b>Daily Revenue Report (Rooms)</b>: Export to <span class="kbd">.txt</span> containing <em>TOTAL ROOM SALES</em>, <em># ROOMS OCCUPIED</em>, <em>AVG RATE PER ROOM</em>.</li>
          </ul>
        </div>

        <div class="section">
          <strong>Upload flow</strong>
          <ol>
            <li>Upload <b>Current Day Booking Stats</b> (month snapshot).</li>
            <li>Optionally upload <b>Previous Day Booking Stats</b> to set baseline.</li>
            <li>Upload one or more <b>Revenue</b> reports.</li>
          </ol>
          <p><em>Suggested filenames:</em> <span class="kbd">YYYYMMDD_BookingStats.txt</span>, <span class="kbd">YYYYMMDD_RevReport.txt</span></p>
        </div>

        <div class="section">
          <strong>Manual inputs</strong>
          <ul>
            <li>Enter <b>Salaried/Straight Hours</b> per day.</li>
            <li>Open ‚ñº on a date to add HK inputs (<b>HK Hours</b>, <b>CO</b>, <b>SO</b>, <b>DND</b>). <b>MPOR = (HK Hours √ó 60) √∑ (CO + SO ‚àí DND)</b>.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Off-screen PDF summary node (kept invisible but measurable) -->
  <div id="pdfSummary" aria-hidden="true"></div>
<script>
(function(){
  // ---------- DOM (core)
  const logoInput   = document.getElementById('logoInput');
  const bsInputCur  = document.getElementById('bsInputCur');
  const bsInputPrev = document.getElementById('bsInputPrev');
  const revInput    = document.getElementById('revInput');
  const monthInput  = document.getElementById('monthInput');
  const rangeMode   = document.getElementById('rangeMode');
  const rangeStart  = document.getElementById('rangeStart');
  const rangeEnd    = document.getElementById('rangeEnd');
  const hotelSel    = document.getElementById('hotelSelect');
  const host        = document.getElementById('host');
  const grid        = document.getElementById('grid');
  const gridBody    = document.getElementById('gridBody');
  const filterInput = document.getElementById('filterInput');
  const compareToggle = document.getElementById('compareToggle');
  const btnDownload = document.getElementById('btnDownload');
  const btnPDF      = document.getElementById('btnPDF');

  // NEW share/import/export buttons
  const btnShare    = document.getElementById('btnShare');
  const btnExport   = document.getElementById('btnExport');
  const importInput = document.getElementById('importInput');

  // Help modal
  const btnHelp = document.getElementById('btnHelp');
  const helpModal = document.getElementById('helpModal');
  const helpBackdrop = document.getElementById('helpBackdrop');
  const helpClose = document.getElementById('helpClose');
  const toastWrap = document.getElementById('toastWrap');

  // KPIs
  const kRooms = document.getElementById('kRooms');
  const kRev = document.getElementById('kRev');
  const kOTB = document.getElementById('kOTB');
  const kTotal = document.getElementById('kTotal');
  const kOTBRooms = document.getElementById('kOTBRooms');
  const kTotalRooms = document.getElementById('kTotalRooms');
  const kMonthADR = document.getElementById('kMonthADR');
  const kHoursSal = document.getElementById('kHoursSal');
  const kHoursStr = document.getElementById('kHoursStr');
  const kHoursRange = document.getElementById('kHoursRange');
  const kHPORRange = document.getElementById('kHPORRange');
  const kPickupRooms = document.getElementById('kPickupRooms');
  const kPickupRev = document.getElementById('kPickupRev');
  const kPickupLabel = document.getElementById('kPickupLabel');
  const kMPOR = document.getElementById('kMPOR');
  const kMPORVar = document.getElementById('kMPORVar');
  const kMonthPickup = document.getElementById('kMonthPickup');
  const kMonthPickupNote = document.getElementById('kMonthPickupNote');

  // NEW: Hotel total rooms input + Occupancy % node
  const hotelRooms = document.getElementById('hotelRooms');
  const kOccPct    = document.getElementById('kOccPct');

  // ---------- State
  let bookingStatsCur = null;  // current upload
  let bookingStatsPrev = null; // previous-day (baseline) upload
  let revenueByDay = {};       // { 'YYYY-MM-DD': {rooms, adr, rev} }
  let merged = [];             // full month rows
  let laborMap = {};           // { 'YYYY-MM-DD': {sal:number, str:number} }
  let hkMap = {};              // { 'YYYY-MM-DD': {hkHrs:number, co:number, so:number, dnd:number} }
  let baselineInfo = { snap:null, label:null };
  let logoDataUrl = null;      // Brand logo for PDF header

  const DELTA_TH = 7;  // rooms pickup threshold
  const MPOR_STD = 25; // minutes

  // ---------- Keys
  const SNAPKEY  = (hotel, ym) => `pickup:bs:${hotel}:${ym}`;
  const SNAPDAY  = (hotel, ym, dayISO) => `pickup:bs:${hotel}:${ym}:${dayISO}`;
  const SNAPINDEX= (hotel, ym) => `pickup:bs:index:${hotel}:${ym}`;
  const BS_CUR   = (hotel, ym) => `pickup:bs:current:${hotel}:${ym}`;
  const BS_PREV  = (hotel, ym) => `pickup:bs:previous:${hotel}:${ym}`;
  const HOURSKEY = (hotel, ym) => `pickup:hours:${hotel}:${ym}`;
  const HKKEY    = (hotel, ym) => `pickup:hk:${hotel}:${ym}`;
  const REVKEY   = (hotel, ym) => `pickup:rev:${hotel}:${ym}`;
  const ALERTKEY = (hotel, ym, dayISO) => `pickup:alert:${hotel}:${ym}:${dayISO}`;
  const LOGO_KEY = `pickup:brand:logo`;
  const UIKEY    = `pickup:ui:last`;
  // NEW: persisted hotel total rooms
  const ROOMSKEY = (hotel) => `pickup:hotel:totalrooms:${hotel}`;

  // ---------- Utils
  const fmtC = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}).format(Number(n)||0);
  const fmtN0 = n => new Intl.NumberFormat('en-US',{maximumFractionDigits:0}).format(Number(n)||0);
  const fmtN2 = n => new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(Number(n)||0);
  const parseMoney = s => parseFloat(String(s).replace(/,/g,'')) || 0;
  const parseADR = s => parseFloat(String(s).replace(/,/g,'')) || 0;

  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function yesterdayISO(){ const d=new Date(); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); }
  function dToKey(d){ return d.toISOString().slice(0,10); }
  function ymFromInput(){ return monthInput.value || '2025-09'; }
  function monthBounds(){
    const [yy,mm] = ymFromInput().split('-').map(n=>parseInt(n,10));
    const start = new Date(Date.UTC(yy, mm-1, 1));
    const end = new Date(Date.UTC(yy, mm, 0));
    return {startKey: dToKey(start), endKey: dToKey(end)};
  }
  function clampToMonth(iso){
    const {startKey,endKey} = monthBounds();
    if(iso < startKey) return startKey;
    if(iso > endKey) return endKey;
    return iso;
  }
  function parseShortDateToken(tok){
    const m = String(tok).match(/^(\d{2})([A-Za-z]{3})(\d{2})$/);
    if(!m) return null;
    const day = parseInt(m[1],10);
    const mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].indexOf(m[2]);
    const year = 2000 + parseInt(m[3],10);
    if(mon<0) return null;
    return new Date(Date.UTC(year, mon, day));
  }
  function ymFromDateUTC(dt){
    const y = dt.getUTCFullYear();
    const m = String(dt.getUTCMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }

  // NEW: month days + hotel rooms persistence
  function daysInActiveMonth(){
    const [yy, mm] = ymFromInput().split('-').map(n=>parseInt(n,10));
    return new Date(yy, mm, 0).getDate();
  }
  function loadHotelRooms(){
    const val = localStorage.getItem(ROOMSKEY(hotelSel.value));
    hotelRooms.value = (val!=null) ? String(val) : '';
  }
  function saveHotelRooms(){
    const n = Math.max(0, parseInt(hotelRooms.value, 10) || 0);
    if(n>0) localStorage.setItem(ROOMSKEY(hotelSel.value), String(n));
    else localStorage.removeItem(ROOMSKEY(hotelSel.value));
  }
  function getHotelRooms(){
    const n = parseInt(hotelRooms.value, 10);
    return (isFinite(n) && n>0) ? n : 0;
  }

  // ---------- Filename tips
  const RX_BS = /^(?:\d{8}|\d{6})_BookingStats(?:\.txt)?$/i;
  const RX_REV = /^(?:\d{8}|\d{6})_RevReport(?:\.txt)?$/i;

  function toast(msg, cls=''){
    const t = document.createElement('div');
    t.className = `toast ${cls}`;
    t.innerHTML = msg;
    toastWrap.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 6500);
  }
  function softNameCheck(file, type){
    const name = (file?.name || '').trim();
    if(!name) return;
    if(type === 'bs' && !RX_BS.test(name)){
      toast(`Tip: Consider naming Booking Stats like <span class="kbd">YYYYMMDD_BookingStats.txt</span> (got <b>${name}</b>).`, 'info');
    }
    if(type === 'rev' && !RX_REV.test(name)){
      toast(`Tip: Consider naming Revenue like <span class="kbd">YYYYMMDD_RevReport.txt</span> (got <b>${name}</b>).`, 'info');
    }
  }

  // ---------- Parsers
  async function readText(file){ return await file.text(); }
  function parseBookingStats(text){
    const hdr = text.match(/Beginning\s+(\d{2}[A-Za-z]{3}\d{2})\s+Through\s+(\d{2}[A-Za-z]{3}\d{2})/);
    let start = null, end = null;
    if(hdr){ start = parseShortDateToken(hdr[1]); end = parseShortDateToken(hdr[2]); }
    const lines = text.split(/\r?\n/);
    const rows = {};
    for(const line of lines){
      const m = line.match(/^\s*(\d{2}[A-Za-z]{3}\d{2})\s+(.*)$/);
      if(!m) continue;
      const dateTok = m[1];
      const rest = m[2].trim().split(/\s+/);
      if(rest.length < 10) continue;
      const sold = parseInt(rest[6],10) || 0;
      const roomRev = parseMoney(rest[8]);
      const adr = parseADR(rest[9]);
      const dt = parseShortDateToken(dateTok);
      if(!dt) continue;
      rows[dToKey(dt)] = { rooms: sold, adr: adr, rev: roomRev };
    }
    return { start, end, rows };
  }
  function parseRevenueReport(text){
    const dateMatch = text.match(/^\s*(\d{2}[A-Za-z]{3}\d{2})\s+Run on/m);
    if(!dateMatch) return null;
    const dt = parseShortDateToken(dateMatch[1]);
    const roomSalesMatch = text.match(/TOTAL\s+ROOM\s+SALES\s+([0-9,]+\.\d{2})/i);
    const occMatch = text.match(/#\s*ROOMS\s*OCCUPIED\s+(\d+)/i);
    const adrMatch = text.match(/AVG\s+RATE\s+PER\s+ROOM\s+([0-9]+\.\d{2})/i);
    if(!roomSalesMatch || !occMatch || !adrMatch) return null;
    return { date: dToKey(dt), rooms: parseInt(occMatch[1],10) || 0, adr: parseADR(adrMatch[1]), rev: parseMoney(roomSalesMatch[1]) };
  }

  // ---------- Range helpers
  function ensureRangeDefaults(){
    const {startKey,endKey} = monthBounds();
    if(!rangeStart.value) rangeStart.value = startKey;
    if(!rangeEnd.value) rangeEnd.value = endKey;
    rangeStart.min = startKey; rangeStart.max = endKey;
    rangeEnd.min = startKey; rangeEnd.max = endKey;
    rangeStart.disabled = rangeMode.value !== 'custom';
    rangeEnd.disabled = rangeMode.value !== 'custom';
  }
  function getActiveRange(){
    const {startKey:ms, endKey:me} = monthBounds();
    if(rangeMode.value === 'custom'){
      let s = clampToMonth(rangeStart.value || ms);
      let e = clampToMonth(rangeEnd.value || me);
      if(s>e){ const t=s; s=e; e=t; }
      return {start:s, end:e};
    }
    return {start:ms, end:me};
  }
  function inRange(dateKey){
    const r = getActiveRange();
    return (!r.start || dateKey>=r.start) && (!r.end || dateKey<=r.end);
  }

  // ---------- Persistence: Labor, HK, Revenue, Logo
  function loadLaborMap(){ laborMap = JSON.parse(localStorage.getItem(HOURSKEY(hotelSel.value, ymFromInput())) || '{}'); }
  function saveLaborMap(){ localStorage.setItem(HOURSKEY(hotelSel.value, ymFromInput()), JSON.stringify(laborMap)); }
  function getHours(dateKey){
    const rec = laborMap[dateKey] || {};
    return { sal: Number(rec.sal||0) || 0, str: Number(rec.str||0) || 0 };
  }
  function setHours(dateKey, sal, str){
    laborMap[dateKey] = { sal: Math.max(0, Number(sal)||0), str: Math.max(0, Number(str)||0) };
    saveLaborMap();
  }

  function loadHKMap(){ hkMap = JSON.parse(localStorage.getItem(HKKEY(hotelSel.value, ymFromInput())) || '{}'); }
  function saveHKMap(){ localStorage.setItem(HKKEY(hotelSel.value, ymFromInput()), JSON.stringify(hkMap)); }
  function getHK(dateKey){
    const rec = hkMap[dateKey] || {};
    return { hkHrs: Number(rec.hkHrs||0) || 0, co: Number(rec.co||0) || 0, so: Number(rec.so||0) || 0, dnd: Number(rec.dnd||0) || 0 };
  }
  function setHK(dateKey, hkHrs, co, so, dnd){
    hkMap[dateKey] = { hkHrs: Math.max(0, Number(hkHrs)||0), co: Math.max(0, Number(co)||0), so: Math.max(0, Number(so)||0), dnd: Math.max(0, Number(dnd)||0) };
    saveHKMap();
  }

  function loadRevenueMap(){ revenueByDay = JSON.parse(localStorage.getItem(REVKEY(hotelSel.value, ymFromInput())) || '{}'); }
  function saveRevenueMap(){ localStorage.setItem(REVKEY(hotelSel.value, ymFromInput()), JSON.stringify(revenueByDay)); }

  function loadLogo(){ logoDataUrl = localStorage.getItem(LOGO_KEY) || null; }
  function saveLogo(dataUrl){ localStorage.setItem(LOGO_KEY, dataUrl); logoDataUrl = dataUrl; }

  // ---------- UI State
  function saveUIState(){
    const state = {
      hotel: hotelSel.value,
      month: monthInput.value,
      rangeMode: rangeMode.value,
      rangeStart: rangeStart.value,
      rangeEnd: rangeEnd.value,
      compare: !!compareToggle.checked,
      filter: filterInput.value
    };
    localStorage.setItem(UIKEY, JSON.stringify(state));
  }
  function loadUIState(){
    const saved = JSON.parse(localStorage.getItem(UIKEY) || 'null');
    if(saved){
      if(saved.month) monthInput.value = saved.month;
      if(saved.hotel) hotelSel.value = saved.hotel;
      if(saved.rangeMode) rangeMode.value = saved.rangeMode;
      ensureRangeDefaults();
      if(saved.rangeStart) rangeStart.value = saved.rangeStart;
      if(saved.rangeEnd)   rangeEnd.value   = saved.rangeEnd;
      if(typeof saved.compare === 'boolean') compareToggle.checked = saved.compare;
      if(saved.filter != null) filterInput.value = saved.filter;
    }else{
      const nowYM = new Date().toISOString().slice(0,7);
      monthInput.value = nowYM;
      ensureRangeDefaults();
    }
  }

  // ---------- Baselines / snapshots
  function loadBaselineInfo(){
    if(bookingStatsPrev){ baselineInfo = { snap: bookingStatsPrev, label: 'previous upload' }; return; }
    const ym = ymFromInput();
    const hotel = hotelSel.value;
    const idx = JSON.parse(localStorage.getItem(SNAPINDEX(hotel, ym)) || '[]');
    const yKey = yesterdayISO();
    let snap=null, label=null;

    const ySnap = JSON.parse(localStorage.getItem(SNAPDAY(hotel, ym, yKey)) || 'null');
    if(ySnap){ snap = ySnap; label = `yesterday (${yKey})`; }
    else{
      const today = todayISO();
      const prior = idx.filter(d => d<today).sort();
      if(prior.length){
        const d = prior[prior.length-1];
        snap = JSON.parse(localStorage.getItem(SNAPDAY(hotel, ym, d)) || 'null');
        if(snap) label = `prior upload (${d})`;
      }
    }
    if(!snap){
      const compat = JSON.parse(localStorage.getItem(SNAPKEY(hotel, ym)) || 'null');
      if(compat){ snap = compat; label = 'last upload'; }
    }
    baselineInfo = { snap, label };
  }
  function saveSnapshotWithHistory(bs){
    const ym = ymFromInput();
    const hotel = hotelSel.value;
    const day = todayISO();
    const idx = JSON.parse(localStorage.getItem(SNAPINDEX(hotel, ym)) || '[]');
    if(!idx.includes(day)){
      idx.push(day);
      idx.sort();
      localStorage.setItem(SNAPINDEX(hotel, ym), JSON.stringify(idx));
    }
    localStorage.setItem(SNAPKEY(hotel, ym), JSON.stringify(bs)); // compat
    localStorage.setItem(SNAPDAY(hotel, ym, day), JSON.stringify(bs));
  }
  function loadExplicitSnapshots(){
    const ym = ymFromInput();
    const hotel = hotelSel.value;
    bookingStatsCur = JSON.parse(localStorage.getItem(BS_CUR(hotel, ym)) || 'null');
    bookingStatsPrev = JSON.parse(localStorage.getItem(BS_PREV(hotel, ym)) || 'null');
  }
  function getFirstMonthSnapshot(){
    const ym = ymFromInput();
    const hotel = hotelSel.value;
    const idx = JSON.parse(localStorage.getItem(SNAPINDEX(hotel, ym)) || '[]');
    if(idx && idx.length){
      const first = [...idx].sort()[0];
      const snap = JSON.parse(localStorage.getItem(SNAPDAY(hotel, ym, first)) || 'null');
      return { snap, date:first };
    }
    return { snap:null, date:null };
  }

  // ---------- Merge + KPIs
  function mergeData(){
    merged = [];
    const ymParts = ymFromInput().split('-').map(n=>parseInt(n,10));
    const year = ymParts[0], month = (ymParts[1]-1);
    const first = new Date(Date.UTC(year, month, 1));
    const nextM = new Date(Date.UTC(year, month+1, 1));

    for(let d=new Date(first); d<nextM; d.setUTCDate(d.getUTCDate()+1)){
      const key = dToKey(d);
      const act = revenueByDay[key];
      const otb = bookingStatsCur?.rows?.[key];

      if(act){
        merged.push({ date:key, status:'Actual', rooms:act.rooms, adr:act.adr, rev:act.rev });
      }else if(otb){
        const row = { date:key, status:'OTB', rooms:otb.rooms, adr:otb.adr, rev:otb.rev };
        const baselineSnap = bookingStatsPrev || baselineInfo.snap;
        if(baselineSnap && compareToggle.checked){
          const prev = baselineSnap.rows?.[key] || {rooms:0, rev:0};
          row.dRooms = (row.rooms - (prev.rooms||0));
          row.dRev = (row.rev - (prev.rev||0));
        }
        merged.push(row);
      }else{
        merged.push({ date:key, status:'', rooms:null, adr:null, rev:null });
      }
    }
  }
  function visibleRows(){ return merged.filter(r => inRange(r.date)); }

  function updateKPIs(){
    const rows = visibleRows();
    let actRooms=0, actRev=0, otbRev=0, otbRooms=0;

    rows.forEach(r=>{
      if(r.status==='Actual'){ actRooms += (r.rooms||0); actRev += (r.rev||0); }
      if(r.status==='OTB'){ otbRev += (r.rev||0); otbRooms += (r.rooms||0); }
    });

    kRooms.textContent = fmtN0(actRooms);
    kRev.textContent = fmtC(actRev);
    kOTB.textContent = fmtC(otbRev);
    kTotal.textContent = fmtC(actRev + otbRev);
    kOTBRooms.textContent = fmtN0(otbRooms);
    const totalMonthRooms = actRooms + otbRooms;
    kTotalRooms.textContent = fmtN0(totalMonthRooms);

    // Month ADR across full month (Actual+OTB where both exist)
    let mRooms=0, mRev=0;
    merged.forEach(r=>{ if(r.rooms!=null && r.rev!=null){ mRooms += r.rooms; mRev += r.rev; } });
    kMonthADR.textContent = (mRooms>0) ? fmtN2(mRev/mRooms) : '‚Äî';

    // NEW: Occupancy % for the month vs (hotel rooms * days in month)
    const roomsPhys = getHotelRooms();
    const dim = daysInActiveMonth();
    if(roomsPhys > 0 && dim > 0 && totalMonthRooms > 0){
      const occ = (totalMonthRooms / (roomsPhys * dim)) * 100;
      kOccPct.textContent = `${fmtN2(occ)}% OCC (vs ${fmtN0(roomsPhys)} rooms √ó ${dim} days)`;
    }else{
      kOccPct.textContent = '‚Äî';
    }

    // Labor/HPOR for range
    let sal=0, str=0, totH=0, roomsForHPOR=0;
    rows.forEach(r=>{
      const h = getHours(r.date);
      const rm = r.rooms || 0;
      sal += h.sal; str += h.str; totH += (h.sal + h.str);
      if(rm>0 && (h.sal+h.str)>0){ roomsForHPOR += rm; }
    });
    kHoursSal.textContent = fmtN2(sal);
    kHoursStr.textContent = fmtN2(str);
    kHoursRange.textContent = fmtN2(totH);
    const hpor = (roomsForHPOR>0) ? (totH/roomsForHPOR) : null;
    kHPORRange.textContent = (hpor!=null) ? fmtN2(hpor) : '‚Äî';

    // Pickup vs baseline across range (OTB days)
    let pRooms=0, pRev=0;
    const baselineSnap = bookingStatsPrev || baselineInfo.snap;
    if(baselineSnap && compareToggle.checked){
      rows.forEach(r=>{
        if(r.status==='OTB'){
          const prev = baselineSnap.rows?.[r.date] || {rooms:0, rev:0};
          pRooms += ((r.rooms||0) - (prev.rooms||0));
          pRev += ((r.rev||0) - (prev.rev||0));
        }
      });
      kPickupRooms.textContent = (pRooms>=0?'+':'') + fmtN0(pRooms);
      kPickupRev.textContent = (pRev>=0?'+':'') + fmtC(pRev);
      kPickupLabel.textContent = `baseline: ${bookingStatsPrev ? 'previous upload' : (baselineInfo.label || '‚Äî')}`;
    }else{
      kPickupRooms.textContent = '‚Äî';
      kPickupRev.textContent = '‚Äî';
      kPickupLabel.textContent = 'baseline: ‚Äî';
    }

    // MPOR (range)
    let hkMinutes = 0, cleanedRooms = 0;
    rows.forEach(r=>{
      const hk = getHK(r.date);
      hkMinutes += (hk.hkHrs || 0) * 60;
      const cleaned = Math.max(0, (hk.co||0) + (hk.so||0) - (hk.dnd||0));
      cleanedRooms += cleaned;
    });
    if(cleanedRooms > 0 && hkMinutes > 0){
      const mpor = hkMinutes / cleanedRooms;
      const variance = mpor - MPOR_STD;
      kMPOR.textContent = `${fmtN2(mpor)} min`;
      const cls = variance<=0 ? 'delta pos' : 'delta neg';
      const sign = variance>=0 ? '+' : '';
      kMPORVar.innerHTML = `<span class="${cls}">${sign}${fmtN2(variance)}</span> vs 25m`;
    }else{
      kMPOR.textContent = '‚Äî';
      kMPORVar.textContent = '‚Äî';
    }

    // Total Month Pickup (vs first upload for the month)
    const { snap:firstSnap, date:firstDate } = getFirstMonthSnapshot();
    if(firstSnap){
      let baseTotal = 0;
      Object.values(firstSnap.rows || {}).forEach(v => { baseTotal += (v?.rev||0); });
      let currentTotal = 0;
      merged.forEach(r=>{ if(r.rev!=null){ currentTotal += r.rev; } });
      const monthPickupVal = currentTotal - baseTotal;
      kMonthPickup.textContent = (monthPickupVal>=0?'+':'') + fmtC(monthPickupVal);
      kMonthPickupNote.textContent = `vs first upload (${firstDate})`;
    }else{
      kMonthPickup.textContent = '‚Äî';
      kMonthPickupNote.textContent = 'Upload Booking Stats to start baseline';
    }
  }

  // ---------- Row expanders (HK inputs)
  function makeExpander(dateKey){
    const btn = document.createElement('button');
    btn.className = 'expander';
    btn.setAttribute('aria-expanded','false');
    btn.innerHTML = `<span class="chev" aria-hidden="true"></span>`;
    btn.addEventListener('click', () => toggleExpand(dateKey, btn));
    return btn;
  }
  function toggleExpand(dateKey, btn){
    const rowId = `exp-${dateKey}`;
    const existing = document.getElementById(rowId);
    if(existing){ existing.remove(); btn.setAttribute('aria-expanded','false'); return; }

    const tr = document.createElement('tr');
    tr.id = rowId;
    tr.className = 'expand-row';
    const colSpan = 11;
    const hk = getHK(dateKey);
    const cleanedInit = Math.max(0, (hk.co||0)+(hk.so||0)-(hk.dnd||0));
    const dayMPOR = (hk.hkHrs>0 && cleanedInit>0) ? ((hk.hkHrs*60)/cleanedInit) : null;

    tr.innerHTML = `
      <td colspan="${colSpan}">
        <div class="expand-panel">
          <div class="group">
            <div class="mini">
              <label>Housekeeper Hours</label>
              <input type="number" step="0.1" min="0" id="hk-hrs-${dateKey}" value="${hk.hkHrs || ''}" placeholder="hrs"/>
            </div>
            <div class="mini">
              <label>Checked-Out Rooms</label>
              <input type="number" step="1" min="0" id="hk-co-${dateKey}" value="${hk.co || ''}" placeholder="count"/>
            </div>
            <div class="mini">
              <label>Stayover Rooms</label>
              <input type="number" step="1" min="0" id="hk-so-${dateKey}" value="${hk.so || ''}" placeholder="count"/>
            </div>
            <div class="mini">
              <label>DNDs</label>
              <input type="number" step="1" min="0" id="hk-dnd-${dateKey}" value="${hk.dnd || ''}" placeholder="count"/>
            </div>
          </div>
          <div class="group">
            <span class="chip">Day MPOR: <strong id="hk-mpor-${dateKey}">${dayMPOR==null?'‚Äî':fmtN2(dayMPOR)+' min'}</strong></span>
            <span class="chip" id="hk-var-${dateKey}">${dayMPOR==null?'‚Äî':( (dayMPOR-MPOR_STD)>=0?`<span class="delta neg">+${fmtN2(dayMPOR-MPOR_STD)}</span>`:`<span class="delta pos">${fmtN2(dayMPOR-MPOR_STD)}</span>` )} vs 25m</span>
          </div>
        </div>
      </td>
    `;
    const mainRow = document.getElementById(`row-${dateKey}`);
    if(mainRow && mainRow.nextSibling){
      mainRow.parentNode.insertBefore(tr, mainRow.nextSibling);
    }else{
      gridBody.appendChild(tr);
    }
    btn.setAttribute('aria-expanded','true');

    const elHrs = document.getElementById(`hk-hrs-${dateKey}`);
    const elCO  = document.getElementById(`hk-co-${dateKey}`);
    const elSO  = document.getElementById(`hk-so-${dateKey}`);
    const elDND = document.getElementById(`hk-dnd-${dateKey}`);

    const recalc = () => {
      const hours = parseFloat(elHrs.value) || 0;
      const co = parseInt(elCO.value,10) || 0;
      const so = parseInt(elSO.value,10) || 0;
      const dnd = parseInt(elDND.value,10) || 0;
      setHK(dateKey, hours, co, so, dnd);

      const cleaned = Math.max(0, co + so - dnd);
      const dayM = (hours>0 && cleaned>0) ? (hours*60/cleaned) : null;
      const mporEl = document.getElementById(`hk-mpor-${dateKey}`);
      const varEl = document.getElementById(`hk-var-${dateKey}`);
      if(dayM==null){
        mporEl.textContent = '‚Äî';
        varEl.textContent = '‚Äî';
      }else{
        mporEl.textContent = `${fmtN2(dayM)} min`;
        const v = dayM - MPOR_STD;
        varEl.innerHTML = `${v>=0?'<span class="delta neg">+':''}${v<0?'<span class="delta pos">':''}${fmtN2(v)}</span> vs 25m`;
      }
      updateKPIs();
    };

    [elHrs, elCO, elSO, elDND].forEach(inp => inp.addEventListener('input', recalc));
  }

  // ---------- Render
  function renderTable(){
    if(!merged.length){
      host.innerHTML = '<div id="hostEmpty">Upload Booking Stats (Current & Previous) and one or more Revenue Reports.</div>';
      grid.style.display='none';
      updateKPIs();
      return;
    }
    const q = (filterInput.value||'').trim().toLowerCase();
    const rows = visibleRows();
    host.innerHTML = '';
    grid.style.display='table';
    gridBody.innerHTML = '';

    const baselineSnap = bookingStatsPrev || baselineInfo.snap;

    rows.forEach(r=>{
      const label = r.date;
      if(q && !label.includes(q)) return;

      let badgeHTML = '', dateThClass = '';
      if(r.status==='OTB' && baselineSnap && bookingStatsCur){
        const now = bookingStatsCur.rows?.[label]?.rooms ?? null;
        const prev = baselineSnap.rows?.[label]?.rooms ?? null;
        if(now!=null && prev!=null){
          const d = now - prev;
          if(d >= DELTA_TH){ badgeHTML = `<span class="flag flag-pos">‚ñ≤ ${fmtN0(d)}</span>`; dateThClass = 'flagged-pos'; }
          else if(d <= -DELTA_TH){ badgeHTML = `<span class="flag flag-neg">‚ñº ${fmtN0(d)}</span>`; dateThClass = 'flagged-neg'; }
        }
      }

      const tr = document.createElement('tr');
      tr.id = `row-${label}`;
      const statusBadge = r.status ? `<span class="status ${r.status==='Actual'?'actual':'otb'}">${r.status}</span>` : '';
      const rooms = r.rooms==null ? '‚Äî' : fmtN0(r.rooms);
      const adr = r.adr==null ? '‚Äî' : fmtN2(r.adr);
      const rev = r.rev==null ? '‚Äî' : fmtC(r.rev);
      const dRooms = (r.dRooms==null) ? '' : `<span class="delta ${r.dRooms>=0?'pos':'neg'}">${r.dRooms>=0?'+':''}${fmtN0(r.dRooms)}</span>`;
          const dRev = (r.dRev==null) ? '' : `<span class="delta ${r.dRev>=0?'pos':'neg'}">${r.dRev>=0?'+':''}${fmtC(r.dRev)}</span>`;

      const hours = getHours(label);
      const totalHours = hours.sal + hours.str;
      const hporVal = (r.rooms && totalHours>0) ? (totalHours/r.rooms) : null;

      const exp = makeExpander(label);
      const dateCell = document.createElement('th');
      dateCell.className = `left ${dateThClass}`;
      dateCell.appendChild(exp);
      dateCell.insertAdjacentHTML('beforeend', `${label}${badgeHTML}`);

      tr.appendChild(dateCell);
      tr.insertAdjacentHTML('beforeend', `
        <td>${statusBadge}</td>
        <td>${rooms}</td>
        <td>${adr}</td>
        <td>${rev}</td>
        <td id="hrs-sal-${label}"></td>
        <td id="hrs-str-${label}"></td>
        <td id="hrs-tot-${label}">${totalHours>0?fmtN2(totalHours):'‚Äî'}</td>
        <td id="hpor-${label}">${hporVal==null?'‚Äî':fmtN2(hporVal)}</td>
        <td class="no-print">${dRooms}</td>
        <td class="no-print">${dRev}</td>
      `);
      gridBody.appendChild(tr);

      const mountInput = (cellId, val, onChange) => {
        const cell = document.getElementById(cellId);
        const inp = document.createElement('input');
        inp.type='number'; inp.min='0'; inp.step='0.1'; inp.className='hours';
        inp.value = (val>0)?String(val):''; inp.placeholder='hrs';
        inp.addEventListener('input', ()=> onChange(parseFloat(inp.value)));
        cell.appendChild(inp);
      };

      mountInput(`hrs-sal-${label}`, hours.sal, (newSal)=>{
        const cur = getHours(label);
        const sal = (isFinite(newSal) && newSal>=0)? newSal : 0;
        setHours(label, sal, cur.str);
        const tot = sal + cur.str;
        document.getElementById(`hrs-tot-${label}`).textContent = tot>0?fmtN2(tot):'‚Äî';
        const rm = r.rooms||0;
        document.getElementById(`hpor-${label}`).textContent = (rm>0 && tot>0)?fmtN2(tot/rm):'‚Äî';
        updateKPIs();
      });

      mountInput(`hrs-str-${label}`, hours.str, (newStr)=>{
        const cur = getHours(label);
        const str = (isFinite(newStr) && newStr>=0)? newStr : 0;
        setHours(label, cur.sal, str);
        const tot = cur.sal + str;
        document.getElementById(`hrs-tot-${label}`).textContent = tot>0?fmtN2(tot):'‚Äî';
        const rm = r.rooms||0;
        document.getElementById(`hpor-${label}`).textContent = (rm>0 && tot>0)?fmtN2(tot/rm):'‚Äî';
        updateKPIs();
      });
    });
  }

  function updateAndRender(){ updateKPIs(); renderTable(); }

  // ---------- Alerts
  function firePickupAlertsIfNeeded(){
    if(!bookingStatsCur) return;
    const baselineSnap = bookingStatsPrev || baselineInfo.snap;
    if(!baselineSnap) return;

    const ym = ymFromInput();
    const hotel = hotelSel.value;
    const day = todayISO();
    const guardKey = ALERTKEY(hotel, ym, day);
    if(sessionStorage.getItem(guardKey)) return;

    const inc = [], dec = [];
    Object.keys(bookingStatsCur.rows || {}).forEach(dateKey=>{
      const now = bookingStatsCur.rows[dateKey]?.rooms ?? null;
      const prev = baselineSnap.rows?.[dateKey]?.rooms ?? null;
      if(now==null || prev==null) return;
      const d = now - prev;
      if(d >= DELTA_TH) inc.push({date:dateKey, d});
      else if(d <= -DELTA_TH) dec.push({date:dateKey, d});
    });

    if(inc.length || dec.length){
      const lines = [];
      if(inc.length){
        lines.push(`Substantial OTB pickup (‚â• ${DELTA_TH} rooms):`);
        inc.sort((a,b)=>b.d-a.d).forEach(x=> lines.push(`‚Ä¢ ${x.date}: +${fmtN0(x.d)} rooms`));
        lines.push('');
      }
      if(dec.length){
        lines.push(`Significant OTB drop (‚â§ -${DELTA_TH} rooms):`);
        dec.sort((a,b)=>a.d-b.d).forEach(x=> lines.push(`‚Ä¢ ${x.date}: ${x.d} rooms`));
        lines.push('');
      }
      lines.push('Action: GM review ‚Äî consider rate increases on pickup; investigate cancels on drops.');
      alert(lines.join('\n'));
      sessionStorage.setItem(guardKey, '1');
    }
  }

  // ---------- PDF summary (with OCC%)
  function computeSummary(){
    const ym = ymFromInput();
    const hotel = hotelSel.value;
    const tz = 'America/New_York';
    const genAt = new Date().toLocaleString('en-US', { timeZone: tz });

    // MTD (Actual only)
    let mtdActRooms=0, mtdActRev=0, mtdSal=0, mtdStr=0, mtdHKHrs=0, mtdCO=0, mtdSO=0, mtdDND=0;
    merged.forEach(r=>{
      if(r.status==='Actual'){
        mtdActRooms += (r.rooms||0);
        mtdActRev   += (r.rev||0);
        const h = getHours(r.date); mtdSal += h.sal; mtdStr += h.str;
        const hk = getHK(r.date); mtdHKHrs += (hk.hkHrs||0); mtdCO += (hk.co||0); mtdSO += (hk.so||0); mtdDND += (hk.dnd||0);
      }
    });
    const mtdHPOR = (mtdActRooms>0 && (mtdSal+mtdStr)>0) ? ((mtdSal+mtdStr)/mtdActRooms) : null;
    const cleaned = Math.max(0, (mtdCO + mtdSO - mtdDND));
    const mtdMPOR = (cleaned>0 && mtdHKHrs>0) ? ((mtdHKHrs*60)/cleaned) : null;
    const mtdMPORVar = (mtdMPOR!=null) ? (mtdMPOR - MPOR_STD) : null;

    // Month totals
    let mRooms=0, mRev=0, otbRooms=0, otbRev=0, monthCurrentTotal=0;
    merged.forEach(r=>{
      if(r.rooms!=null && r.rev!=null){ mRooms += r.rooms; mRev += r.rev; }
      if(r.status==='OTB'){ otbRooms += (r.rooms||0); otbRev += (r.rev||0); }
      if(r.rev!=null){ monthCurrentTotal += r.rev; }
    });
    const monthADR = (mRooms>0)? (mRev/mRooms) : null;

    // Occ %
    const roomsPhys = getHotelRooms ? getHotelRooms() : 0;
    const dim = daysInActiveMonth ? daysInActiveMonth() : 0;
    const occPct = (roomsPhys>0 && dim>0 && mRooms>0) ? ((mRooms / (roomsPhys * dim)) * 100) : null;

    // Pickup vs baseline (all OTB)
    const baselineSnap = bookingStatsPrev || baselineInfo.snap;
    let pRooms=0, pRev=0, inc=[], dec=[];
    if(bookingStatsCur && baselineSnap){
      Object.keys(bookingStatsCur.rows || {}).forEach(dateKey=>{
        const now = bookingStatsCur.rows[dateKey] || {};
        const prev = baselineSnap.rows?.[dateKey] || {};
        const dRooms = (now.rooms||0) - (prev.rooms||0);
        const dRev = (now.rev||0) - (prev.rev||0);
        pRooms += dRooms; pRev += dRev;
        if(dRooms >= DELTA_TH) inc.push({date:dateKey, d:dRooms});
        else if(dRooms <= -DELTA_TH) dec.push({date:dateKey, d:dRooms});
      });
      inc.sort((a,b)=>b.d-a.d);
      dec.sort((a,b)=>a.d-b.d);
    }

    // Month pickup vs first upload
    const { snap:firstSnap, date:firstDate } = getFirstMonthSnapshot();
    let firstSnapTotal = null, monthPickup = null;
    if(firstSnap){
      firstSnapTotal = Object.values(firstSnap.rows||{}).reduce((s,v)=> s + (v?.rev||0), 0);
      monthPickup = monthCurrentTotal - firstSnapTotal;
    }

    return {
      ym, hotel, genAt,
      mtdActRooms, mtdActRev, mtdSal, mtdStr, mtdHPOR,
      mtdHKHrs, mtdCO, mtdSO, mtdDND, mtdMPOR, mtdMPORVar,
      monthADR, otbRooms, otbRev,
      pRooms, pRev, inc, dec,
      baselineLabel: bookingStatsPrev ? 'previous upload' : (baselineInfo.label || '‚Äî'),
      firstSnapDate: firstDate, firstSnapTotal, monthCurrentTotal, monthPickup,
      occPct, roomsPhys, dim
    };
  }

  function buildPDFNode(d){
    const el = document.getElementById('pdfSummary');
    const safe = (v, fmt) => (v==null || Number.isNaN(v)) ? '‚Äî' : (fmt?fmt(v):v);
    const logoTag = logoDataUrl ? `<img src="${logoDataUrl}" alt="Logo" style="height:36px;display:block">` : '';
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
        ${logoTag}
        <div>
          <h1 style="margin:0">Pickup Summary ‚Äî ${d.hotel} ‚Äî ${d.ym}</h1>
          <div class="muted">Generated ${d.genAt} (America/New_York)</div>
        </div>
      </div>

      <h2>Pickup vs Previous Day</h2>
      <div class="grid">
        <div class="k"><div class="label">Rooms Pickup</div><div class="val">${(d.pRooms>=0?'+':'') + fmtN0(d.pRooms||0)}</div></div>
        <div class="k"><div class="label">Revenue Pickup</div><div class="val">${(d.pRev>=0?'+':'') + fmtC(d.pRev||0)}</div></div>
        <div class="k"><div class="label">Baseline</div><div class="val">${d.baselineLabel}</div></div>
      </div>

      <h2>Total Month Pickup</h2>
      <div class="grid">
        <div class="k"><div class="label">First Upload (${d.firstSnapDate || '‚Äî'})</div><div class="val">${safe(d.firstSnapTotal, fmtC)}</div></div>
        <div class="k"><div class="label">Current Month Total</div><div class="val">${safe(d.monthCurrentTotal, fmtC)}</div></div>
        <div class="k"><div class="label">Pickup (Month vs First)</div><div class="val">${d.monthPickup==null?'‚Äî':((d.monthPickup>=0?'+':'')+fmtC(d.monthPickup))}</div></div>
      </div>

      <h2>MTD Productivity</h2>
      <div class="grid">
        <div class="k"><div class="label">MTD HPOR</div><div class="val">${safe(d.mtdHPOR, fmtN2)}</div></div>
        <div class="k"><div class="label">MTD MPOR</div><div class="val">${safe(d.mtdMPOR, x=>fmtN2(x)+' min')}</div></div>
        <div class="k"><div class="label">MPOR Var vs 25m</div><div class="val">${(d.mtdMPORVar==null)?'‚Äî':((d.mtdMPORVar>=0?'+':'')+fmtN2(d.mtdMPORVar)+' min')}</div></div>
      </div>
      <div class="grid" style="margin-top:6px">
        <div class="k"><div class="label">Actual Rooms (MTD)</div><div class="val">${fmtN0(d.mtdActRooms||0)}</div></div>
        <div class="k"><div class="label">Actual Room Rev (MTD)</div><div class="val">${fmtC(d.mtdActRev||0)}</div></div>
        <div class="k"><div class="label">Labor Hours (MTD)</div><div class="val">${fmtN2((d.mtdSal||0)+(d.mtdStr||0))} <span class="muted">(${fmtN2(d.mtdSal||0)} sal / ${fmtN2(d.mtdStr||0)} str)</span></div></div>
        <div class="k"><div class="label">HK & Rooms (MTD)</div><div class="val">${fmtN2(d.mtdHKHrs||0)} hrs ‚Äî ${fmtN0(Math.max(0,(d.mtdCO||0)+(d.mtdSO||0)-(d.mtdDND||0)))} cleaned <span class="muted">(CO ${fmtN0(d.mtdCO||0)} / SO ${fmtN0(d.mtdSO||0)} / DND ${fmtN0(d.mtdDND||0)})</span></div></div>
      </div>

      <h2>Additional KPIs</h2>
      <div class="grid">
        <div class="k"><div class="label">Month ADR (Actual + OTB)</div><div class="val">${safe(d.monthADR, fmtN2)}</div></div>
        <div class="k">
          <div class="label">Occupancy (Actual + OTB)</div>
          <div class="val">${(d.occPct==null)?'‚Äî':(fmtN2(d.occPct)+'%')}
            <span class="muted" style="display:block;margin-top:2px">vs ${fmtN0(d.roomsPhys||0)} rooms √ó ${d.dim||0} days</span>
          </div>
        </div>
        <div class="k"><div class="label">Remaining OTB Rooms (Month)</div><div class="val">${fmtN0(d.otbRooms||0)}</div></div>
        <div class="k"><div class="label">Remaining OTB Rev (Month)</div><div class="val">${fmtC(d.otbRev||0)}</div></div>
      </div>

      <div style="margin-top:16px;padding-top:10px;border-top:1px solid #e7edf6;display:flex;justify-content:space-between;align-items:center">
        <div>Prepared by: ________________________________</div>
        <div>Date: ____________</div>
      </div>

      <div class="muted" style="margin-top:10px">
        Notes: HPOR = (Salaried + Straight Hours) √∑ Actual Rooms. MPOR = (HK Hours √ó 60) √∑ (CO + SO ‚àí DND). Standard MPOR = 25 minutes.
      </div>
    `;
    return el;
  }

  // UPDATED: robust PDF export (clone off-screen, visible to renderer)
async function downloadPDF(){
  const data = computeSummary();
  const src = buildPDFNode(data);

  // Make a clone that is off-screen but fully visible to the renderer
  const tmp = src.cloneNode(true);
  tmp.id = 'pdfSummaryClone';
  Object.assign(tmp.style, {
    position: 'fixed',
    left: '-10000px',   // keep off-screen (not visible to users)
    top: '0',
    width: '800px',
    // IMPORTANT: visible for capture
    opacity: '1',
    visibility: 'visible',
    pointerEvents: 'none',
    zIndex: '0',
    background: '#ffffff'
  });
  document.body.appendChild(tmp);

  // Give layout a moment to settle & ensure fonts are ready
  try {
    await new Promise(r => requestAnimationFrame(r));
    if (document.fonts && document.fonts.ready) {
      await document.fonts.ready;
    }
    await new Promise(r => setTimeout(r, 60));
  } catch {}

  const { jsPDF } = (window.jspdf || {});
  if (!jsPDF || !window.html2canvas) {
    alert('PDF libraries are not loaded yet. Please try again in a moment.');
    tmp.remove();
    return;
  }

  const fname = `Pickup_Summary_${data.hotel}_${data.ym}.pdf`;

  try {
    // Try vector/HTML path first
    const pdf = new jsPDF({ unit:'pt', format:'letter', compress:true });
    await pdf.html(tmp, {
      x: 36, y: 36, width: 540,
      windowWidth: 1080,
      autoPaging: 'text',
      html2canvas: {
        scale: 2,
        useCORS: true,
        allowTaint: false,
        backgroundColor: '#ffffff',
        logging: false
      }
    });
    pdf.save(fname);
  } catch (err) {
    console.warn('jsPDF.html failed, falling back to image mode:', err);
    try {
      // Fallback: rasterize with html2canvas and paginate
      const canvas = await window.html2canvas(tmp, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false
      });

      const pdf = new jsPDF({ unit:'pt', format:'letter', compress:true });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 36;
      const drawW = pageW - margin*2;
      const scale = drawW / canvas.width;
      const drawHpx = Math.floor((pageH - margin*2) / scale);

      let ySlice = 0;
      while (ySlice < canvas.height) {
        if (ySlice > 0) pdf.addPage();
        const slice = document.createElement('canvas');
        slice.width = canvas.width;
        slice.height = Math.min(drawHpx, canvas.height - ySlice);
        const ctx = slice.getContext('2d');
        ctx.drawImage(canvas, 0, ySlice, canvas.width, slice.height, 0, 0, canvas.width, slice.height);
        const img = slice.toDataURL('image/png');
        pdf.addImage(img, 'PNG', margin, margin, drawW, slice.height * scale, '', 'FAST');
        ySlice += slice.height;
      }

      pdf.save(fname);
    } catch (e2) {
      console.error('html2canvas fallback also failed:', e2);
      alert('Failed to render PDF. Check console for details.');
    }
  } finally {
    tmp.remove();
  }
}

  // ---------- SHARE / EXPORT / IMPORT
  function collectBundle(){
    const hotel = hotelSel.value;
    const ym = ymFromInput();

    const bsCur = localStorage.getItem(BS_CUR(hotel, ym)) || null;
    const bsPrev = localStorage.getItem(BS_PREV(hotel, ym)) || null;
    const rev = localStorage.getItem(REVKEY(hotel, ym)) || null;
    const hours = localStorage.getItem(HOURSKEY(hotel, ym)) || null;
    const hk = localStorage.getItem(HKKEY(hotel, ym)) || null;
    const snapIndex = JSON.parse(localStorage.getItem(SNAPINDEX(hotel, ym)) || '[]');
    const snapDays = {};
    snapIndex.forEach(d=>{
      const k = SNAPDAY(hotel, ym, d);
      const v = localStorage.getItem(k);
      if(v) snapDays[d] = v;
    });
    const ui = localStorage.getItem(UIKEY) || null;
    const logo = localStorage.getItem(LOGO_KEY) || null;
    const rooms = localStorage.getItem(ROOMSKEY(hotel)) || null;

    return {
      version: 2,
      hotel, ym,
      bsCur, bsPrev, rev, hours, hk,
      snapIndex, snapDays,
      ui, logo, rooms
    };
  }
  function writeBundle(bundle){
    if(!bundle || (bundle.version!==1 && bundle.version!==2)) throw new Error('Invalid or unsupported snapshot.');
    const {hotel, ym} = bundle;

    if(bundle.bsCur) localStorage.setItem(BS_CUR(hotel, ym), bundle.bsCur); else localStorage.removeItem(BS_CUR(hotel, ym));
    if(bundle.bsPrev) localStorage.setItem(BS_PREV(hotel, ym), bundle.bsPrev); else localStorage.removeItem(BS_PREV(hotel, ym));
    if(bundle.rev) localStorage.setItem(REVKEY(hotel, ym), bundle.rev); else localStorage.removeItem(REVKEY(hotel, ym));
    if(bundle.hours) localStorage.setItem(HOURSKEY(hotel, ym), bundle.hours); else localStorage.removeItem(HOURSKEY(hotel, ym));
    if(bundle.hk) localStorage.setItem(HKKEY(hotel, ym), bundle.hk); else localStorage.removeItem(HKKEY(hotel, ym));

    if(Array.isArray(bundle.snapIndex)){
      localStorage.setItem(SNAPINDEX(hotel, ym), JSON.stringify(bundle.snapIndex));
      bundle.snapIndex.forEach(d=>{
        const k = SNAPDAY(hotel, ym, d);
        const v = bundle.snapDays?.[d] || null;
        if(v) localStorage.setItem(k, v);
      });
    }

    if(bundle.ui) localStorage.setItem(UIKEY, bundle.ui);
    if(bundle.logo) localStorage.setItem(LOGO_KEY, bundle.logo);
    if(bundle.rooms) localStorage.setItem(ROOMSKEY(hotel), bundle.rooms);

    // compat baseline key
    const compat = bundle.bsCur ? JSON.parse(bundle.bsCur) : null;
    if(compat) localStorage.setItem(SNAPKEY(hotel, ym), JSON.stringify(compat));

    // Switch UI
    hotelSel.value = hotel;
    monthInput.value = ym;
    ensureRangeDefaults();
  }
  function shareLinkFromBundle(b){
    const raw = JSON.stringify(b);
    const enc = (window.LZString && LZString.compressToEncodedURIComponent) ? LZString.compressToEncodedURIComponent(raw) : encodeURIComponent(raw);
    return `${location.origin}${location.pathname}#data=${enc}`;
  }
  function tryLoadBundleFromHash(){
    if(!location.hash || !location.hash.startsWith('#data=')) return false;
    const enc = location.hash.slice(6);
    try{
      const raw = (window.LZString && LZString.decompressFromEncodedURIComponent) ? LZString.decompressFromEncodedURIComponent(enc) : decodeURIComponent(enc);
      const bundle = JSON.parse(raw);
      writeBundle(bundle);

      // Reload in-memory state & render
      loadUIState();
      ensureRangeDefaults();
      loadLogo();
      loadHotelRooms();
      loadLaborMap();
      loadHKMap();
      loadRevenueMap();
      loadExplicitSnapshots();
      loadBaselineInfo();
      mergeData(); updateAndRender();

      history.replaceState(null,'',location.pathname);
      toast('Imported snapshot from link. Your local storage has been updated.', 'ok');
      return true;
    }catch(e){
      console.error(e);
      alert('Could not load snapshot from the link.');
      return false;
    }
  }

  // Buttons
  btnShare.addEventListener('click', ()=>{
    try{
      const b = collectBundle();
      const url = shareLinkFromBundle(b);
      if(navigator.clipboard?.writeText){
        navigator.clipboard.writeText(url).then(()=>{
          toast('Share link copied to clipboard. Send it to your teammate!', 'ok');
        }, ()=>{
          prompt('Copy this link:', url);
        });
      }else{
        prompt('Copy this link:', url);
      }
    }catch(e){
      console.error(e);
      alert('Could not create share link.');
    }
  });

  btnExport.addEventListener('click', ()=>{
    try{
      const b = collectBundle();
      const blob = new Blob([JSON.stringify(b)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `pickup_snapshot_${b.hotel}_${b.ym}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      toast('Snapshot exported.', 'ok');
    }catch(e){
      console.error(e);
      alert('Could not export snapshot.');
    }
  });

  importInput.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    try{
      const text = await f.text();
      const b = JSON.parse(text);
      writeBundle(b);
      // reload state after import
      loadUIState();
      ensureRangeDefaults();
      loadLogo();
      loadHotelRooms();
      loadLaborMap();
      loadHKMap();
      loadRevenueMap();
      loadExplicitSnapshots();
      loadBaselineInfo();
      mergeData(); updateAndRender();
      toast('Snapshot imported.', 'ok');
    }catch(err){
      console.error(err);
      alert('Invalid snapshot file.');
    }finally{
      e.target.value = '';
    }
  });

  // ---------- IO wiring (and UI persistence hooks)
  filterInput.addEventListener('input', ()=>{ updateAndRender(); saveUIState(); });

  compareToggle.addEventListener('change', ()=>{ mergeData(); updateAndRender(); saveUIState(); });

  monthInput.addEventListener('change', ()=>{
    ensureRangeDefaults();
    loadHotelRooms();
    loadLaborMap(); loadHKMap(); loadRevenueMap();
    loadExplicitSnapshots(); loadBaselineInfo();
    mergeData(); updateAndRender();
    saveUIState();
  });

  hotelSel.addEventListener('change', ()=>{
    loadHotelRooms();
    loadLaborMap(); loadHKMap(); loadRevenueMap();
    loadExplicitSnapshots(); loadBaselineInfo();
    mergeData(); updateAndRender();
    saveUIState();
  });

  rangeMode.addEventListener('change', ()=>{ ensureRangeDefaults(); updateAndRender(); saveUIState(); });
  rangeStart.addEventListener('change', ()=>{ rangeStart.value = clampToMonth(rangeStart.value); updateAndRender(); saveUIState(); });
  rangeEnd.addEventListener('change', ()=>{ rangeEnd.value = clampToMonth(rangeEnd.value); updateAndRender(); saveUIState(); });

  // NEW: total rooms input wiring
  hotelRooms.addEventListener('input', ()=>{ saveHotelRooms(); updateKPIs(); });

  // Help modal
  function openHelp(){ helpModal.classList.add('show'); helpBackdrop.classList.add('show'); }
  function closeHelp(){ helpModal.classList.remove('show'); helpBackdrop.classList.remove('show'); }
  btnHelp.addEventListener('click', openHelp);
  helpClose.addEventListener('click', closeHelp);
  helpBackdrop.addEventListener('click', closeHelp);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeHelp(); });

  // Logo upload
  logoInput.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => { saveLogo(reader.result); toast('Logo saved for PDF.', 'ok'); };
    reader.onerror = () => alert('Could not read logo file.');
    reader.readAsDataURL(f);
  });

  // Current Day Booking Stats
  bsInputCur.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    softNameCheck(f, 'bs');
    try{
      const text = await readText(f);
      const parsed = parseBookingStats(text);
      if(parsed?.start){
        const ymFile = ymFromDateUTC(parsed.start);
        if(ymFile !== ymFromInput()){
          monthInput.value = ymFile; ensureRangeDefaults(); loadRevenueMap(); loadHotelRooms(); saveUIState();
        }
      }
      loadLaborMap(); loadHKMap();
      bookingStatsCur = parsed;
      localStorage.setItem(BS_CUR(hotelSel.value, ymFromInput()), JSON.stringify(bookingStatsCur));
      saveSnapshotWithHistory(bookingStatsCur);
      loadExplicitSnapshots(); loadBaselineInfo();
      mergeData(); updateAndRender(); firePickupAlertsIfNeeded();
    }catch(err){
      console.error(err);
      alert('Could not parse Booking Stats (Current). Ensure it is a FOSSE Booking Stats .txt export.');
    }
  });

  // Previous Day Booking Stats (baseline)
  bsInputPrev.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    softNameCheck(f, 'bs');
    try{
      const text = await readText(f);
      const parsed = parseBookingStats(text);
      if(parsed?.start){
        const ymFile = ymFromDateUTC(parsed.start);
        if(ymFile !== ymFromInput()){ monthInput.value = ymFile; ensureRangeDefaults(); loadRevenueMap(); loadHotelRooms(); }
      }
      bookingStatsPrev = parsed;
      localStorage.setItem(BS_PREV(hotelSel.value, ymFromInput()), JSON.stringify(bookingStatsPrev));
      compareToggle.checked = true;
      saveUIState();
      loadBaselineInfo(); mergeData(); updateAndRender();
    }catch(err){
      console.error(err);
      alert('Could not parse Booking Stats (Previous). Ensure it is a FOSSE Booking Stats .txt export.');
    }
  });

  // Revenue uploads (persist locally)
  revInput.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files || []);
    if(!files.length) return;
    files.forEach(f => softNameCheck(f, 'rev'));
    try{
      for(const f of files){
        const text = await readText(f);
        const rec = parseRevenueReport(text);
        if(rec){ revenueByDay[rec.date] = rec; }
      }
      saveRevenueMap();
      mergeData(); updateAndRender();
    }catch(err){
      console.error(err);
      alert('Could not parse one or more Revenue Reports. Ensure each file is a FOSSE daily revenue .txt export with TOTAL ROOM SALES, # ROOMS OCCUPIED, and AVG RATE PER ROOM.');
    }
  });

  // CSV Export
  btnDownload.addEventListener('click', ()=>{
    const rows = visibleRows();
    if(!rows.length){ alert('Nothing to export yet.'); return; }

    const out = [['Date','Status','Rooms','ADR','RoomRev','SalHours','StraightHours','TotalHours','HPOR','DeltaRooms','DeltaRev','HKHours','CO_Rooms','SO_Rooms','DNDs','MPOR(min)']];
    rows.forEach(r=>{
      const hrs = getHours(r.date);
      const tot = hrs.sal + hrs.str;
      const hpor = (r.rooms && tot>0) ? (tot/r.rooms) : '';
      const hk = getHK(r.date);
      const cleaned = Math.max(0, (hk.co||0)+(hk.so||0)-(hk.dnd||0));
      const mpor = (hk.hkHrs>0 && cleaned>0) ? ((hk.hkHrs*60)/cleaned) : '';
      out.push([
        r.date,
        r.status||'',
        r.rooms==null?'':r.rooms,
        r.adr==null?'':Number(r.adr).toFixed(2),
        r.rev==null?'':Number(r.rev).toFixed(2),
        hrs.sal?hrs.sal.toFixed(2):'',
        hrs.str?hrs.str.toFixed(2):'',
        tot?tot.toFixed(2):'',
        hpor===''?'':(typeof hpor==='number'? hpor.toFixed(2): hpor),
        (r.dRooms==null)?'':r.dRooms,
        (r.dRev==null)?'':Number(r.dRev).toFixed(2),
        hk.hkHrs?hk.hkHrs.toFixed(2):'',
        hk.co||'',
        hk.so||'',
        hk.dnd||'',
        mpor===''?'':(typeof mpor==='number'?mpor.toFixed(2):mpor)
      ]);
    });

    const csv = out.map(r => r.map(x=>{
      const s = String(x);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');

    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pickup_${ymFromInput()}_${(rangeMode.value==='custom'?(rangeStart.value+'_'+rangeEnd.value):'month')}.csv`;
    document.body.appendChild(a);
    a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // PDF Export
  btnPDF.addEventListener('click', downloadPDF);

  // ---------- Initialize
  window.addEventListener('load', ()=>{
    const imported = tryLoadBundleFromHash();
    if(imported) return; // state already loaded & rendered
    loadUIState();
    ensureRangeDefaults();
    loadLogo();
    loadHotelRooms();
    loadLaborMap();
    loadHKMap();
    loadRevenueMap();
    loadExplicitSnapshots();
    loadBaselineInfo();
    updateAndRender();
  });
})();
</script>

